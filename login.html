<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <link rel="icon" type="image/x-icon" href="favicon.ico" />
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Iniciar Sesi칩n | Latam5S</title>
    <meta name="description" content="Accede a tu panel de control de Latam5S. Gestiona tus env칤os y configuraciones.">
    
    <meta property="og:title" content="Iniciar Sesi칩n | Latam5S">
    <meta property="og:description" content="Ingresa a tu cuenta y gestiona tu log칤stica.">
    <meta property="og:image" content="https://latam5s.com/favicon.ico"> <meta property="og:url" content="https://latam5s.com/login.html">
    <meta property="og:type" content="website">
    
    <link rel="canonical" href="https://www.latam5s.com/login" />
    
    <!-- Fuente Quicksand -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',     /* Azul el칠ctrico */
                        primary_glow: '#60A5FA',
                        secondary: '#10B981',   /* Verde 칠xito */
                        dark_bg: '#020617',     /* Negro profundo Slate-950 */
                        card_bg: '#0f172a',     /* Slate-900 */
                        glass: 'rgba(255, 255, 255, 0.03)',
                        glass_border: 'rgba(255, 255, 255, 0.08)',
                    },
                    fontFamily: {
                        sans: ['Quicksand', 'sans-serif'],
                    },
                    boxShadow: {
                        'neon': '0 0 20px rgba(59, 130, 246, 0.15)',
                        'neon-green': '0 0 20px rgba(16, 185, 129, 0.15)',
                    },
                    animation: {
                        'float': 'float 6s ease-in-out infinite',
                        'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-20px)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body { 
            font-family: "Quicksand", sans-serif; 
            background-color: #020617;
            color: #e2e8f0; /* Slate-200 */
        }
        
        /* Glassmorphism Utilities - UNIFICADO Y CONSISTENTE */
        .glass-panel {
            background: rgba(15, 23, 42, 0.7); /* Base oscura s칩lida */
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-right: 1px solid rgba(255, 255, 255, 0.08);
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        }

        /* Glassmorphism Utilities - AHORA S칍LIDO (OPACO) */
        .glass-card {
            /* CAMBIO: Usamos colores HEX s칩lidos (#1e293b y #0f172a) en lugar de RGBA con transparencia */
            background: linear-gradient(145deg, #1e293b 0%, #0f172a 100%);
            
            /* El backdrop-filter ya no es necesario si el fondo es opaco, pero no da침a dejarlo */
            /* backdrop-filter: blur(16px); */
            
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        /* Scrollbar Personalizada Dark */
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 2px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Modals & Sheets */
        .modal-enter { opacity: 0; transform: scale(0.95); }
        .modal-enter-active { opacity: 1; transform: scale(1); transition: opacity 0.2s, transform 0.2s; }

        /* Animations */
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        .slide-up { animation: slideUp 0.4s ease-out forwards; opacity: 0; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        @media print {
            body { background-color: white; color: black; }
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 0; background-color: white; display: block !important; z-index: 9999; }
            .no-print { display: none !important; }
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
        }

        /* Canvas Background */
        #particles-js {
            position: fixed;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            z-index: 0; /* Detr치s de todo */
            pointer-events: none; /* Click-through */
        }
    </style>
</head>
<body class="bg-dark_bg text-slate-200 h-[100dvh] overflow-hidden flex flex-col selection:bg-primary selection:text-white relative">

    <!-- CANVAS DE FONDO (PART칈CULAS) -->
    <canvas id="particles-js"></canvas>

    <!-- OVERLAY CARGA -->
    <div id="loading-overlay" class="fixed inset-0 bg-dark_bg/95 z-[9999] flex flex-col items-center justify-center transition-opacity duration-300 hidden pointer-events-none opacity-0 backdrop-blur-sm">
        <div class="relative">
            <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-primary shadow-neon"></div>
            <div class="absolute top-0 left-0 h-16 w-16 rounded-full border-t-2 border-b-2 border-primary opacity-50 animate-pulse"></div>
        </div>
        <p id="loading-text" class="text-primary font-bold mt-6 animate-pulse tracking-widest text-xs uppercase">Conectando...</p>
    </div>

    <!-- MODAL CONFIRMACI칍N GEN칄RICO (Glass Unificado) -->
    <div id="modal-confirm" class="fixed inset-0 z-[100] bg-black/80 backdrop-blur-md hidden flex items-center justify-center transition-opacity duration-200 opacity-0">
        <div id="modal-card" class="glass-card rounded-3xl p-8 max-w-sm w-full mx-4 transform scale-95 transition-transform duration-200">
            <div class="w-14 h-14 bg-primary/20 rounded-full flex items-center justify-center mb-6 text-primary mx-auto shadow-neon border border-primary/20">
                <i data-lucide="alert-circle" class="w-7 h-7"></i>
            </div>
            <h3 class="text-xl font-bold text-white mb-3 text-center">Confirmaci칩n</h3>
            <p id="modal-msg" class="text-slate-400 text-sm mb-8 leading-relaxed text-center">...</p>
            <div class="flex gap-3">
                <button onclick="app.closeModal('modal-confirm')" class="flex-1 py-3 rounded-xl font-bold text-slate-400 hover:text-white hover:bg-white/5 transition border border-white/10">Cancelar</button>
                <button id="modal-btn-confirm" class="flex-1 py-3 rounded-xl font-bold bg-primary text-white hover:bg-blue-600 transition shadow-neon">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- MODAL SELECCI칍N DE ESTADO (Glass Unificado) -->
    <div id="modal-status" class="fixed inset-0 z-[100] bg-black/80 backdrop-blur-md hidden flex items-center justify-center transition-opacity duration-200 opacity-0">
        <div id="modal-status-card" class="glass-card w-full max-w-sm rounded-3xl p-8 shadow-2xl transform scale-95 transition-transform duration-200 mx-4">
            <h3 class="text-xl font-bold text-white mb-2 text-center">Actualizar Estado</h3>
            <p class="text-xs text-slate-400 text-center mb-6">Se aplicar치 a los elementos seleccionados.</p>
            <div class="space-y-4">
                <button onclick="app.setStatus('ENVIADO')" class="w-full py-4 rounded-xl font-bold bg-secondary/20 text-secondary hover:bg-secondary/30 border border-secondary/30 flex items-center justify-center gap-3 transition shadow-neon-green">
                    <i data-lucide="truck" class="w-5 h-5"></i> MARCAR COMO ENVIADO
                </button>
                <button onclick="app.setStatus('PENDIENTE')" class="w-full py-4 rounded-xl font-bold bg-yellow-500/20 text-yellow-400 hover:bg-yellow-500/30 border border-yellow-500/30 flex items-center justify-center gap-3 transition">
                    <i data-lucide="clock" class="w-5 h-5"></i> MARCAR COMO PENDIENTE
                </button>
                <button onclick="app.closeModal('modal-status')" class="w-full py-3 rounded-xl font-bold text-slate-400 hover:text-white hover:bg-white/5 mt-2 transition border border-white/10">Cancelar</button>
            </div>
        </div>
    </div>
    
    <!-- MODAL UPSELL (Plan Limitado) -->
    <div id="modal-upsell" class="fixed inset-0 z-[100] bg-black/90 backdrop-blur-lg hidden flex items-center justify-center transition-opacity duration-200 opacity-0">
        <div id="modal-upsell-card" class="glass-card rounded-3xl p-8 max-w-sm w-full mx-4 transform scale-95 transition-transform duration-200 border-2 border-primary/30 shadow-[0_0_50px_rgba(59,130,246,0.2)]">
            <div class="w-16 h-16 bg-primary/20 rounded-full flex items-center justify-center mb-6 text-primary mx-auto shadow-neon border border-primary/20">
                <i data-lucide="crown" class="w-8 h-8"></i>
            </div>
            <h3 class="text-2xl font-bold text-white mb-2 text-center">Plan Profesional</h3>
            <p class="text-slate-300 text-sm mb-6 leading-relaxed text-center">
                Desbloquea el historial ilimitado y accede a todas las funciones avanzadas de Latam5s.
            </p>
            <div class="space-y-3">
                <button onclick="app.activateTrial()" class="w-full py-4 rounded-xl font-bold bg-gradient-to-r from-primary to-indigo-600 text-white hover:scale-[1.02] transition shadow-neon flex items-center justify-center gap-2">
                   <i data-lucide="sparkles" class="w-4 h-4"></i> Actualizar Plan
                </button>
                <button onclick="app.closeModal('modal-upsell')" class="w-full py-3 rounded-xl font-bold text-slate-400 hover:text-white hover:bg-white/5 transition">Entendido</button>
            </div>
        </div>
    </div>

    <!-- TOAST NOTIFICATION -->
    <div id="toast" class="fixed top-4 left-1/2 -translate-x-1/2 z-[100] glass-card border-l-4 border-secondary text-white px-6 py-3 rounded-xl shadow-neon-green flex items-center gap-3 transition-all duration-300 -translate-y-20 opacity-0">
        <i data-lucide="check-circle" class="w-5 h-5 text-secondary"></i>
        <span id="toast-msg" class="font-bold text-sm">Acci칩n completada</span>
    </div>

    <!-- 츼REA DE IMPRESI칍N -->
    <div id="print-area" class="hidden bg-white p-4 text-black"></div>

    <!-- VISTA AUTH (Login) -->
    <div id="view-auth" class="flex-1 h-full flex flex-col items-center justify-center p-4 hidden overflow-y-auto no-print relative z-10">
        <div class="glass-card w-full max-w-md rounded-3xl shadow-2xl overflow-hidden slide-up my-auto relative z-10">
            <div class="bg-card_bg/50 p-8 text-center relative overflow-hidden border-b border-white/5">
                <div class="absolute top-0 right-0 p-4 opacity-5"><i data-lucide="box" class="w-32 h-32 text-white"></i></div>
                <div class="relative z-10">
                    <h1 class="text-3xl font-bold text-white tracking-tight">Latam5S</h1>
                    <div id="connection-status" class="inline-flex items-center gap-2 bg-white/5 px-4 py-1.5 rounded-full text-[10px] font-bold text-secondary mt-3 border border-white/5">
                        <span class="w-2 h-2 rounded-full bg-secondary animate-pulse"></span> Sistema Seguro
                    </div>
                </div>
            </div>

            <div class="p-8">
                <form onsubmit="app.handleLogin(event)" class="space-y-6">
                    <div class="space-y-2">
                        <label class="block text-xs font-bold text-primary uppercase tracking-wider ml-1">WhatsApp</label>
                        <input id="auth-phone" type="tel" required placeholder="Ingresa tu n칰mero" class="w-full bg-black/30 border border-white/10 text-white rounded-xl p-4 outline-none focus:border-primary focus:ring-1 focus:ring-primary transition font-mono placeholder-slate-600">
                    </div>
                    <div class="space-y-2">
                        <label class="block text-xs font-bold text-primary uppercase tracking-wider ml-1">Contrase침a</label>
                        <input id="auth-pass" type="password" required placeholder="Tu clave asignada" class="w-full bg-black/30 border border-white/10 text-white rounded-xl p-4 outline-none focus:border-primary focus:ring-1 focus:ring-primary transition placeholder-slate-600">
                    </div>
                    <button type="submit" class="w-full bg-primary hover:bg-blue-600 text-white font-bold py-4 rounded-xl shadow-neon transition active:scale-95 flex justify-center items-center gap-2 mt-4">
                        Iniciar Sesi칩n
                    </button>
                </form>
                <p id="auth-error" class="text-red-400 text-xs text-center mt-4 font-bold hidden bg-red-500/10 py-2 rounded-lg border border-red-500/20"></p>
                <div class="mt-8 text-center text-xs text-slate-500 pt-4 border-t border-white/5">
                    Acceso exclusivo para socios registrados.
                </div>
            </div>
        </div>
        <div class="mt-8 text-[10px] font-bold text-slate-500 uppercase tracking-widest">
            Powered by Latam5S
        </div>
    </div>

    <!-- VISTA ADMIN -->
    <div id="view-admin" class="flex-1 flex flex-col h-full hidden no-print overflow-hidden z-10">
        <header class="glass-panel p-4 flex justify-between items-center shadow-lg z-20">
            <div class="flex items-center gap-3">
                <div class="bg-primary/20 p-2 rounded-lg text-primary border border-primary/20"><i data-lucide="shield" class="w-5 h-5"></i></div>
                <h1 class="font-bold text-lg text-white">Panel Admin</h1>
            </div>
            <button onclick="app.logout()" class="text-xs font-bold bg-white/5 hover:bg-white/10 text-white px-4 py-2 rounded-lg transition border border-white/5">Salir</button>
        </header>
        <main class="flex-1 p-4 md:p-8 overflow-y-auto max-w-5xl mx-auto w-full space-y-6 pb-20">
            <div class="glass-card p-6 rounded-3xl">
                <h2 class="text-lg font-bold text-white mb-4 flex items-center gap-2"><i data-lucide="user-plus" class="w-5 h-5 text-primary"></i> Alta de Emprendedor</h2>
                <form onsubmit="app.adminCreateUser(event)" class="flex flex-col md:flex-row gap-4 items-end">
                    <div class="flex-1 w-full">
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-2">WhatsApp del Cliente</label>
                        <input id="admin-new-phone" type="tel" required placeholder="Ej: 999888777" class="w-full bg-black/30 border border-white/10 text-white rounded-xl p-4 outline-none focus:border-primary transition">
                    </div>
                    <div class="w-full md:w-40">
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Plan</label>
                        <select id="admin-new-plan" class="w-full bg-black/30 border border-white/10 text-white rounded-xl p-4 outline-none focus:border-primary cursor-pointer">
                            <option value="Gratis" class="bg-card_bg">Gratis</option>
                            <option value="Pro" class="bg-card_bg">Pro</option>
                            <option value="Empresa" class="bg-card_bg">Empresa</option>
                        </select>
                    </div>
                    <button type="submit" class="w-full md:w-auto bg-primary text-white px-6 py-4 rounded-xl font-bold hover:bg-blue-600 transition flex items-center justify-center gap-2 shadow-neon">
                        <i data-lucide="zap" class="w-4 h-4"></i> Crear
                    </button>
                </form>
            </div>
            <div class="glass-card rounded-3xl overflow-hidden">
                <div class="p-6 border-b border-white/5 flex justify-between items-center">
                    <h2 class="text-lg font-bold text-white">Usuarios Registrados</h2>
                    <button onclick="app.adminLoadUsers()" class="p-2 hover:bg-white/5 rounded-full text-slate-400 hover:text-white transition"><i data-lucide="refresh-cw" class="w-4 h-4"></i></button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-slate-300">
                        <thead class="bg-black/20 text-slate-400 uppercase text-xs font-bold">
                            <tr><th class="px-6 py-4">WhatsApp</th><th class="px-6 py-4">Plan</th><th class="px-6 py-4">Fecha Alta</th><th class="px-6 py-4 text-right">Acciones</th></tr>
                        </thead>
                        <tbody id="admin-users-list" class="divide-y divide-white/5"></tbody>
                    </table>
                </div>
            </div>
            <div class="text-center text-[10px] text-slate-500 mt-8 uppercase font-bold tracking-widest">
                Powered by Latam5S
            </div>
        </main>
    </div>

    <!-- VISTA DASHBOARD (EMPRENDEDOR) -->
    <div id="view-dashboard" class="flex-1 flex flex-col md:flex-row h-full hidden no-print overflow-hidden z-10">
        <aside class="w-full md:w-72 glass-panel md:border-r border-b border-white/5 flex flex-col shadow-lg z-20 flex-shrink-0">
            <!-- HEADER ADAPTATIVO -->
            <div class="p-4 md:p-6 border-b border-white/5 flex justify-between items-center bg-black/20">
                <div class="flex items-center gap-3">
                    <div class="bg-secondary/10 p-2 rounded-xl text-secondary border border-secondary/20 shadow-neon-green"><i data-lucide="package" class="w-6 h-6"></i></div>
                    <div>
                        <h1 class="font-bold text-lg text-white leading-tight">Mi Panel</h1>
                        <p class="text-xs text-slate-400 hidden md:block">Emprendedor</p>
                    </div>
                </div>
                <!-- CONTROLES SOLO M칍VIL -->
                <div class="flex items-center gap-3 md:hidden">
                    <div class="text-right">
                        <p class="user-phone-display text-xs font-bold text-slate-300">...</p>
                        <p class="user-plan-display text-[10px] font-bold text-primary bg-primary/10 px-2 py-0.5 rounded border border-primary/20">...</p>
                    </div>
                    <button onclick="app.logout()" class="bg-red-500/10 text-red-400 p-2 rounded-lg hover:bg-red-500/20 transition border border-red-500/20">
                        <i data-lucide="log-out" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>

            <nav class="flex md:flex-col p-2 gap-1 overflow-x-auto no-scrollbar">
                <button onclick="app.setTab('config')" id="nav-config" class="nav-item p-3 rounded-lg text-sm font-bold text-left flex gap-3 items-center text-slate-400 hover:bg-white/5 hover:text-white transition whitespace-nowrap"><i data-lucide="settings" class="w-4 h-4"></i> Configurar</button>
                <button onclick="app.setTab('share')" id="nav-share" class="nav-item p-3 rounded-lg text-sm font-bold text-left flex gap-3 items-center text-slate-400 hover:bg-white/5 hover:text-white transition whitespace-nowrap"><i data-lucide="share-2" class="w-4 h-4"></i> Compartir</button>
                <button onclick="app.setTab('orders')" id="nav-orders" class="nav-item p-3 rounded-lg text-sm font-bold text-left flex gap-3 items-center text-slate-400 hover:bg-white/5 hover:text-white transition whitespace-nowrap"><i data-lucide="truck" class="w-4 h-4"></i> Env칤os</button>
            </nav>
            
            <!-- FOOTER ESCRITORIO -->
            <div class="mt-auto p-4 border-t border-white/5 hidden md:block bg-black/20">
                <div class="flex items-center gap-3 mb-4">
                    <div class="w-10 h-10 rounded-full bg-white/5 flex items-center justify-center text-slate-400 border border-white/5"><i data-lucide="phone" class="w-5 h-5"></i></div>
                    <div class="overflow-hidden">
                        <p class="user-phone-display text-sm font-bold text-white truncate">...</p>
                        <p class="user-plan-display text-[10px] font-bold text-primary uppercase tracking-wide bg-primary/10 px-2 py-0.5 rounded w-fit mt-1 border border-primary/20">PLAN GRATIS</p>
                    </div>
                </div>
                <button onclick="app.logout()" class="w-full text-red-400 text-xs font-bold hover:bg-red-500/10 py-3 rounded-xl transition border border-transparent hover:border-red-500/20">Cerrar Sesi칩n</button>
                <div class="text-center text-[9px] text-slate-500 mt-4 uppercase font-bold tracking-widest">
                    Powered by Latam5S
                </div>
            </div>
        </aside>
        
        <!-- Contenedor Principal -->
        <main class="flex-1 relative overflow-hidden flex flex-col">
            <!-- Decoraci칩n de fondo sutil -->
            <div class="absolute top-0 left-0 w-full h-full overflow-hidden pointer-events-none opacity-20">
                <div class="absolute top-[10%] right-[10%] w-64 h-64 bg-primary/30 rounded-full blur-[100px]"></div>
            </div>
            
            <!-- PESTA칌A CONFIGURACI칍N (Aplicado glass-card unificado, ancho completo) -->
            <div id="tab-config" class="tab-content w-full h-full overflow-y-auto p-4 md:p-8 hidden no-scrollbar z-10">
                <div class="max-w-7xl mx-auto slide-up pb-32">
                    <div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold text-white">Configuraci칩n</h2><button id="btn-save-config" onclick="app.saveConfig()" class="bg-primary text-white px-6 py-2.5 rounded-xl text-sm font-bold hover:bg-blue-600 transition flex gap-2 shadow-neon"><i data-lucide="save" class="w-4 h-4"></i> Guardar</button></div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Columna Izquierda: Datos y Seguridad -->
                        <div class="space-y-6">
                            <div class="glass-card p-6 rounded-3xl space-y-5">
                                <h3 class="font-bold text-primary uppercase text-xs tracking-wider mb-4 border-b border-white/5 pb-2">Datos P칰blicos</h3>
                                <div><label class="text-xs font-bold text-slate-400 uppercase mb-1 block">Nombre Tienda</label><input id="inp-store-name" oninput="app.updateConfigInput('merchantName', this.value)" class="w-full bg-black/30 border border-white/10 rounded-xl p-4 text-white outline-none focus:border-primary transition"></div>
                                <div><label class="text-xs font-bold text-slate-400 uppercase mb-1 block">WhatsApp Pedidos</label><input id="inp-whatsapp" type="tel" oninput="app.updateConfigInput('whatsapp', this.value)" class="w-full bg-black/30 border border-white/10 rounded-xl p-4 text-white outline-none focus:border-primary transition"></div>
                            </div>
                            
                            <div class="glass-card p-6 rounded-3xl">
                                <h3 class="font-bold text-primary uppercase text-xs tracking-wider mb-4 flex items-center gap-2 border-b border-white/5 pb-2"><i data-lucide="lock" class="w-3 h-3"></i> Seguridad</h3>
                                <div class="flex gap-3 items-end">
                                    <div class="flex-1">
                                        <label class="text-xs font-bold text-slate-400 uppercase mb-1 block">Nueva Contrase침a</label>
                                        <input id="inp-new-pass" type="password" class="w-full bg-black/30 border border-white/10 rounded-xl p-4 text-white outline-none focus:border-primary transition">
                                    </div>
                                    <button id="btn-change-pass" onclick="app.changePassword()" class="bg-indigo-600 text-white px-6 py-3 rounded-xl text-sm font-bold hover:bg-indigo-700 transition h-[56px] shadow-lg">Actualizar</button>
                                </div>
                            </div>
                        </div>

                        <!-- Columna Derecha: Log칤stica (Full Height) -->
                        <div class="flex flex-col">
                            <div class="glass-card p-6 rounded-3xl space-y-5 h-full">
                                <h3 class="font-bold text-primary uppercase text-xs tracking-wider mb-4 border-b border-white/5 pb-2">Log칤stica</h3>
                                <label class="text-xs font-bold text-slate-400 uppercase block">Couriers</label><div id="container-couriers" class="grid grid-cols-2 gap-2"></div>
                                <label class="text-xs font-bold text-slate-400 uppercase block mt-2">D칤as Env칤o</label><div id="container-days" class="flex flex-wrap gap-2"></div>
                                <div class="flex items-center gap-3 mt-4 bg-black/20 p-3 rounded-xl border border-white/5"><span class="text-sm font-bold text-slate-300">Hora Corte:</span><input type="time" id="inp-time" onchange="app.updateConfigInput('updateTime', this.value)" class="bg-transparent border border-white/10 rounded px-2 py-1 text-sm text-white outline-none focus:border-primary"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="text-center text-[10px] text-slate-500 uppercase font-bold tracking-widest pt-8">
                        Powered by Latam5S
                    </div>
                </div>
            </div>
            
            <!-- PESTA칌A COMPARTIR (Ya ten칤a glass-card, se mantiene igual) -->
            <div id="tab-share" class="tab-content w-full h-full overflow-y-auto p-4 hidden no-scrollbar z-10">
                <div class="min-h-full flex flex-col items-center justify-center py-8 pb-32">
                    <div class="glass-card p-8 rounded-3xl text-center max-w-md w-full slide-up border border-white/10">
                        <div class="w-20 h-20 bg-secondary/10 rounded-full flex items-center justify-center mx-auto mb-6 text-secondary border border-secondary/20 shadow-neon-green"><i data-lucide="share-2" class="w-10 h-10"></i></div>
                        
                        <h2 class="text-2xl font-bold mb-4 text-white">Enlace P칰blico</h2>
                        <p class="text-slate-400 text-sm mb-8 leading-relaxed">
                            춰Listo para compartir! <br>
                            Tu formulario personalizado est치 activo. Comparte el siguiente enlace con tus clientes.
                        </p>

                        <div class="bg-black/30 p-4 rounded-xl border border-white/10 mb-8 break-all font-mono text-primary select-all cursor-pointer hover:bg-black/40 transition" onclick="app.copyLink()"><code id="share-link" class="text-xs font-bold">...</code></div>
                        
                        <div class="space-y-4">
                            <button id="btn-copy-link" onclick="app.copyLink()" class="w-full bg-primary text-white py-4 rounded-xl font-bold hover:bg-blue-600 transition shadow-neon">Copiar Link</button>
                            <button onclick="app.shareOnWhatsapp()" class="w-full bg-secondary/20 text-secondary py-4 rounded-xl font-bold hover:bg-secondary/30 transition flex items-center justify-center gap-3 border border-secondary/20">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                                  <path d="M13.601 2.326A7.854 7.854 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.933 7.933 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.898 7.898 0 0 0 13.6 2.326zM7.994 14.521a6.573 6.573 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 0 1 4.66 1.931 6.557 6.557 0 0 1 1.928 4.66c-.004 3.639-2.961 6.592-6.592 6.592zm3.615-4.934c-.197-.099-1.17-.578-1.353-.646-.182-.065-.315-.099-.445.099-.133.197-.513.646-.627.775-.114.133-.232.148-.43.05-.197-.1-.836-.308-1.592-.985-.59-.525-.985-1.175-1.103-1.372-.114-.198-.011-.304.088-.403.087-.088.197-.232.296-.346.1-.114.133-.198.198-.33.065-.134.034-.248-.015-.347-.05-.099-.445-1.076-.612-1.47-.16-.389-.323-.335-.445-.34-.114-.007-.247-.007-.38-.007a.729.729 0 0 0-.529.247c-.182.198-.691.677-.691 1.654 0 .977.71 1.916.81 2.049.098.133 1.394 2.132 3.383 2.992.47.205.84.326 1.129.418.475.152.904.129 1.246.08.38-.058 1.171-.48 1.338-.943.164-.464.164-.86.114-.943-.049-.084-.182-.133-.38-.232z"/>
                                </svg>
                                Enviar por WhatsApp
                            </button>
                            <button onclick="app.openClientLink()" class="w-full bg-white/5 text-white border border-white/10 py-4 rounded-xl font-bold hover:bg-white/10 transition flex items-center justify-center gap-2"><i data-lucide="external-link" class="w-4 h-4"></i> Abrir en nueva pesta침a</button>
                        </div>
                    </div>
                    <div class="text-center text-[10px] text-slate-500 uppercase font-bold tracking-widest mt-8">
                        Powered by Latam5S
                    </div>
                </div>
            </div>
            
            <!-- PESTA칌A ENV칈OS (Actualizada a rounded-3xl) -->
            <div id="tab-orders" class="tab-content hidden w-full h-full flex flex-col p-3 md:p-8 z-10">
                
                <!-- Toolbar Compacta Glass -->
                <div class="glass-card p-4 rounded-3xl mb-3 flex flex-col gap-3 flex-shrink-0">
                    <!-- L칤nea 1: Filtros -->
                    <div class="flex gap-2">
                        <div class="relative flex-grow">
                            <i data-lucide="search" class="absolute left-3 top-2.5 w-4 h-4 text-slate-400"></i>
                            <input id="inp-search-orders" oninput="app.renderOrders()" class="w-full pl-9 pr-3 py-2 bg-black/30 border border-white/10 rounded-xl text-sm text-white focus:border-primary outline-none placeholder-slate-500" placeholder="Buscar cliente, DNI, ref...">
                        </div>
                        <input type="date" id="date-specific" onchange="app.renderOrders()" class="bg-black/30 border border-white/10 rounded-xl px-2 py-2 text-sm w-32 text-white focus:border-primary outline-none flex-shrink-0">
                    </div>
                    
                    <!-- L칤nea 2: Herramientas -->
                    <div class="flex items-center gap-2 overflow-x-auto no-scrollbar pb-1">
                        <button onclick="app.toggleAllSelection()" class="px-3 py-2 bg-white/5 hover:bg-white/10 border border-white/10 text-slate-300 rounded-lg text-xs font-bold whitespace-nowrap flex items-center gap-2 flex-shrink-0 transition">
                            <i data-lucide="check-square" class="w-4 h-4"></i> <span class="hidden sm:inline">Todo</span>
                        </button>
                        
                        <div class="h-6 w-px bg-white/10 mx-1 flex-shrink-0"></div>
                        
                        <button onclick="app.printLabels()" class="px-3 py-2 bg-white/5 text-slate-300 border border-white/10 rounded-lg font-bold hover:bg-white/10 transition flex items-center justify-center gap-2 text-xs flex-shrink-0">
                            <i data-lucide="printer" class="w-4 h-4"></i> <span class="hidden sm:inline">Etiquetas</span>
                        </button>
                        <button onclick="app.exportExcel()" class="px-3 py-2 bg-secondary/10 text-secondary border border-secondary/20 rounded-lg font-bold hover:bg-secondary/20 transition flex items-center justify-center gap-2 text-xs flex-shrink-0">
                            <i data-lucide="file-spreadsheet" class="w-4 h-4"></i> <span class="hidden sm:inline">Excel</span>
                        </button>
                        <button onclick="app.loadOrders()" class="px-3 py-2 bg-white/5 border border-white/10 rounded-lg hover:bg-white/10 text-slate-300 flex-shrink-0 transition">
                            <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                        </button>

                        <div class="h-6 w-px bg-white/10 mx-1 flex-shrink-0"></div>

                        <button onclick="app.openStatusMenu()" class="px-3 py-2 bg-primary/80 hover:bg-primary text-white rounded-lg text-xs font-bold whitespace-nowrap flex items-center gap-1 flex-shrink-0 shadow-neon transition">
                            <i data-lucide="plus-circle" class="w-4 h-4"></i> <span class="hidden sm:inline">Estado</span>
                        </button>
                        <button onclick="app.deleteSelected()" class="px-3 py-2 bg-red-500/10 hover:bg-red-500/20 text-red-400 border border-red-500/20 rounded-lg text-xs font-bold whitespace-nowrap flex items-center gap-2 flex-shrink-0 transition">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>

                <!-- Lista Glass -->
                <div class="flex-1 min-h-0 flex flex-col glass-card rounded-3xl relative">
                    <div class="overflow-y-auto p-2 space-y-1 h-full pb-32 custom-scrollbar" id="orders-list">
                        <!-- Items -->
                    </div>
                    <!-- AVISO DEL PLAN GRATIS (SE MUESTRA SOLO SI EL PLAN ES GRATIS) -->
                     <div id="plan-limit-warning" class="hidden absolute inset-0 p-6 bg-dark_bg/90 backdrop-blur-md z-30 flex flex-col items-center justify-center text-center rounded-3xl">
                        <div class="w-16 h-16 bg-primary/20 rounded-full flex items-center justify-center mb-6 text-primary mx-auto shadow-neon border border-primary/20 animate-pulse">
                            <i data-lucide="lock" class="w-8 h-8"></i>
                        </div>
                        <h3 class="text-lg font-bold text-white mb-2">Plan Gratuito Limitado</h3>
                        <p class="text-sm text-slate-400 mb-6 font-medium">
                            La visualizaci칩n de respuestas no est치 incluida en su plan actual.
                        </p>
                        <button onclick="app.activateTrial()" class="bg-gradient-to-r from-primary to-indigo-600 text-white px-8 py-4 rounded-xl font-bold shadow-neon hover:scale-105 transition flex items-center gap-2">
                           <i data-lucide="sparkles" class="w-4 h-4"></i> Actualizar para ver <span id="hidden-count">0</span> registros
                        </button>
                        <p class="text-[11px] text-slate-500 mt-6 leading-relaxed max-w-xs mx-auto border-t border-white/5 pt-4">
                            Todas tus respuestas ser치n visibles aqu칤, incluidas las conversaciones que se descarten en WhatsApp. Con el plan gratuito, solo se almacenan 2 meses de respuestas.
                        </p>
                    </div>
                </div>
                
                <div class="text-center text-[10px] text-slate-500 uppercase font-bold tracking-widest mt-4 md:hidden pb-2">
                    Powered by Latam5S
                </div>
            </div>
        </main>
    </div>

    <!-- VISTA CLIENTE (White Theme) -->
    <div id="view-client" class="flex-1 h-full hidden overflow-y-auto no-print bg-gray-50 text-slate-800 z-10">
        
        <div class="max-w-2xl mx-auto min-h-screen bg-white rounded-3xl shadow-xl flex flex-col relative overflow-hidden border border-gray-200 my-4">
            
            <div class="bg-slate-900 p-6 sticky top-0 z-30 shadow-md flex items-center gap-3 border-b border-gray-800">
                <div class="w-10 h-10 bg-primary/20 rounded-full flex items-center justify-center text-primary shadow-neon border border-primary/20">
                    <i data-lucide="shopping-bag" class="w-5 h-5"></i>
                </div>
                <div>
                    <h1 id="client-title" class="font-bold text-lg leading-tight text-white">Cargando...</h1>
                    <p class="text-xs text-slate-400">Datos de Env칤o</p>
                </div>
            </div>

            <div class="flex-1 p-6 space-y-8">
                
                <div class="bg-yellow-50 border-l-4 border-yellow-500 p-4 rounded-r-lg shadow-sm">
                    <p class="text-xs text-yellow-800">游늰 Pedidos para hoy cierran a las <strong id="client-time">--:--</strong>.</p>
                </div>

                <form id="client-form" onsubmit="app.submitOrder(event)" class="space-y-8">
                    <div class="space-y-4">
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">Agencia / Delivery</label>
                                <div class="relative">
                                    <select id="c-courier-select" onchange="app.onCourierChange(this.value)" class="w-full appearance-none bg-white border border-gray-300 rounded-xl py-3 pl-4 pr-10 text-gray-900 font-medium focus:border-primary focus:ring-1 focus:ring-primary outline-none cursor-pointer transition shadow-sm">
                                        <option value="" disabled selected class="text-gray-400">Elige una opci칩n...</option>
                                    </select>
                                    <div class="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none text-gray-500"><i data-lucide="chevron-down" class="w-4 h-4"></i></div>
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">Fecha de Despacho</label>
                                <div class="relative">
                                    <select id="c-date-select" onchange="app.validateForm()" class="w-full appearance-none bg-white border border-gray-300 rounded-xl py-3 pl-4 pr-10 text-gray-900 font-medium focus:border-primary focus:ring-1 focus:ring-primary outline-none cursor-pointer transition shadow-sm">
                                        <option value="" disabled selected class="text-gray-400">Elige fecha...</option>
                                    </select>
                                    <div class="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none text-gray-500"><i data-lucide="calendar" class="w-4 h-4"></i></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="dynamic-form-section" class="hidden space-y-4 fade-in">
                        
                        <div id="fields-agency" class="hidden space-y-4">
                            <div class="relative z-20">
                                <div class="relative group">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i data-lucide="search" class="h-5 w-5 text-gray-400"></i></div>
                                    <input id="c-agency" type="text" class="w-full bg-white border border-gray-300 text-gray-900 rounded-xl pl-10 pr-10 py-3 outline-none focus:border-primary focus:ring-1 focus:ring-primary transition placeholder-gray-400 shadow-sm" placeholder="Buscar Sede (Calle / Distrito)..." autocomplete="off" oninput="app.searchAgency(this.value)">
                                    <div class="absolute inset-y-0 right-0 pr-3 flex items-center"><button type="button" id="btn-clear-agency" onclick="app.clearAgency()" class="hidden text-gray-400 hover:text-gray-600 p-1"><i data-lucide="x" class="h-5 w-5"></i></button></div>
                                    <div id="agency-results" class="hidden absolute left-0 right-0 top-full mt-2 bg-white border border-gray-200 rounded-xl shadow-2xl max-h-64 overflow-y-auto z-50 divide-y divide-gray-100"></div>
                                </div>
                            </div>
                            <div><input id="c-dni" type="tel" class="w-full bg-white border border-gray-300 text-gray-900 rounded-lg p-3 outline-none focus:border-primary focus:ring-1 focus:ring-primary transition placeholder-gray-400 shadow-sm" placeholder="DNI / CE"></div>
                        </div>

                        <div id="fields-home" class="hidden space-y-4">
                            <div class="relative z-20">
                                <div class="relative group">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i data-lucide="map-pin" class="h-5 w-5 text-gray-400"></i></div>
                                    <input id="c-district" type="text" class="w-full bg-white border border-gray-300 text-gray-900 rounded-xl pl-10 pr-10 py-3 outline-none focus:border-primary focus:ring-1 focus:ring-primary transition placeholder-gray-400 shadow-sm" placeholder="Buscar Distrito..." autocomplete="off" oninput="app.searchDistrict(this.value)">
                                    <div class="absolute inset-y-0 right-0 pr-3 flex items-center"><button type="button" id="btn-clear-district" onclick="app.clearDistrict()" class="hidden text-gray-400 hover:text-gray-600 p-1"><i data-lucide="x" class="h-5 w-5"></i></button></div>
                                    <div id="district-results" class="hidden absolute left-0 right-0 top-full mt-2 bg-white border border-gray-200 rounded-xl shadow-2xl max-h-64 overflow-y-auto z-50 divide-y divide-gray-100"></div>
                                    </div>
                            </div>
                            <div><input id="c-address" class="w-full bg-white border border-gray-300 text-gray-900 rounded-lg p-3 outline-none focus:border-primary focus:ring-1 focus:ring-primary transition placeholder-gray-400 shadow-sm" placeholder="Direcci칩n Exacta (Calle / Av / Jr)"></div>
                            <div><input id="c-ref" class="w-full bg-white border border-gray-300 text-gray-900 rounded-lg p-3 outline-none focus:border-primary focus:ring-1 focus:ring-primary transition placeholder-gray-400 shadow-sm" placeholder="Referencia (Frente a...)"></div>
                        </div>

                        <div class="space-y-4 pt-1">
                            <div><input id="c-name" required class="w-full bg-white border border-gray-300 text-gray-900 rounded-lg p-3 outline-none focus:border-primary focus:ring-1 focus:ring-primary transition placeholder-gray-400 shadow-sm" placeholder="Nombre Completo"></div>
                            <div><input id="c-phone" type="tel" required class="w-full bg-white border border-gray-300 text-gray-900 rounded-lg p-3 outline-none focus:border-primary focus:ring-1 focus:ring-primary transition placeholder-gray-400 shadow-sm" placeholder="Celular / WhatsApp"></div>
                        </div>
                    </div>

                    <div class="pt-2">
                        <button type="submit" id="btn-submit-order" disabled class="w-full bg-secondary text-white font-bold py-4 rounded-xl shadow-lg transition active:scale-95 flex justify-center items-center gap-2 text-lg disabled:opacity-50 disabled:cursor-not-allowed hover:bg-green-600 hover:shadow-green-500/30">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16" class="w-6 h-6">
                                <path d="M13.601 2.326A7.854 7.854 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.933 7.933 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.898 7.898 0 0 0 13.6 2.326zM7.994 14.521a6.573 6.573 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 0 1 4.66 1.931 6.557 6.557 0 0 1 1.928 4.66c-.004 3.639-2.961 6.592-6.592 6.592zm3.615-4.934c-.197-.099-1.17-.578-1.353-.646-.182-.065-.315-.099-.445.099-.133.197-.513.646-.627.775-.114.133-.232.148-.43.05-.197-.1-.836-.308-1.592-.985-.59-.525-.985-1.175-1.103-1.372-.114-.198-.011-.304.088-.403.087-.088.197-.232.296-.346.1-.114.133-.198.198-.33.065-.134.034-.248-.015-.347-.05-.099-.445-1.076-.612-1.47-.16-.389-.323-.335-.445-.34-.114-.007-.247-.007-.38-.007a.729.729 0 0 0-.529.247c-.182.198-.691.677-.691 1.654 0 .977.71 1.916.81 2.049.098.133 1.394 2.132 3.383 2.992.47.205.84.326 1.129.418.475.152.904.129 1.246.08.38-.058 1.171-.48 1.338-.943.164-.464.164-.86.114-.943-.049-.084-.182-.133-.38-.232z"/>
                            </svg> Enviar por WhatsApp
                        </button>
                    </div>
                </form>
                
                <div class="mt-8 pt-6 border-t border-gray-100 pb-2">
                    <a href="https://www.latam5s.com" target="_blank" class="group block bg-slate-50 hover:bg-blue-50/50 border border-gray-200 hover:border-blue-200 rounded-xl p-4 transition-all duration-300 transform hover:-translate-y-1">
                        <div class="flex items-center justify-center gap-4">
                            <div class="w-10 h-10 bg-gradient-to-tr from-primary to-blue-600 text-white rounded-lg flex items-center justify-center font-bold text-sm tracking-tighter shadow-md group-hover:shadow-blue-200 group-hover:scale-110 transition-transform">
                                5S
                            </div>
                            
                            <div class="text-left">
                                <p class="text-[10px] uppercase font-bold text-gray-400 tracking-wider mb-0.5">Powered by Latam5S</p>
                                <p class="text-sm font-bold text-slate-800 group-hover:text-primary transition-colors leading-tight">
                                    쯌endes por WhatsApp? <br>
                                    <span class="text-primary underline decoration-blue-200 underline-offset-2">Crea tu formulario gratis aqu칤</span>
                                </p>
                            </div>
                            
                            <div class="text-gray-300 group-hover:text-primary transition-colors">
                                <i data-lucide="chevron-right" class="w-5 h-5"></i>
                            </div>
                        </div>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- PARTICLES ANIMATION ---
        const canvas = document.getElementById('particles-js');
        const ctx = canvas.getContext('2d');
        let particles = [];
        
        // Resize
        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        // Particle Class
        class Particle {
            constructor() {
                this.x = Math.random() * canvas.width;
                this.y = Math.random() * canvas.height;
                this.vx = (Math.random() - 0.5) * 0.5; // Velocidad lenta
                this.vy = (Math.random() - 0.5) * 0.5;
                this.size = Math.random() * 2;
            }
            update() {
                this.x += this.vx;
                this.y += this.vy;
                if (this.x < 0 || this.x > canvas.width) this.vx *= -1;
                if (this.y < 0 || this.y > canvas.height) this.vy *= -1;
            }
            draw() {
                ctx.fillStyle = 'rgba(59, 130, 246, 0.5)'; // Azul primary
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        // Init Particles
        function initParticles() {
            particles = [];
            const numParticles = Math.min(window.innerWidth / 10, 100); // Ajustar densidad
            for (let i = 0; i < numParticles; i++) {
                particles.push(new Particle());
            }
        }

        // Animate Loop
        function animateParticles() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Update & Draw
            for (let i = 0; i < particles.length; i++) {
                particles[i].update();
                particles[i].draw();
                
                // Draw Connections
                for (let j = i; j < particles.length; j++) {
                    const dx = particles[i].x - particles[j].x;
                    const dy = particles[i].y - particles[j].y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (distance < 150) {
                        ctx.beginPath();
                        ctx.strokeStyle = `rgba(59, 130, 246, ${1 - distance / 150})`; // Fade out
                        ctx.lineWidth = 0.5;
                        ctx.moveTo(particles[i].x, particles[i].y);
                        ctx.lineTo(particles[j].x, particles[j].y);
                        ctx.stroke();
                    }
                }
            }
            requestAnimationFrame(animateParticles);
        }

        initParticles();
        animateParticles();

        // --- APP LOGIC ---

        const DEFAULT_API_URL = "https://script.google.com/macros/s/AKfycbz5_FO5mG1jqBhswQRaPZhJjIno3fFpycM5dvZokjkGW530dr_JGKZjafuNTybKhLV_kw/exec";
        const JSON_DISTRITOS = "lstDistritos.json";
        const JSON_SHALOM = "lstShalom.json";

        // CONFIGURACI칍N DE LIMITES DEL PLAN (FEATURE FLAGS)
        const PLAN_FEATURES = {
            'Gratis': {
                allowViewOrders: false, // NO mostrar nada
            },
            'Pro': {
                allowViewOrders: true, 
            },
            'Empresa': {
                allowViewOrders: true,
            }
        };

        const COURIER_TYPES = { "Shalom": "agency", "Olva Courier": "agency", "Flores": "agency", "Cruz del Sur": "agency", "Rappi": "home", "PedidosYa": "home", "Motorizado": "home", "DHL": "home", "FedEx": "home", "Tienda": "home" };
        const SafeStorage = { memory: {}, setItem: function(k, v) { try { localStorage.setItem(k, v); } catch(e) { this.memory[k] = v; } }, getItem: function(k) { try { return localStorage.getItem(k); } catch(e) { return this.memory[k] || null; } }, removeItem: function(k) { try { localStorage.removeItem(k); } catch(e) { delete this.memory[k]; } } };
        const ALL_COURIERS = ["Olva Courier", "Shalom", "Rappi", "PedidosYa", "DHL", "FedEx", "Motorizado", "Tienda"];
        const ALL_DAYS = ["Lun", "Mar", "Mi칠", "Jue", "Vie", "S치b", "Dom"];
        const DAY_INDEX_MAP = { "Dom": 0, "Lun": 1, "Mar": 2, "Mi칠": 3, "Jue": 4, "Vie": 5, "S치b": 6 };
        const DAY_NAMES_FULL = ["Domingo", "Lunes", "Martes", "Mi칠rcoles", "Jueves", "Viernes", "S치bado"];
        const MONTH_NAMES = ["Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"];
        const initialState = { merchantName: "", whatsapp: "", couriers: [], shippingDays: [], updateTime: "18:00" };
        const state = { user: null, merchantId: null, apiUrl: DEFAULT_API_URL, isClientView: false, config: { ...initialState }, selectedCourierType: null, externalData: {}, allOrders: [], selectedOrders: new Set(), visibleOrders: [] };

        // Helper para sanitizar XSS
        const escapeHtml = (unsafe) => {
            if (typeof unsafe !== 'string') return unsafe;
            return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        };

        window.app = {

            updateConfigInput: (key, value) => {
                state.config[key] = value;
            },

            toggleLoading: (show) => { const el = document.getElementById('loading-overlay'); show ? (el.classList.remove('hidden'), setTimeout(()=>el.classList.remove('opacity-0'),10)) : (el.classList.add('opacity-0'), setTimeout(()=>el.classList.add('hidden'),300)); },
            
            // --- UI HELPERS: Modal & Toast ---
            showModal: (msg, callback) => {
                const el = document.getElementById('modal-confirm'), card = document.getElementById('modal-card');
                document.getElementById('modal-msg').innerText = msg;
                document.getElementById('modal-btn-confirm').onclick = () => { callback(); app.closeModal('modal-confirm'); };
                el.classList.remove('hidden');
                setTimeout(() => { el.classList.remove('opacity-0'); card.classList.remove('scale-95'); card.classList.add('scale-100'); }, 10);
            },
            
            // FUNCI칍N CORREGIDA: ACTIVAR PRUEBA GRATIS CONECTADA AL BACKEND
            activateTrial: async () => {
                // 1. Mostrar carga
                app.toggleLoading(true);

                try {
                    // 2. Llamada real al Google Sheet
                    const response = await fetch(state.apiUrl, { 
                        method: "POST", 
                        body: JSON.stringify({ 
                            action: "startTrial", 
                            merchantId: state.user.uid 
                        }) 
                    });
                    
                    const json = await response.json();

                    if (json.status === 'success') {
                        // 3. Actualizar estado local solo si el servidor confirm칩
                        const now = new Date().getTime();
                        state.user.plan = 'Pro (Prueba)';
                        // Calculamos fecha visualmente, aunque el servidor manda (7 d칤as)
                        state.user.trialEndsAt = now + (7 * 24 * 60 * 60 * 1000);
                        
                        // 4. Guardar en navegador
                        SafeStorage.setItem('app_current_user', JSON.stringify(state.user));
                        
                        // 5. Actualizar UI
                        app.closeModal('modal-upsell'); // Cerrar modal si existe
                        document.getElementById('plan-limit-warning').classList.add('hidden'); // Quitar bloqueo visual
                        
                        // 6. Recargar datos para mostrar los pedidos que estaban ocultos
                        app.showToast('춰Prueba Pro activada por 7 d칤as!');
                        await app.loadData(); 

                    } else {
                        app.showToast('Error: ' + (json.message || 'No se pudo activar'));
                    }
                } catch (e) {
                    console.error(e);
                    app.showToast('Error de conexi칩n con el servidor');
                } finally {
                    app.toggleLoading(false);
                }
            },

            showUpgradeModal: () => {
                // Mostrar el modal de actualizaci칩n (ahora es el bloqueo)
                // En este dise침o, el bloqueo YA es el modal, pero si queremos un popup extra:
                // const el = document.getElementById('modal-upsell'), card = document.getElementById('modal-upsell-card');
                // el.classList.remove('hidden');
                // setTimeout(() => { el.classList.remove('opacity-0'); card.classList.remove('scale-95'); card.classList.add('scale-100'); }, 10);
                
                // Como el usuario ya est치 viendo el bloqueo en la lista, el bot칩n "Actualizar" llama directamente a activateTrial
                app.activateTrial();
            },
            
            // Nuevo: Control gen칠rico de modales
            closeModal: (modalId) => {
                const el = document.getElementById(modalId);
                if (!el) return;
                const card = el.firstElementChild; 
                el.classList.add('opacity-0'); 
                if(card) {
                    card.classList.remove('scale-100'); 
                    card.classList.add('scale-95');
                }
                setTimeout(() => el.classList.add('hidden'), 300);
            },
            
            openStatusMenu: () => {
                if (state.selectedOrders.size === 0) return app.showToast('Selecciona al menos un env칤o');
                const el = document.getElementById('modal-status'), card = document.getElementById('modal-status-card');
                el.classList.remove('hidden');
                setTimeout(() => { el.classList.remove('opacity-0'); card.classList.remove('scale-95'); card.classList.add('scale-100'); }, 10);
            },

            setStatus: (newStatus) => {
                app.closeModal('modal-status');
                app.showModal(`쮺ambiar ${state.selectedOrders.size} env칤os a ${newStatus}?`, async () => {
                    app.toggleLoading(true);
                    const ids = Array.from(state.selectedOrders);
                    try { await fetch(state.apiUrl, { method: "POST", body: JSON.stringify({ action: "updateOrdersStatus", merchantId: state.merchantId, orderIds: ids, newStatus: newStatus }) }); app.showToast('Estados actualizados'); app.loadOrders(); } catch(e) {}
                    app.toggleLoading(false);
                });
            },

            // NUEVA FUNCI칍N: ENVIAR RESUMEN AL CLIENTE
            sendClientSummary: (orderId) => {
                const order = state.allOrders.find(o => String(o.orderId || o.createdAt) === String(orderId));
                if (!order) return app.showToast("Error: No se encontr칩 el pedido.");

                const storeName = state.config.merchantName || "Nuestra Tienda";
                let phone = (order.clientPhone || "").replace(/[^0-9]/g, "");
                if (phone.length === 9) { phone = "51" + phone; }
                if (phone.length < 9) return app.showToast("El n칰mero de tel칠fono no es v치lido.");

                const statusEmoji = order.status === 'ENVIADO' ? '九' : '游닍';
                const statusText = order.status === 'ENVIADO' ? 'Enviado' : 'Registrado';
                
                let destinationInfo = "";
                if (order.clientAgency) {
                    destinationInfo = `游끽 *Agencia:* ${order.clientAgency} (DNI: ${order.clientDni})`;
                } else {
                    destinationInfo = `游 *Direcci칩n:* ${order.clientAddress}, ${order.clientDistrict} (Ref: ${order.clientRef})`;
                }

                const message = `Hola *${order.clientName}*! 游녦\n` +
                                `Tu pedido en *${storeName}* est치 *${statusText}* ${statusEmoji}\n\n` +
                                `游닇 *Detalles del Env칤o:*\n` +
                                `游늰 Fecha: ${order.shippingDate}\n` +
                                `游뚴 Courier: ${order.courier}\n` +
                                `${destinationInfo}\n\n` +
                                `Gracias por tu compra! 九`;

                const url = `https://wa.me/${phone}?text=${encodeURIComponent(message)}`;
                window.open(url, '_blank');
            },
            
            showToast: (msg) => {
                const el = document.getElementById('toast');
                document.getElementById('toast-msg').innerText = msg;
                el.classList.remove('opacity-0', '-translate-y-20');
                setTimeout(() => el.classList.add('opacity-0', '-translate-y-20'), 3000);
            },
            // -------------------------------

            loadExternalLists: async () => { try { if(!state.externalData.districts) { const res = await fetch(JSON_DISTRITOS); const data = await res.json(); state.externalData.districts = data.map(d => d.Distrito || d.nombre); } if(!state.externalData.agencies) { const res = await fetch(JSON_SHALOM); state.externalData.agencies = await res.json(); } } catch(e) { console.error(e); } },
            scrollToEl: (el) => { setTimeout(() => { el.scrollIntoView({ behavior: 'smooth', block: 'center' }); }, 100); },

            searchAgency: (q) => { const c = document.getElementById('agency-results'), x = document.getElementById('btn-clear-agency'); if (!q) { c.classList.add('hidden'); x.classList.add('hidden'); return; } x.classList.remove('hidden'); if(q.length<2) { c.classList.add('hidden'); return; } const lq = q.toLowerCase(); const m = (state.externalData.agencies||[]).filter(a => (a.Agencia && a.Agencia.toLowerCase().includes(lq)) || (a.Direccion && a.Direccion.toLowerCase().includes(lq))).slice(0,50); c.innerHTML = m.length ? m.map(a => `<div onclick="app.selectAgency('${escapeHtml(a.Agencia.replace(/'/g,"\\'"))}','${escapeHtml(a.Direccion.replace(/'/g,"\\'").replace(/\n/g," "))}')" class="p-4 cursor-pointer hover:bg-slate-50 transition border-b border-slate-50 last:border-0"><p class="font-bold text-slate-800 text-sm mb-1">${escapeHtml(a.Agencia)}</p><p class="text-xs text-slate-500">${escapeHtml(a.Direccion)}</p></div>`).join('') : '<div class="p-4 text-slate-400 text-sm text-center">Sin resultados</div>'; c.classList.remove('hidden'); },
            selectAgency: (n, a) => { document.getElementById('c-agency').value = `${n} - ${a}`; document.getElementById('agency-results').classList.add('hidden'); document.getElementById('btn-clear-agency').classList.remove('hidden'); },
            clearAgency: () => { const i = document.getElementById('c-agency'); i.value=''; document.getElementById('agency-results').classList.add('hidden'); document.getElementById('btn-clear-agency').classList.add('hidden'); i.focus(); },
            searchDistrict: (q) => { const c = document.getElementById('district-results'), x = document.getElementById('btn-clear-district'); if (!q) { c.classList.add('hidden'); x.classList.add('hidden'); return; } x.classList.remove('hidden'); if(q.length<1) { c.classList.add('hidden'); return; } const lq = q.toLowerCase(); const m = (state.externalData.districts||[]).filter(d => d.toLowerCase().includes(lq)).slice(0,50); c.innerHTML = m.length ? m.map(d => `<div onclick="app.selectDistrict('${escapeHtml(d).replace(/'/g,"\\'")}')" class="p-4 cursor-pointer hover:bg-slate-50 transition border-b border-slate-50 last:border-0"><p class="font-bold text-slate-800 text-sm">${escapeHtml(d)}</p></div>`).join('') : '<div class="p-4 text-slate-400 text-sm text-center">Sin resultados</div>'; c.classList.remove('hidden'); },
            selectDistrict: (v) => { document.getElementById('c-district').value = v; document.getElementById('district-results').classList.add('hidden'); document.getElementById('btn-clear-district').classList.remove('hidden'); },
            clearDistrict: () => { const i = document.getElementById('c-district'); i.value=''; document.getElementById('district-results').classList.add('hidden'); document.getElementById('btn-clear-district').classList.add('hidden'); i.focus(); },

            generateDateOptions: () => { const s = document.getElementById('c-date-select'); s.innerHTML = '<option value="" disabled selected>Elige una fecha...</option>'; const ad = state.config.shippingDays || []; if (!ad.length) return; const now = new Date(); const [ch, cm] = (state.config.updateTime || "18:00").split(':').map(Number); const cut = new Date(now); cut.setHours(ch, cm, 0, 0); for(let i=0;i<14;i++) { const f = new Date(now); f.setDate(now.getDate()+i); if(i===0 && now>cut) continue; const di = f.getDay(); if(ad.some(n => DAY_INDEX_MAP[n]===di)) { const val = `${DAY_NAMES_FULL[di]} ${f.getDate().toString().padStart(2,'0')}/${(f.getMonth()+1).toString().padStart(2,'0')}`; const lbl = `${DAY_NAMES_FULL[di]} ${f.getDate()} ${MONTH_NAMES[f.getMonth()]}`; const o = document.createElement('option'); o.value = val; o.innerText = lbl; s.appendChild(o); } } },
            onCourierChange: (c) => { const type = COURIER_TYPES[c] || "home"; state.selectedCourierType = type; state.selectedCourier = c; document.getElementById('dynamic-form-section').classList.remove('hidden'); const af = document.getElementById('fields-agency'), hf = document.getElementById('fields-home'); ['c-dni','c-agency','c-address','c-district'].forEach(id => document.getElementById(id).removeAttribute('required')); if(type === 'agency') { af.classList.remove('hidden'); hf.classList.add('hidden'); document.getElementById('c-dni').setAttribute('required','true'); const ag = document.getElementById('c-agency'); ag.setAttribute('required','true'); ag.value=""; app.clearAgency(); app.clearDistrict(); if(c.includes('Shalom')) ag.placeholder="Escribe para buscar sede..."; else ag.placeholder="Nombre de Agencia / Direcci칩n"; } else { af.classList.add('hidden'); hf.classList.remove('hidden'); document.getElementById('c-address').setAttribute('required','true'); document.getElementById('c-district').setAttribute('required','true'); app.clearAgency(); app.clearDistrict(); } app.validateForm(); },
            validateForm: () => { const btn = document.getElementById('btn-submit-order'), c = document.getElementById('c-courier-select').value, d = document.getElementById('c-date-select').value; if(c && d) btn.removeAttribute('disabled'); else btn.setAttribute('disabled','true'); },
            
            submitOrder: async (e) => { 
                e.preventDefault(); 
                app.toggleLoading(true); 
                const day = document.getElementById('c-date-select').value, name = document.getElementById('c-name').value, phone = document.getElementById('c-phone').value; 
                let data = { clientName: name, clientPhone: phone, courier: state.selectedCourier, shippingDate: day, createdAt: Date.now(), product: "N/A" }, wa = ""; 
                
                if (state.selectedCourierType === 'agency') { 
                    const dni = document.getElementById('c-dni').value, ag = document.getElementById('c-agency').value; 
                    data.clientDni = dni; data.clientAgency = ag; 
                    wa = `游닍 *NUEVO ENV칈O (AGENCIA)*\n\n游녻 ${name} | 游님 ${phone}\n游 DNI: ${dni}\n游끽 Agencia: ${ag}\n\n游뚴 ${state.selectedCourier}\n游늰 ${day}`; 
                } else { 
                    const ad = document.getElementById('c-address').value, ds = document.getElementById('c-district').value, rf = document.getElementById('c-ref').value; 
                    data.clientAddress = ad; data.clientDistrict = ds; data.clientRef = rf; 
                    wa = `游닍 *NUEVO ENV칈O (CASA)*\n\n游녻 ${name} | 游님 ${phone}\n游늸 ${ds}\n游 ${ad}\n游딬勇 Ref: ${rf}\n\n游뚴 ${state.selectedCourier}\n游늰 ${day}`; 
                } 
                
                try { 
                    await fetch(state.apiUrl, { method: "POST", body: JSON.stringify({ action: "saveOrder", merchantId: state.merchantId, data: data }) }); 
                    // Limpieza del formulario
                    document.getElementById('client-form').reset();
                    document.getElementById('dynamic-form-section').classList.add('hidden');
                    document.getElementById('btn-submit-order').setAttribute('disabled','true');
                    
                    window.open(`https://wa.me/51${state.config.whatsapp}?text=${encodeURIComponent(wa)}`, '_blank'); 
                } catch(e){} 
                app.toggleLoading(false); 
            },
            
            handleLogin: async (e) => { 
                e.preventDefault(); 
                const p = document.getElementById('auth-phone').value.trim();
                const pw = document.getElementById('auth-pass').value.trim();
                const err = document.getElementById('auth-error'); 
                app.toggleLoading(true); 
                try { 
                    const res = await fetch(state.apiUrl, { method: "POST", body: JSON.stringify({ action: "loginUser", data: { phone: p, password: pw } }) }); 
                    const json = await res.json(); 
                    if(json.status === 'success') { app.loginSuccess(json.user); return; } 
                    else { err.innerText = json.message || "Error desconocido"; err.classList.remove('hidden'); app.toggleLoading(false); return; } 
                } catch(e) { console.error(e); err.innerText = "Error de conexi칩n con el servidor"; err.classList.remove('hidden'); app.toggleLoading(false); } 
            },
            loginSuccess: (u) => { state.user = u; SafeStorage.setItem('app_current_user', JSON.stringify(u)); app.init(); },
            logout: () => { SafeStorage.removeItem('app_current_user'); state.user=null; state.merchantId=null; window.location.reload(); },
            
            adminLoadUsers: async () => { 
                const l = document.getElementById('admin-users-list'); 
                
                // Verificamos si tenemos el token guardado en el estado del usuario
                // state.user.token viene del cambio que hicimos en loginUser en el backend
                const secretToken = state.user && state.user.token ? state.user.token : null;

                if (!secretToken) {
                    l.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-red-400">久 Error de sesi칩n: Relogueate como Admin</td></tr>';
                    return;
                }

                l.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-slate-400"><i data-lucide="shield-check" class="inline w-4 h-4 mr-1"></i> Autorizando...</td></tr>'; 
                lucide.createIcons();

                app.toggleLoading(true);
                let u = []; 
                
                try { 
                    // ENVIAMOS EL TOKEN AUTOM츼TICAMENTE (Ya no pide prompt)
                    // Nota: Enviamos 'adminSecret' con el valor del token
                    const res = await fetch(`${state.apiUrl}?action=getUsers&adminSecret=${encodeURIComponent(secretToken)}`); 
                    const json = await res.json(); 
                    
                    if(json.users) {
                        u = json.users; 
                        // Renderizado de la tabla (Tu c칩digo visual original)
                        l.innerHTML = u.length ? u.map(user => `<tr class="bg-white border-b hover:bg-slate-50"><td class="px-6 py-4 font-bold text-slate-700">${escapeHtml(user.phone)}</td><td class="px-6 py-4"><span class="bg-indigo-100 text-indigo-800 text-xs font-bold px-2 py-1 rounded">${escapeHtml(user.plan||'Gratis')}</span></td><td class="px-6 py-4 text-xs text-slate-400">${user.createdAt ? new Date(user.createdAt).toLocaleDateString() : '-'}</td><td class="px-6 py-4 text-right flex gap-2 justify-end"><button onclick="app.adminResend('${escapeHtml(user.uid)}','${escapeHtml(user.phone)}')" class="text-indigo-600 text-xs font-bold hover:bg-indigo-50 px-2 py-1 rounded">Clave</button><select onchange="app.adminUpdatePlan('${escapeHtml(user.uid)}', this.value)" class="text-xs border rounded p-1 bg-slate-50 cursor-pointer outline-none"><option value="" disabled selected>Cambiar Plan</option><option value="Gratis">Gratis</option><option value="Pro">Pro</option><option value="Empresa">Empresa</option></select></td></tr>`).join('') : '<tr><td colspan="4" class="p-4 text-center">Base de datos vac칤a</td></tr>'; 
                    } else {
                        l.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-red-500 font-bold">久 Acceso Denegado (Token inv치lido)</td></tr>`;
                    }
                } catch(e){ 
                    console.error(e);
                    l.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-red-400">Error de conexi칩n</td></tr>';
                } 
                
                app.toggleLoading(false); 
            },
            
            adminUpdatePlan: (uid, newPlan) => { 
                app.showModal(`쮺onfirmas cambiar el plan a ${newPlan}?`, async () => {
                    app.toggleLoading(true); 
                    try { await fetch(state.apiUrl, { method: "POST", body: JSON.stringify({ action: "updateUserPlan", merchantId: uid, newPlan: newPlan }) }); } catch(e){} 
                    app.adminLoadUsers();
                    app.showToast('Plan actualizado');
                });
            },
            
            adminCreateUser: async (e) => { e.preventDefault(); const p = document.getElementById('admin-new-phone').value.trim(), pl = document.getElementById('admin-new-plan').value; app.toggleLoading(true); const np = Math.floor(1000+Math.random()*9000).toString(); try { await fetch(state.apiUrl, { method: "POST", body: JSON.stringify({ action: "registerUser", data: { phone: p, password: np, plan: pl } }) }); } catch(e){} window.open(`https://wa.me/51${p}?text=${encodeURIComponent(`游댏 Bienvenid@ (Plan ${pl})\n游님 User: ${p}\n游댐 Pass: *${np}*\nEntra: ${window.location.href}`)}`, '_blank'); document.getElementById('admin-new-phone').value=""; app.adminLoadUsers(); app.showToast('Usuario creado con 칠xito'); },
            
            adminResend: (uid, phone) => { 
                app.showModal(`Resetear clave para ${phone}?`, async () => {
                    app.toggleLoading(true); const np = Math.floor(1000+Math.random()*9000).toString(); 
                    try { await fetch(state.apiUrl, { method: "POST", body: JSON.stringify({ action: "changePassword", merchantId: uid, newPassword: np }) }); } catch(e){} 
                    window.open(`https://wa.me/51${phone}?text=${encodeURIComponent(`游댏 Recuperaci칩n\n游님 ${phone}\n游댐 Nueva: *${np}*`)}`, '_blank'); 
                    app.toggleLoading(false);
                    app.showToast('Contrase침a restablecida');
                });
            },
            
            saveConfig: async () => { 
                const btn = document.getElementById('btn-save-config');
                // Bloqueo de bot칩n para evitar doble clic
                btn.disabled = true;
                btn.innerHTML = '<i data-lucide="loader" class="w-4 h-4 animate-spin"></i> Guardando...';
                lucide.createIcons();

                app.toggleLoading(true); 
                state.config.merchantName = document.getElementById('inp-store-name').value; 
                state.config.whatsapp = document.getElementById('inp-whatsapp').value; 
                state.config.updateTime = document.getElementById('inp-time').value; 
                
                SafeStorage.setItem(`config_${state.user.uid}`, JSON.stringify(state.config)); 
                try { 
                    await fetch(state.apiUrl, { method: "POST", body: JSON.stringify({ action: "saveConfig", merchantId: state.user.uid, data: state.config }) }); 
                } catch(e){} 
                
                setTimeout(() => { 
                    app.toggleLoading(false); 
                    app.showToast('Configuraci칩n guardada'); 
                    // Restaurar bot칩n
                    btn.disabled = false;
                    btn.innerHTML = '<i data-lucide="save" class="w-4 h-4"></i> Guardar';
                    lucide.createIcons();
                }, 500); 
            },
            
            changePassword: async () => {
                const newPass = document.getElementById('inp-new-pass').value.trim();
                if (!newPass) return;
                app.showModal('쮼st치s seguro de cambiar tu contrase침a actual?', async () => {
                    app.toggleLoading(true);
                    try {
                        await fetch(state.apiUrl, { method: "POST", body: JSON.stringify({ action: "changePassword", merchantId: state.user.uid, newPassword: newPass }) });
                        document.getElementById('inp-new-pass').value = "";
                        app.showToast('Contrase침a actualizada');
                    } catch(e) {}
                    app.toggleLoading(false);
                });
            },
            
            copyLink: () => {
                const text = document.getElementById('share-link').innerText;
                const fallbackCopy = (t) => { const ta = document.createElement("textarea"); ta.value = t; document.body.appendChild(ta); ta.select(); document.execCommand("copy"); document.body.removeChild(ta); };
                if (navigator.clipboard && navigator.clipboard.writeText) navigator.clipboard.writeText(text).catch(() => fallbackCopy(text)); else fallbackCopy(text);
                app.showToast('Enlace copiado al portapapeles');
            },

            shareOnWhatsapp: () => {
                const url = document.getElementById('share-link').innerText;
                window.open(`https://wa.me/?text=${encodeURIComponent("Hola! Visita mi tienda de env칤os: " + url)}`, '_blank');
            },

            openClientLink: () => {
                const url = document.getElementById('share-link').innerText;
                window.open(url, '_blank');
            },
            
            // FUNCI칍N CORREGIDA: CARGA DE DATOS CON SINCRONIZACI칍N DE PLAN
            loadData: async () => { 
                app.toggleLoading(true); 
                
                // 1. Cargar Configuraci칩n (Igual que antes)
                state.config = { ...initialState }; 
                try { 
                    const res = await fetch(`${state.apiUrl}?action=getConfig&merchantId=${state.merchantId}`); 
                    const json = await res.json(); 
                    if (json.data) state.config = json.data; 
                } catch(e){ 
                    // Fallback a memoria local si falla la red
                    const local = SafeStorage.getItem(`config_${state.merchantId}`); 
                    if(local) state.config = JSON.parse(local); 
                } 
                
                // 2. NUEVO: Verificar estado real del usuario (Sincronizaci칩n Servidor -> Cliente)
                // Esto es vital para detectar si la prueba gratuita expir칩 seg칰n el Google Sheet
                if (state.user && state.merchantId && !state.isClientView) {
                    try {
                        const resStatus = await fetch(`${state.apiUrl}?action=getUserStatus&merchantId=${state.merchantId}`);
                        const jsonStatus = await resStatus.json();
                        
                        if (jsonStatus.status === 'success') {
                            // Si el plan en el servidor es diferente al local (ej. expir칩 el trial)
                            if (jsonStatus.plan !== state.user.plan) {
                                state.user.plan = jsonStatus.plan;
                                // Si volvi칩 a gratis, limpiamos la fecha de trial local
                                if (jsonStatus.plan === 'Gratis') delete state.user.trialEndsAt;
                                
                                // Guardamos el nuevo estado real
                                SafeStorage.setItem('app_current_user', JSON.stringify(state.user));
                                app.showToast('Tu plan se ha actualizado');
                            }
                        }
                    } catch(e) {
                        console.log("No se pudo verificar el estado del plan (Offline)");
                    }

                    // Actualizar textos en la interfaz (M칩vil y Escritorio)
                    document.querySelectorAll('.user-phone-display').forEach(el => el.innerText = state.user.phone);
                    if(state.user.plan) {
                        document.querySelectorAll('.user-plan-display').forEach(el => el.innerText = `PLAN ${state.user.plan.toUpperCase()}`);
                    }
                }

                // 3. Renderizado de Vistas
                if (state.isClientView) { 
                    app.renderClient(); 
                } else { 
                    app.renderDashboard(); 
                    // Importante: loadOrders usar치 el plan actualizado para decidir si muestra u oculta datos
                    app.loadOrders(); 
                } 
                
                app.toggleLoading(false); 
            },
            
            // --- NUEVA L칍GICA DE PEDIDOS (Filtrado & Selecci칩n) ---
            loadOrders: async () => { 
                const l = document.getElementById('orders-list'); 
                l.innerHTML = '<div class="text-center py-10 text-slate-400 flex flex-col items-center gap-2"><i data-lucide="loader" class="animate-spin w-6 h-6"></i> Cargando env칤os...</div>'; 
                lucide.createIcons();
                
                try { 
                    // Anti-cache param
                    const res = await fetch(`${state.apiUrl}?action=getOrders&merchantId=${state.merchantId}&_t=${Date.now()}`); 
                    const json = await res.json(); 
                    
                    // AQUI APLICAMOS EL FILTRO DE PLAN
                    // Revisar plan local (incluyendo 'Pro (Prueba)')
                    const userPlan = state.user ? state.user.plan : 'Gratis';
                    const isFree = userPlan === 'Gratis';
                    
                    let rawOrders = json.orders || [];
                    
                    // Si es gratis, NO CARGAR NADA en allOrders, pero guardar el total para el contador
                    if (isFree) {
                        state.allOrders = [];
                        state.hasHiddenOrders = true;
                        state.totalHiddenCount = rawOrders.length;
                    } else {
                        // Si es Pro/Empresa/Prueba, cargar todo
                        state.allOrders = rawOrders;
                        state.hasHiddenOrders = false;
                        state.totalHiddenCount = 0;
                    }
                    
                    state.selectedOrders.clear();
                    
                    // Actualizar contador en el aviso
                    const hiddenCountEl = document.getElementById('hidden-count');
                    if(hiddenCountEl) hiddenCountEl.innerText = state.totalHiddenCount;

                } catch(e){
                    state.allOrders = [];
                } 
                app.renderOrders();
            },

            renderOrders: () => {
                const l = document.getElementById('orders-list');
                const q = (document.getElementById('inp-search-orders').value || '').toLowerCase();
                const dSpec = document.getElementById('date-specific').value;
                
                const filtered = state.allOrders.filter(x => {
                    const txt = `${x.clientName} ${x.clientPhone} ${x.clientDistrict || ''} ${x.clientAgency || ''}`.toLowerCase();
                    if (!txt.includes(q)) return false;
                    
                    if (dSpec) {
                        const dateA = new Date(x.createdAt || x.date).toLocaleDateString();
                        const [y, m, d] = dSpec.split('-');
                        const dateB = new Date(y, m-1, d).toLocaleDateString();
                        if (dateA !== dateB) return false;
                    }
                    return true;
                });
                
                state.visibleOrders = filtered;

                if (!filtered.length) {
                    // Si no hay visibles...
                    if(state.hasHiddenOrders) {
                         // Si es por bloqueo de plan, limpiamos para que solo se vea el aviso
                         l.innerHTML = '';
                    } else {
                        // Si es plan pro y no hay datos (o filtro sin resultados)
                        l.innerHTML = '<div class="text-center py-10 text-slate-400">Sin env칤os encontrados</div>';
                    }
                } else {
                    l.innerHTML = filtered.map((x, idx) => {
                        const id = String(x.orderId || x.createdAt); // FORCE STRING ID
                        const isSel = state.selectedOrders.has(id);
                        const status = x.status || 'PENDIENTE';
                        let badgeClass = 'bg-yellow-500/20 text-yellow-400 border border-yellow-500/30';
                        if(status === 'ENVIADO') badgeClass = 'bg-secondary/20 text-secondary border border-secondary/30';

                        return `
                        <div class="bg-black/30 border ${isSel ? 'border-primary ring-1 ring-primary bg-primary/10' : 'border-white/10'} p-3 rounded-lg shadow-sm hover:border-white/20 transition group flex gap-3 items-start">
                            <div class="pt-1">
                                <input type="checkbox" onchange="app.toggleOrderSelection('${id}')" ${isSel ? 'checked' : ''} class="w-4 h-4 rounded border-slate-500 text-primary focus:ring-primary cursor-pointer bg-black/40">
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="flex justify-between font-bold text-slate-200">
                                    <span class="truncate text-white">${escapeHtml(x.clientName)}</span>
                                    <div class="flex items-center gap-2">
                                        <span class="text-[10px] font-bold px-2 py-0.5 rounded ${badgeClass}">${status}</span>
                                        <!-- Bot칩n de WhatsApp integrado en la cabecera -->
                                        <button onclick="app.sendClientSummary('${id}')" class="text-secondary hover:text-white hover:bg-secondary/20 p-1 rounded-full transition" title="Enviar resumen al cliente">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" class="w-4 h-4">
                                                <path d="M13.601 2.326A7.854 7.854 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.933 7.933 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.898 7.898 0 0 0 13.6 2.326zM7.994 14.521a6.573 6.573 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 0 1 4.66 1.931 6.557 6.557 0 0 1 1.928 4.66c-.004 3.639-2.961 6.592-6.592 6.592zm3.615-4.934c-.197-.099-1.17-.578-1.353-.646-.182-.065-.315-.099-.445.099-.133.197-.513.646-.627.775-.114.133-.232.148-.43.05-.197-.1-.836-.308-1.592-.985-.59-.525-.985-1.175-1.103-1.372-.114-.198-.011-.304.088-.403.087-.088.197-.232.296-.346.1-.114.133-.198.198-.33.065-.134.034-.248-.015-.347-.05-.099-.445-1.076-.612-1.47-.16-.389-.323-.335-.445-.34-.114-.007-.247-.007-.38-.007a.729.729 0 0 0-.529.247c-.182.198-.691.677-.691 1.654 0 .977.71 1.916.81 2.049.098.133 1.394 2.132 3.383 2.992.47.205.84.326 1.129.418.475.152.904.129 1.246.08.38-.058 1.171-.48 1.338-.943.164-.464.164-.86.114-.943-.049-.084-.182-.133-.38-.232z"/>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                                <div class="text-xs text-slate-400 mt-1 flex flex-wrap gap-x-3 gap-y-1">
                                    <span class="flex items-center gap-1"><i data-lucide="calendar" class="w-3 h-3 text-primary"></i> ${escapeHtml(x.shippingDate)}</span>
                                    <span class="flex items-center gap-1"><i data-lucide="truck" class="w-3 h-3 text-primary"></i> ${escapeHtml(x.courier)}</span>
                                </div>
                                <div class="text-xs text-slate-300 mt-2 font-medium border-t border-white/5 pt-2">
                                    ${x.clientAgency ? `游끽 ${escapeHtml(x.clientAgency)}` : `游 ${escapeHtml(x.clientDistrict)} - ${escapeHtml(x.clientAddress)}`}
                                </div>
                            </div>
                        </div>
                    `}).join('');
                }

                // Mostrar/Ocultar aviso de plan limitado
                const warningEl = document.getElementById('plan-limit-warning');
                // Mostrar SIEMPRE si hay ocultos por plan gratis
                if (state.hasHiddenOrders) { 
                    warningEl.classList.remove('hidden');
                } else {
                    warningEl.classList.add('hidden');
                }
                
                lucide.createIcons();
            },

            toggleOrderSelection: (id) => {
                const strId = String(id); 
                if (state.selectedOrders.has(strId)) state.selectedOrders.delete(strId);
                else state.selectedOrders.add(strId);
                app.renderOrders(); 
            },
            
            toggleAllSelection: () => {
                const allSelected = state.visibleOrders.every(x => state.selectedOrders.has(String(x.orderId || x.createdAt)));
                if (allSelected) state.visibleOrders.forEach(x => state.selectedOrders.delete(String(x.orderId || x.createdAt)));
                else state.visibleOrders.forEach(x => state.selectedOrders.add(String(x.orderId || x.createdAt)));
                app.renderOrders();
            },
            
            deleteSelected: () => {
                if (state.selectedOrders.size === 0) return app.showToast('Selecciona al menos un env칤o');
                app.showModal(`쮼liminar ${state.selectedOrders.size} env칤os?`, async () => {
                    app.toggleLoading(true);
                    const ids = Array.from(state.selectedOrders);
                    try { await fetch(state.apiUrl, { method: "POST", body: JSON.stringify({ action: "deleteOrders", merchantId: state.merchantId, orderIds: ids }) }); app.showToast('Env칤os eliminados'); app.loadOrders(); } catch(e) {}
                    app.toggleLoading(false);
                });
            },
            
            updateBatchStatus: () => {
                if (state.selectedOrders.size === 0) return app.showToast('Selecciona env칤os');
                app.openStatusMenu();
            },

            exportExcel: () => {
                const list = state.visibleOrders;
                if(!list.length) return app.showToast('No hay datos');
                let csvContent = "\uFEFFFecha,Courier,Cliente,Tel칠fono,Destino,Referencia/DNI,Estado\n";
                list.forEach(x => {
                    const destino = x.clientAgency ? `AGENCIA: ${x.clientAgency}` : `CASA: ${x.clientDistrict} - ${x.clientAddress}`;
                    const ref = x.clientAgency ? `DNI: ${x.clientDni}` : `REF: ${x.clientRef}`;
                    const row = [ x.shippingDate, x.courier, x.clientName.replace(/,/g, ''), x.clientPhone, destino.replace(/,/g, ''), ref.replace(/,/g, ''), x.status || 'PENDIENTE' ].join(",");
                    csvContent += row + "\n";
                });
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", `envios_${new Date().toLocaleDateString()}.csv`);
                document.body.appendChild(link); link.click(); document.body.removeChild(link);
                app.showToast('Descargando Excel...');
            },

            printLabels: () => {
                const targets = state.selectedOrders.size > 0 ? state.allOrders.filter(x => state.selectedOrders.has(String(x.orderId || x.createdAt))) : state.visibleOrders;
                if(!targets.length) return app.showToast('Nada para imprimir');
                app.doPrint(targets);
            },

            doPrint: (list) => {
                if(!list.length) return;
                const area = document.getElementById('print-area');
                const shopName = state.config.merchantName || "Mi Tienda";
                
                area.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 15px;">
                        ${list.map(x => `
                            <div style="border: 1px solid #ddd; padding: 20px; page-break-inside: avoid; font-family: 'Segoe UI', sans-serif; border-radius: 12px; background: white; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 15px;">
                                    <div style="font-size: 10px; color: #888; text-transform: uppercase; letter-spacing: 1px;">Remitente</div>
                                    <div style="font-weight: bold; font-size: 14px; color: #333;">${escapeHtml(shopName)}</div>
                                </div>
                                <div style="margin-bottom: 20px;">
                                    <p style="margin: 0; font-size: 10px; color: #a44; font-weight: bold; text-transform: uppercase; letter-spacing: 0.5px;">PARA:</p>
                                    <h2 style="margin: 5px 0; font-size: 20px; font-weight: 800; color: #000; line-height: 1.2;">${escapeHtml(x.clientName).toUpperCase()}</h2>
                                    <p style="margin: 0; font-size: 14px; color: #555; font-family: monospace;">${escapeHtml(x.clientPhone)}</p>
                                </div>
                                <div style="margin-bottom: 20px;">
                                    <p style="margin: 0; font-size: 10px; color: #a44; font-weight: bold; text-transform: uppercase; letter-spacing: 0.5px;">DESTINO:</p>
                                    <p style="margin: 5px 0 2px 0; font-size: 13px; color: #333;"><strong>${x.clientAgency ? 'DNI/CE:' : 'REF:'}</strong> ${x.clientAgency ? x.clientDni : x.clientRef}</p>
                                    <p style="margin: 0; font-size: 14px; color: #444; line-height: 1.4;">${x.clientAgency ? `<strong>Agencia:</strong> ${escapeHtml(x.clientAgency)}` : `${escapeHtml(x.clientAddress)}<br/><span style="color:#666">${escapeHtml(x.clientDistrict)}</span>`}</p>
                                </div>
                                <div style="border-top: 1px solid #eee; padding-top: 12px; display: flex; align-items: center; gap: 8px; color: #555;">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="3" width="15" height="13"></rect><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon><circle cx="5.5" cy="18.5" r="2.5"></circle><circle cx="18.5" cy="18.5" r="2.5"></circle></svg>
                                    <span style="font-size: 12px; font-weight: bold; text-transform: uppercase;">${escapeHtml(x.courier)}</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                window.print();
                setTimeout(() => { area.innerHTML = ''; }, 1000);
            },

            toggleConfigItem: (k, v) => { if (state.config[k].includes(v)) state.config[k] = state.config[k].filter(i => i !== v); else state.config[k].push(v); app.renderDashboard(); },
            renderDashboard: () => { document.getElementById('inp-store-name').value = state.config.merchantName || ''; document.getElementById('inp-whatsapp').value = state.config.whatsapp || ''; document.getElementById('inp-time').value = state.config.updateTime || ''; document.getElementById('container-couriers').innerHTML = ALL_COURIERS.map(c => `<div onclick="app.toggleConfigItem('couriers','${c}')" class="cursor-pointer bg-black/30 border border-white/10 rounded p-2 text-xs font-bold flex items-center gap-2 select-none ${state.config.couriers.includes(c)?'border-primary text-primary bg-primary/10':'text-slate-400 hover:bg-white/5'} transition"><div class="w-3 h-3 border rounded flex items-center justify-center ${state.config.couriers.includes(c)?'bg-primary border-primary':'border-slate-500'}">${state.config.couriers.includes(c)?'<i data-lucide="check" class="w-2 h-2 text-white"></i>':''}</div>${c}</div>`).join(''); document.getElementById('container-days').innerHTML = ALL_DAYS.map(d => `<button onclick="app.toggleConfigItem('shippingDays','${d}')" class="px-3 py-1 rounded text-xs font-bold border transition ${state.config.shippingDays.includes(d)?'bg-primary text-white border-primary shadow-neon':'bg-black/30 text-slate-400 border-white/10 hover:bg-white/5'}">${d}</button>`).join(''); lucide.createIcons(); },
            renderClient: () => { document.getElementById('client-title').innerText = state.config.merchantName || "Tienda"; document.getElementById('client-time').innerText = state.config.updateTime || "--:--"; const cl = state.config.couriers || []; const cs = document.getElementById('c-courier-select'); if (cl.length) cs.innerHTML = '<option value="" disabled selected>Elige una opci칩n...</option>' + cl.map(c => `<option value="${c}">${c}</option>`).join(''); else cs.innerHTML = '<option value="" disabled selected>Sin couriers</option>'; app.generateDateOptions(); app.loadExternalLists(); lucide.createIcons(); },
            setTab: (t) => { ['config','share','orders'].forEach(x => { document.getElementById(`tab-${x}`).classList.add('hidden'); document.getElementById(`nav-${x}`).className = "nav-item p-3 rounded-lg text-sm font-bold text-left flex gap-3 items-center text-slate-400 hover:bg-white/5 hover:text-white transition whitespace-nowrap"; }); document.getElementById(`tab-${t}`).classList.remove('hidden'); document.getElementById(`nav-${t}`).className = "nav-item p-3 rounded-lg text-sm font-bold bg-primary/10 text-primary border border-primary/20 text-left flex gap-3 items-center transition shadow-neon"; if(t==='share') document.getElementById('share-link').innerText=`${window.location.origin}${window.location.pathname}?merchant=${state.user.uid}`; },
            init: () => {
                const p = new URLSearchParams(window.location.search); const mid = p.get('merchant');
                document.querySelectorAll('[id^="view-"]').forEach(el => el.classList.add('hidden'));
                if (mid) { state.isClientView=true; state.merchantId=mid; document.getElementById('view-client').classList.remove('hidden'); app.loadData(); }
                else { const u = JSON.parse(SafeStorage.getItem('app_current_user')); if(u) { state.user=u; if(u.isAdmin) { document.getElementById('view-admin').classList.remove('hidden'); app.adminLoadUsers(); } else { state.merchantId=u.uid; document.getElementById('view-dashboard').classList.remove('hidden'); app.setTab('config'); app.loadData(); } } else { document.getElementById('view-auth').classList.remove('hidden'); } }
                lucide.createIcons();
            }
        };
        app.init();
    </script>
</body>
</html>
