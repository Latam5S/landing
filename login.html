<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <link rel="icon" type="image/x-icon" href="favicon.ico" />
  
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Latam5S</title>
    <meta name="description" content="La solución #1 para vendedores. Convierte chats en rótulos de envío y valida direcciones, DNI y agencias sin errores.">
    
    <meta property="og:title" content="Latam5S">
    <meta property="og:description" content="La solución #1 para emprendedores. Convierte chats en rótulos de envío y valida direcciones, DNI y agencias sin errores.">
    <meta property="og:image" content="brand.png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:url" content="https://complicidad.github.io/landing/login">
    <meta property="og:type" content="website">

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Latam5S">
    <meta name="twitter:description" content="La solución #1 para emprendedores. Convierte chats en rótulos de envío y valida direcciones, DNI y agencias sin errores.">
    <meta name="twitter:image" content="brand.png">

    <link rel="canonical" href="https://complicidad.github.io/landing/login" />
    
    <!-- Fuente Quicksand -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="preconnect" href="https://script.google.com">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
  
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',     /* Azul eléctrico */
                        primary_glow: '#60A5FA',
                        secondary: '#10B981',   /* Verde éxito */
                        dark_bg: '#020617',     /* Negro profundo Slate-950 */
                        card_bg: '#0f172a',     /* Slate-900 */
                        glass: 'rgba(255, 255, 255, 0.03)',
                        glass_border: 'rgba(255, 255, 255, 0.08)',
                    },
                    fontFamily: {
                        sans: ['Quicksand', 'sans-serif'],
                    },
                    boxShadow: {
                        'neon': '0 0 20px rgba(59, 130, 246, 0.15)',
                        'neon-green': '0 0 20px rgba(16, 185, 129, 0.15)',
                    },
                    animation: {
                        'float': 'float 6s ease-in-out infinite',
                        'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-20px)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body { 
            font-family: "Quicksand", sans-serif; 
            background-color: #020617;
            color: #e2e8f0; /* Slate-200 */
        }
        
        /* Glassmorphism Utilities - UNIFICADO Y CONSISTENTE */
        .glass-panel {
            background: rgba(15, 23, 42, 0.7); /* Base oscura sólida */
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-right: 1px solid rgba(255, 255, 255, 0.08);
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        }

        /* Glassmorphism Utilities - AHORA SÓLIDO (OPACO) */
        .glass-card {
            /* CAMBIO: Usamos colores HEX sólidos (#1e293b y #0f172a) en lugar de RGBA con transparencia */
            background: linear-gradient(145deg, #1e293b 0%, #0f172a 100%);
            
            /* El backdrop-filter ya no es necesario si el fondo es opaco, pero no daña dejarlo */
            /* backdrop-filter: blur(16px); */
            
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        /* Scrollbar Personalizada Dark */
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 2px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Modals & Sheets */
        .modal-enter { opacity: 0; transform: scale(0.95); }
        .modal-enter-active { opacity: 1; transform: scale(1); transition: opacity 0.2s, transform 0.2s; }

        /* Animations */
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        .slide-up { animation: slideUp 0.4s ease-out forwards; opacity: 0; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Busca esto en login.html y reemplázalo */
        @media print {
            /* CORRECCIÓN: Agregamos !important para anular el bg-dark_bg de Tailwind */
            body { 
                background-color: white !important; 
                color: black !important; 
                height: auto !important; /* Evita que ocupe el 100vh oscuro */
                overflow: visible !important;
            }
            
            /* Aseguramos que el fondo no se cuele por ningún lado */
            html { background-color: white !important; }
        
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            
            #print-area { 
                position: absolute; 
                left: 0; 
                top: 0; 
                width: 100%; 
                margin: 0; 
                padding: 0; 
                background-color: white !important; /* Fondo blanco forzado */
                display: block !important; 
                z-index: 9999; 
            }
            .no-print { display: none !important; }
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
        }

        /* Canvas Background */
        #particles-js {
            position: fixed;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            z-index: 0; /* Detrás de todo */
            pointer-events: none; /* Click-through */
        }

        .logo-text-gradient {
            /* Degradado horizontal para el texto Latam5S (simula las redes sociales) */
            background: linear-gradient(to right, #3B82F6, #60A5FA, #2DD4BF, #10B981); 
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text; /* Compatible con otros navegadores */
            color: transparent; /* Fallback */
        }
        
    </style>
</head>
<body class="bg-dark_bg text-slate-200 h-[100dvh] overflow-hidden flex flex-col selection:bg-primary selection:text-white relative">

    <!-- OVERLAY CARGA -->
    <div id="loading-overlay" class="fixed inset-0 bg-dark_bg/95 z-[9999] flex flex-col items-center justify-center transition-opacity duration-300 hidden pointer-events-none opacity-0 backdrop-blur-sm">
        <div class="relative">
            <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-primary shadow-neon"></div>
            <div class="absolute top-0 left-0 h-16 w-16 rounded-full border-t-2 border-b-2 border-primary opacity-50 animate-pulse"></div>
        </div>
        <p id="loading-text" class="text-primary font-bold mt-6 animate-pulse tracking-widest text-xs uppercase">Conectando...</p>
    </div>

    <div id="generic-modal" class="fixed inset-0 z-[100] bg-black/80 backdrop-blur-md hidden flex items-center justify-center transition-opacity duration-200 opacity-0" onclick="if(event.target === this) app.closeModal()">
        <div class="glass-card rounded-3xl p-8 max-w-sm w-full mx-4 transform scale-95 transition-transform duration-200 border border-white/10 shadow-2xl relative">
            <div id="modal-content"></div>
        </div>
    </div>
  
    <!-- TOAST NOTIFICATION -->
    <div id="toast" class="fixed top-4 left-1/2 -translate-x-1/2 z-[100] glass-card border-l-4 border-secondary text-white px-6 py-3 rounded-xl shadow-neon-green flex items-center gap-3 transition-all duration-300 -translate-y-20 opacity-0">
        <i data-lucide="check-circle" class="w-5 h-5 text-secondary"></i>
        <span id="toast-msg" class="font-bold text-sm">Acción completada</span>
    </div>

    <!-- ÁREA DE IMPRESIÓN -->
    <div id="print-area" class="hidden bg-white p-4 text-black"></div>

    <!-- VISTA AUTH (Login) -->
    <div id="view-auth" class="flex-1 h-full flex flex-col items-center justify-center p-4 hidden overflow-y-auto no-print relative z-10">
        <div class="glass-card w-full max-w-md rounded-3xl shadow-2xl overflow-hidden slide-up my-auto relative z-10">
            <div class="bg-card_bg/50 p-8 text-center relative overflow-hidden border-b border-white/5">
                <div class="absolute top-0 right-0 p-4 opacity-5"><i data-lucide="box" class="w-32 h-32 text-white"></i></div>
                <div class="relative z-10">
                    <h1 class="text-3xl font-bold text-white tracking-tight logo-text-gradient">Latam5S</h1>
                    <div id="connection-status" class="inline-flex items-center gap-2 bg-white/5 px-4 py-1.5 rounded-full text-[10px] font-bold text-secondary mt-3 border border-white/5">
                        <span class="w-2 h-2 rounded-full bg-secondary animate-pulse"></span> Sistema Seguro
                    </div>
                </div>
            </div>

            <div class="p-8">
                <form onsubmit="app.handleLogin(event)" class="space-y-6">
                    <div class="space-y-2">
                        <label class="block text-xs font-bold text-primary uppercase tracking-wider ml-1">WhatsApp</label>
                        <input id="auth-phone" type="tel" required placeholder="Ingresa tu número" class="w-full bg-black/30 border border-white/10 text-white rounded-xl p-4 outline-none focus:border-primary focus:ring-1 focus:ring-primary transition placeholder-slate-600">
                    </div>
                    <div class="space-y-2">
                        <label class="block text-xs font-bold text-primary uppercase tracking-wider ml-1">Contraseña</label>
                        <input id="auth-pass" type="password" required placeholder="Ingresa tu contraseña" class="w-full bg-black/30 border border-white/10 text-white rounded-xl p-4 outline-none focus:border-primary focus:ring-1 focus:ring-primary transition placeholder-slate-600">
                    </div>
                    <button type="submit" class="w-full bg-primary hover:bg-blue-600 text-white font-bold py-4 rounded-xl shadow-neon transition active:scale-95 flex justify-center items-center gap-2 mt-4">
                        Iniciar Sesión
                    </button>
                </form>
                <p id="auth-error" class="text-red-400 text-xs text-center mt-4 font-bold hidden bg-red-500/10 py-2 rounded-lg border border-red-500/20"></p>
                <div class="mt-8 text-center text-xs text-slate-500 pt-4 border-t border-white/5">
                    Acceso exclusivo para socios registrados.
                </div>
            </div>
        </div>
        <div class="mt-8 text-[10px] font-bold text-slate-500 uppercase tracking-widest">
            Powered by Latam5S
        </div>
    </div>

    <!-- VISTA ADMIN -->
    <div id="view-admin" class="flex-1 flex flex-col h-full hidden no-print overflow-hidden z-10">
        <header class="glass-panel p-4 flex justify-between items-center shadow-lg z-20">
            <div class="flex items-center gap-3">
                <div class="bg-primary/20 p-2 rounded-lg text-primary border border-primary/20"><i data-lucide="shield" class="w-5 h-5"></i></div>
                <h1 class="font-bold text-lg text-white">Panel Admin</h1>
            </div>
            <button onclick="app.logout()" class="text-xs font-bold bg-white/5 hover:bg-white/10 text-white px-4 py-2 rounded-lg transition border border-white/5">Salir</button>
        </header>
        <main class="flex-1 p-4 md:p-8 overflow-y-auto max-w-5xl mx-auto w-full space-y-6 pb-20">
            <div class="glass-card p-6 rounded-3xl">
                <h2 class="text-lg font-bold text-white mb-4 flex items-center gap-2"><i data-lucide="user-plus" class="w-5 h-5 text-primary"></i> Alta de Emprendedor</h2>
                <form onsubmit="app.adminCreateUser(event)" class="flex flex-col md:flex-row gap-4 items-end">
                    <div class="flex-1 w-full">
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-2">WhatsApp del Cliente</label>
                        <input id="admin-new-phone" type="tel" required placeholder="Ej: 999888777" class="w-full bg-black/30 border border-white/10 text-white rounded-xl p-4 outline-none focus:border-primary transition">
                    </div>
                    <div class="w-full md:w-40">
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Plan</label>
                        <select id="admin-new-plan" class="w-full bg-black/30 border border-white/10 text-white rounded-xl p-4 outline-none focus:border-primary cursor-pointer">
                            <option value="Gratis" class="bg-card_bg">Gratis</option>
                            <option value="Pro" class="bg-card_bg">Pro</option>
                            <option value="Empresa" class="bg-card_bg">Empresa</option>
                        </select>
                    </div>
                    <button type="submit" class="w-full md:w-auto bg-primary text-white px-6 py-4 rounded-xl font-bold hover:bg-blue-600 transition flex items-center justify-center gap-2 shadow-neon">
                        <i data-lucide="zap" class="w-4 h-4"></i> Crear
                    </button>
                </form>
            </div>
            <div class="glass-card rounded-3xl overflow-hidden">
                <div class="p-6 border-b border-white/5 flex justify-between items-center">
                    <h2 class="text-lg font-bold text-white">Usuarios Registrados</h2>
                    <button onclick="app.adminLoadUsers()" class="p-2 hover:bg-white/5 rounded-full text-slate-400 hover:text-white transition"><i data-lucide="refresh-cw" class="w-4 h-4"></i></button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-slate-300">
                        <thead class="bg-black/20 text-slate-400 uppercase text-xs font-bold">
                            <tr><th class="px-6 py-4">WhatsApp</th><th class="px-6 py-4">Plan</th><th class="px-6 py-4">Fecha Alta</th><th class="px-6 py-4 text-right">Acciones</th></tr>
                        </thead>
                        <tbody id="admin-users-list" class="divide-y divide-white/5"></tbody>
                    </table>
                </div>
            </div>
            <div class="text-center text-[10px] text-slate-500 mt-8 uppercase font-bold tracking-widest">
                Powered by Latam5S
            </div>
        </main>
    </div>

    <!-- VISTA DASHBOARD (EMPRENDEDOR) -->
    <div id="view-dashboard" class="flex-1 flex flex-col md:flex-row h-full hidden no-print overflow-hidden z-10">
        <aside class="w-full md:w-72 glass-panel md:border-r border-b border-white/5 flex flex-col shadow-lg z-20 flex-shrink-0">
            <!-- HEADER ADAPTATIVO -->
            <div class="p-4 md:p-6 border-b border-white/5 flex justify-between items-center bg-black/20">
                <div class="flex items-center gap-3">
                    <div class="bg-secondary/10 p-2 rounded-xl text-secondary border border-secondary/20 shadow-neon-green"><i data-lucide="package" class="w-6 h-6"></i></div>
                    <div>
                        <h1 class="font-bold text-lg text-white leading-tight">Mi Panel</h1>
                        <p class="text-xs text-slate-400 hidden md:block">Emprendedor</p>
                    </div>
                </div>
                <!-- CONTROLES SOLO MÓVIL -->
                <div class="flex items-center gap-3 md:hidden">
                    <div class="text-right">
                        <p class="user-phone-display text-xs font-bold text-slate-300">...</p>
                        <p class="user-plan-display text-[10px] font-bold text-primary bg-primary/10 px-2 py-0.5 rounded border border-primary/20">...</p>
                    </div>
                    <button onclick="app.logout()" class="bg-red-500/10 text-red-400 p-2 rounded-lg hover:bg-red-500/20 transition border border-red-500/20">
                        <i data-lucide="log-out" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>

            <nav class="flex md:flex-col p-2 gap-1 overflow-x-auto no-scrollbar">
                <button onclick="app.setTab('config')" id="nav-config" class="nav-item p-3 rounded-lg text-sm font-bold text-left flex gap-3 items-center text-slate-400 hover:bg-white/5 hover:text-white transition whitespace-nowrap"><i data-lucide="settings" class="w-4 h-4"></i> Configurar</button>
                <button onclick="app.setTab('share')" id="nav-share" class="nav-item p-3 rounded-lg text-sm font-bold text-left flex gap-3 items-center text-slate-400 hover:bg-white/5 hover:text-white transition whitespace-nowrap"><i data-lucide="share-2" class="w-4 h-4"></i> Compartir</button>
                <button onclick="app.setTab('orders')" id="nav-orders" class="nav-item p-3 rounded-lg text-sm font-bold text-left flex gap-3 items-center text-slate-400 hover:bg-white/5 hover:text-white transition whitespace-nowrap"><i data-lucide="truck" class="w-4 h-4"></i> Envíos</button>
            </nav>
            
            <!-- FOOTER ESCRITORIO -->
            <div class="mt-auto p-4 border-t border-white/5 hidden md:block bg-black/20">
                <div class="flex items-center gap-3 mb-4">
                    <div class="w-10 h-10 rounded-full bg-white/5 flex items-center justify-center text-slate-400 border border-white/5"><i data-lucide="phone" class="w-5 h-5"></i></div>
                    <div class="overflow-hidden">
                        <p class="user-phone-display text-sm font-bold text-white truncate">...</p>
                        <p class="user-plan-display text-[10px] font-bold text-primary uppercase tracking-wide bg-primary/10 px-2 py-0.5 rounded w-fit mt-1 border border-primary/20">PLAN GRATIS</p>
                    </div>
                </div>
                <button onclick="app.logout()" class="w-full text-red-400 text-xs font-bold hover:bg-red-500/10 py-3 rounded-xl transition border border-transparent hover:border-red-500/20">Cerrar Sesión</button>
                <div class="text-center text-[9px] text-slate-500 mt-4 uppercase font-bold tracking-widest">
                    Powered by Latam5S
                </div>
            </div>
        </aside>
        
        <!-- Contenedor Principal -->
        <main class="flex-1 relative overflow-hidden flex flex-col">
            <!-- Decoración de fondo sutil -->
            <div class="absolute top-0 left-0 w-full h-full overflow-hidden pointer-events-none opacity-20">
                <div class="absolute top-[10%] right-[10%] w-64 h-64 bg-primary/30 rounded-full blur-[100px]"></div>
            </div>
            
            <!-- PESTAÑA CONFIGURACIÓN (Aplicado glass-card unificado, ancho completo) -->
            <div id="tab-config" class="tab-content w-full h-full overflow-y-auto p-4 md:p-8 hidden no-scrollbar z-10">
                <div class="max-w-7xl mx-auto slide-up pb-32">
                    <div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold text-white">Configuración</h2><button id="btn-save-config" onclick="app.saveConfig()" class="bg-primary text-white px-6 py-2.5 rounded-xl text-sm font-bold hover:bg-blue-600 transition flex gap-2 shadow-neon"><i data-lucide="save" class="w-4 h-4"></i> Guardar</button></div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Columna Izquierda: Datos y Seguridad -->
                        <div class="space-y-6">
                            <div class="glass-card p-6 rounded-3xl space-y-5">
                                <h3 class="font-bold text-primary uppercase text-xs tracking-wider mb-4 border-b border-white/5 pb-2">Datos Públicos</h3>
                                <div><label class="text-xs font-bold text-slate-400 uppercase mb-1 block">Nombre Emprendimiento</label><input id="inp-store-name" oninput="app.updateConfigInput('merchantName', this.value)" class="w-full bg-black/30 border border-white/10 rounded-xl p-4 text-white outline-none focus:border-primary transition"></div>
                              <div>
                                  <label class="text-xs font-bold text-slate-400 uppercase mb-1 block">WhatsApp Emprendimiento</label>
                                  <div class="relative">
                                      <span class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-500 font-bold text-sm">+51</span>
                                      <input id="inp-whatsapp" 
                                             type="tel" 
                                             maxlength="9" 
                                             placeholder="9..." 
                                             inputmode="numeric"
                                             oninput="app.formatWhatsapp(this)"
                                             class="w-full bg-black/30 border border-white/10 rounded-xl py-4 pr-4 pl-12 text-white outline-none focus:border-primary transition font-mono tracking-wider">
                                  </div>
                                  <p class="text-[10px] text-slate-500 mt-1 pl-1">Solo números, debe empezar con 9.</p>
                              </div>
                            </div>
                            
                            <div class="glass-card p-6 rounded-3xl">
                                <h3 class="font-bold text-primary uppercase text-xs tracking-wider mb-4 flex items-center gap-2 border-b border-white/5 pb-2"><i data-lucide="lock" class="w-3 h-3"></i> Seguridad</h3>
                                <div class="flex gap-3 items-end">
                                    <div class="flex-1">
                                        <label class="text-xs font-bold text-slate-400 uppercase mb-1 block">Nueva Contraseña</label>
                                        <input id="inp-new-pass" type="password" class="w-full bg-black/30 border border-white/10 rounded-xl p-4 text-white outline-none focus:border-primary transition">
                                    </div>
                                    <button id="btn-change-pass" onclick="app.changePassword()" class="bg-indigo-600 text-white px-6 py-3 rounded-xl text-sm font-bold hover:bg-indigo-700 transition h-[56px] shadow-lg">Actualizar</button>
                                </div>
                            </div>
                        </div>

                        <!-- Columna Derecha: Logística (Full Height) -->
                        <div class="flex flex-col">
                            <div class="glass-card p-6 rounded-3xl space-y-5 h-full relative">
                                <h3 class="font-bold text-primary uppercase text-xs tracking-wider mb-4 border-b border-white/5 pb-2">
                                    Logística <span class="text-red-400">*</span>
                                </h3>

                                <div>
                                    <label class="text-xs font-bold text-slate-400 uppercase block mb-2">Couriers Habilitados <span class="text-red-500">*</span></label>
                                    <div id="container-couriers" class="grid grid-cols-2 gap-2"></div>
                                </div>

                                <div>
                                    <label class="text-xs font-bold text-slate-400 uppercase block mt-2 mb-2">Días de Despacho <span class="text-red-500">*</span></label>
                                    <div id="container-days" class="flex flex-wrap gap-2"></div>
                                </div>

                                <div class="grid grid-cols-2 gap-4 mt-2">
                                    <div>
                                        <label class="text-xs font-bold text-slate-400 uppercase block mb-1">Hora Corte <span class="text-red-500">*</span></label>
                                        <div class="flex items-center gap-2 bg-black/20 p-3 rounded-xl border border-white/5">
                                            <i data-lucide="clock" class="w-4 h-4 text-primary"></i>
                                            <input type="time" id="inp-time" onchange="app.updateConfigInput('updateTime', this.value); app.checkConfigStatus()" class="bg-transparent text-sm text-white outline-none w-full cursor-pointer">
                                        </div>
                                    </div>

                                    <div>
                                        <label class="text-xs font-bold text-slate-400 uppercase block mb-1" title="Días de anticipación mínimos para el pedido">Anticipación (Días) <span class="text-red-500">*</span></label>
                                        <div class="flex items-center gap-2 bg-black/20 p-3 rounded-xl border border-white/5">
                                            <i data-lucide="calendar-clock" class="w-4 h-4 text-secondary"></i>
                                            <input type="number" id="inp-gap" min="0" max="30" placeholder="0" 
                                                   oninput="app.updateConfigInput('updateGap', this.value); app.checkConfigStatus()" 
                                                   class="bg-transparent text-sm text-white outline-none w-full placeholder-slate-600">
                                        </div>
                                    </div>
                                </div>

                                <p class="text-[10px] text-slate-500 leading-tight mt-2">
                                    <span class="text-primary">*</span> La "Anticipación" define cuántos días mínimos de margen necesitas para preparar el pedido antes del día de envío.
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="text-center text-[10px] text-slate-500 uppercase font-bold tracking-widest pt-8">
                        Powered by Latam5S
                    </div>
                </div>
            </div>
            
            <!-- PESTAÑA COMPARTIR (Ya tenía glass-card, se mantiene igual) -->
            <div id="tab-share" class="tab-content w-full h-full overflow-y-auto p-4 hidden no-scrollbar z-10">
                <div class="min-h-full flex flex-col items-center justify-center py-8 pb-32">
                    <div class="glass-card p-8 rounded-3xl text-center max-w-md w-full slide-up border border-white/10">
                        <div class="w-20 h-20 bg-secondary/10 rounded-full flex items-center justify-center mx-auto mb-6 text-secondary border border-secondary/20 shadow-neon-green"><i data-lucide="share-2" class="w-10 h-10"></i></div>
                        
                        <h2 class="text-2xl font-bold mb-4 text-white">¡Listo para compartir!</h2>
                        <p class="text-slate-400 text-sm mb-8 leading-relaxed">
                            Tu formulario personalizado está activo. Comparte el siguiente enlace con tus clientes.
                        </p>

                        <div class="bg-black/30 p-4 rounded-xl border border-white/10 mb-8 break-all font-mono text-primary select-all cursor-pointer hover:bg-black/40 transition" onclick="app.copyLink()"><code id="share-link" class="text-xs font-bold">...</code></div>
                        
                        <div class="space-y-4">
                            <button onclick="app.copyLink()" class="w-full bg-primary text-white py-4 rounded-xl font-bold hover:bg-blue-600 transition shadow-neon">Copiar Link</button>
                            <button onclick="app.shareOnWhatsapp()" class="w-full bg-secondary/20 text-secondary py-4 rounded-xl font-bold hover:bg-secondary/30 transition flex items-center justify-center gap-3 border border-secondary/20">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                                  <path d="M13.601 2.326A7.854 7.854 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.933 7.933 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.898 7.898 0 0 0 13.6 2.326zM7.994 14.521a6.573 6.573 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 0 1 4.66 1.931 6.557 6.557 0 0 1 1.928 4.66c-.004 3.639-2.961 6.592-6.592 6.592zm3.615-4.934c-.197-.099-1.17-.578-1.353-.646-.182-.065-.315-.099-.445.099-.133.197-.513.646-.627.775-.114.133-.232.148-.43.05-.197-.1-.836-.308-1.592-.985-.59-.525-.985-1.175-1.103-1.372-.114-.198-.011-.304.088-.403.087-.088.197-.232.296-.346.1-.114.133-.198.198-.33.065-.134.034-.248-.015-.347-.05-.099-.445-1.076-.612-1.47-.16-.389-.323-.335-.445-.34-.114-.007-.247-.007-.38-.007a.729.729 0 0 0-.529.247c-.182.198-.691.677-.691 1.654 0 .977.71 1.916.81 2.049.098.133 1.394 2.132 3.383 2.992.47.205.84.326 1.129.418.475.152.904.129 1.246.08.38-.058 1.171-.48 1.338-.943.164-.464.164-.86.114-.943-.049-.084-.182-.133-.38-.232z"/>
                                </svg>
                                Enviar por WhatsApp
                            </button>
                            <button onclick="app.openClientLink()" class="w-full bg-white/5 text-white border border-white/10 py-4 rounded-xl font-bold hover:bg-white/10 transition flex items-center justify-center gap-2"><i data-lucide="external-link" class="w-4 h-4"></i> Abrir en nueva pestaña</button>
                        </div>
                    </div>
                    <div class="text-center text-[10px] text-slate-500 uppercase font-bold tracking-widest mt-8">
                        Powered by Latam5S
                    </div>
                </div>
            </div>
            
            <!-- PESTAÑA ENVÍOS (Actualizada a rounded-3xl) -->
            <div id="tab-orders" class="tab-content hidden w-full h-full flex flex-col p-3 md:p-8 z-10">
                
                <!-- Toolbar Compacta Glass -->
                <div class="glass-card p-4 rounded-3xl mb-3 flex flex-col gap-3 flex-shrink-0">
                    <!-- Línea 1: Filtros -->
                    <div class="flex gap-2">
                        <div class="relative flex-grow">
                            <i data-lucide="search" class="absolute left-3 top-2.5 w-4 h-4 text-slate-400"></i>
                            <input id="inp-search-orders" oninput="app.renderOrders()" class="w-full pl-9 pr-3 py-2 bg-black/30 border border-white/10 rounded-xl text-sm text-white focus:border-primary outline-none placeholder-slate-500" placeholder="Buscar cliente, DNI, ref...">
                        </div>
                        <input type="date" id="date-specific" onchange="app.renderOrders()" class="bg-black/30 border border-white/10 rounded-xl px-2 py-2 text-sm w-32 text-white focus:border-primary outline-none flex-shrink-0">
                    </div>
                    
                    <!-- Línea 2: Herramientas -->
                    <div class="flex items-center gap-2 overflow-x-auto no-scrollbar pb-1">
                        <button onclick="app.toggleAllSelection()" class="px-3 py-2 bg-white/5 hover:bg-white/10 border border-white/10 text-slate-300 rounded-lg text-xs font-bold whitespace-nowrap flex items-center gap-2 flex-shrink-0 transition">
                            <i data-lucide="check-square" class="w-4 h-4"></i> <span class="hidden sm:inline">Todo</span>
                        </button>
                        
                        <div class="h-6 w-px bg-white/10 mx-1 flex-shrink-0"></div>
                        
                        <button onclick="app.printLabels()" class="px-3 py-2 bg-white/5 text-slate-300 border border-white/10 rounded-lg font-bold hover:bg-white/10 transition flex items-center justify-center gap-2 text-xs flex-shrink-0">
                            <i data-lucide="printer" class="w-4 h-4"></i> <span class="hidden sm:inline">Etiquetas</span>
                        </button>
                        <button onclick="app.exportExcel()" class="px-3 py-2 bg-secondary/10 text-secondary border border-secondary/20 rounded-lg font-bold hover:bg-secondary/20 transition flex items-center justify-center gap-2 text-xs flex-shrink-0">
                            <i data-lucide="file-spreadsheet" class="w-4 h-4"></i> <span class="hidden sm:inline">Excel</span>
                        </button>
                        <button onclick="app.loadOrders()" class="px-3 py-2 bg-white/5 border border-white/10 rounded-lg hover:bg-white/10 text-slate-300 flex-shrink-0 transition">
                            <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                        </button>

                        <div class="h-6 w-px bg-white/10 mx-1 flex-shrink-0"></div>

                        <button onclick="app.openStatusMenu()" class="px-3 py-2 bg-primary/80 hover:bg-primary text-white rounded-lg text-xs font-bold whitespace-nowrap flex items-center gap-1 flex-shrink-0 shadow-neon transition">
                            <i data-lucide="plus-circle" class="w-4 h-4"></i> <span class="hidden sm:inline">Estado</span>
                        </button>
                        <button onclick="app.deleteSelected()" class="px-3 py-2 bg-red-500/10 hover:bg-red-500/20 text-red-400 border border-red-500/20 rounded-lg text-xs font-bold whitespace-nowrap flex items-center gap-2 flex-shrink-0 transition">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>

                <!-- Lista Glass -->
                <div class="flex-1 min-h-0 flex flex-col glass-card rounded-3xl relative">
                    <div class="overflow-y-auto p-2 space-y-1 h-full pb-32 custom-scrollbar" id="orders-list">
                        <!-- Items -->
                    </div>
                    <!-- AVISO DEL PLAN GRATIS (SE MUESTRA SOLO SI EL PLAN ES GRATIS) -->
                     <div id="plan-limit-warning" class="hidden absolute inset-0 p-6 bg-dark_bg/90 backdrop-blur-md z-30 flex flex-col items-center justify-center text-center rounded-3xl">
                        <div class="w-16 h-16 bg-primary/20 rounded-full flex items-center justify-center mb-6 text-primary mx-auto shadow-neon border border-primary/20 animate-pulse">
                            <i data-lucide="lock" class="w-8 h-8"></i>
                        </div>
                        <h3 class="text-lg font-bold text-white mb-2">Plan Gratuito Limitado</h3>
                        <p class="text-sm text-slate-400 mb-6 font-medium">
                            La visualización de respuestas no está incluida en su plan actual.
                        </p>
                        <button onclick="app.showUpgradeModal()" class="bg-gradient-to-r from-primary to-indigo-600 text-white px-8 py-4 rounded-xl font-bold shadow-neon hover:scale-105 transition flex items-center gap-2">
                           <i data-lucide="sparkles" class="w-4 h-4"></i> Ver <span id="hidden-count">0</span> registros
                        </button>
                        <p class="text-[11px] text-slate-500 mt-6 leading-relaxed max-w-xs mx-auto border-t border-white/5 pt-4">
                            Todas tus respuestas serán visibles aquí, incluidas las conversaciones que se descarten en WhatsApp. Con el plan gratuito, solo se almacenan 2 meses de respuestas.
                        </p>
                    </div>
                </div>
                
                <div class="text-center text-[10px] text-slate-500 uppercase font-bold tracking-widest mt-4 md:hidden pb-2">
                    Powered by Latam5S
                </div>
            </div>
        </main>
    </div>
        
    <script>

        const DEFAULT_API_URL = "https://script.google.com/macros/s/AKfycbwy6GejNoEKAemSpfT1dmjYSXeecE3iIKIvQKpDdVwxTeu0AV5UEVLzfde24fWYsje7CA/exec";

        // CONFIGURACIÓN DE LIMITES DEL PLAN (FEATURE FLAGS)
        const PLAN_FEATURES = {
            'Gratis': {
                allowViewOrders: false, // NO mostrar nada
            },
            'Pro': {
                allowViewOrders: true, 
            },
            'Empresa': {
                allowViewOrders: true,
            }
        };

        const SafeStorage = { memory: {}, setItem: function(k, v) { try { localStorage.setItem(k, v); } catch(e) { this.memory[k] = v; } }, getItem: function(k) { try { return localStorage.getItem(k); } catch(e) { return this.memory[k] || null; } }, removeItem: function(k) { try { localStorage.removeItem(k); } catch(e) { delete this.memory[k]; } } };
        const ALL_COURIERS = [
            "Shalom", 
            "Olva Courier", 
            "Marvisur",
            "Dinsides", 
            "Delivery"
        ];
        const ALL_DAYS = ["Lun", "Mar", "Mié", "Jue", "Vie", "Sáb", "Dom"];
        const initialState = { merchantName: "", whatsapp: "", couriers: [], shippingDays: [], updateTime: "18:00", updateGap: "0" };
        const state = { user: null, merchantId: null, apiUrl: DEFAULT_API_URL, config: { ...initialState }, allOrders: [], selectedOrders: new Set(), visibleOrders: [] };

        // Helper para sanitizar XSS
        const escapeHtml = (unsafe) => {
            if (typeof unsafe !== 'string') return unsafe;
            return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        };

        window.app = { 

            // --- NUEVA FUNCIÓN: Formateo estricto de WhatsApp ---
            formatWhatsapp: (el) => {
                // 1. Eliminar cualquier caracter que NO sea número
                let val = el.value.replace(/\D/g, '');

                // 2. Validar que empiece con 9
                // Si el primer digito no es 9 y ya hay algo escrito, lo borramos
                if (val.length > 0 && val.charAt(0) !== '9') {
                     val = val.substring(1); 
                }

                // 3. Actualizar el valor del input visualmente
                el.value = val;

                // 4. Actualizar el estado y chequear validaciones
                app.updateConfigInput('whatsapp', val);

                // Feedback visual inmediato (Borde rojo si no son 9 dígitos)
                if (val.length > 0 && val.length < 9) {
                    el.classList.add('border-red-500/50');
                    el.classList.remove('border-white/10', 'focus:border-primary');
                } else {
                    el.classList.remove('border-red-500/50');
                    el.classList.add('border-white/10', 'focus:border-primary');
                }
            },          

            // 1. Función pura que devuelve si es válido y qué falta
            validateConfig: () => {
                    const c = state.config;
                    const errors = [];

                    if (!c.merchantName || c.merchantName.length < 3) errors.push("Nombre del emprendimiento");

                    // --- ACTUALIZACIÓN AQUÍ: Validación estricta de Regex ---
                    // ^9 = empieza con 9
                    // \d{8}$ = seguido de exactamente 8 dígitos más (total 9)
                    if (!c.whatsapp || !/^9\d{8}$/.test(c.whatsapp)) errors.push("Celular válido (9 dígitos)");
                    // -------------------------------------------------------

                    if (!c.couriers || c.couriers.length === 0) errors.push("Al menos un Courier");
                    if (!c.shippingDays || c.shippingDays.length === 0) errors.push("Al menos un día de envío");
                    if (!c.updateTime) errors.push("Hora de corte");
                    if (c.updateGap === "" || c.updateGap === null || c.updateGap === undefined) errors.push("Días de anticipación");

                    return {
                        isValid: errors.length === 0,
                        errors: errors
                    };
                },

            // 2. Función visual que actualiza la UI (candado en pestaña compartir)
            checkConfigStatus: () => {
                const validation = app.validateConfig();
                const navShare = document.getElementById('nav-share');
                const icon = navShare.querySelector('i'); // El icono de Lucide

                if (validation.isValid) {
                    // Estado: HABILITADO
                    navShare.classList.remove('opacity-50', 'cursor-not-allowed');
                    navShare.classList.add('hover:bg-white/5', 'hover:text-white');
                    // Cambiamos el icono a share-2 (normal)
                    if(icon) icon.setAttribute('data-lucide', 'share-2');
                } else {
                    // Estado: BLOQUEADO
                    navShare.classList.add('opacity-50', 'cursor-not-allowed');
                    navShare.classList.remove('hover:bg-white/5', 'hover:text-white');
                     // Cambiamos el icono a lock (bloqueado)
                    if(icon) icon.setAttribute('data-lucide', 'share-2');
                }
                lucide.createIcons(); // Refrescar iconos
            },          
              
            updateConfigInput: (key, value) => {
                    state.config[key] = value;
                    app.checkConfigStatus(); // <--- IMPORTANTE: Revalida visualmente en tiempo real
                },

            toggleLoading: (show) => { const el = document.getElementById('loading-overlay'); show ? (el.classList.remove('hidden'), setTimeout(()=>el.classList.remove('opacity-0'),10)) : (el.classList.add('opacity-0'), setTimeout(()=>el.classList.add('hidden'),300)); },
            

    modalTimer: null,

    // 1. openModal CORREGIDO
    openModal: (htmlContent) => {
        const el = document.getElementById('generic-modal');
        const content = document.getElementById('modal-content');
        
        // --- LA CORRECCIÓN MÁGICA ---
        // Si había una orden de cerrar el modal, LA CANCELAMOS inmediatamente.
        if (app.modalTimer) clearTimeout(app.modalTimer);
        // -----------------------------

        content.innerHTML = htmlContent;
        
        el.classList.remove('hidden');
        
        // Pequeño delay para permitir que el navegador procese el cambio de display antes de la opacidad
        setTimeout(() => {
            el.classList.remove('opacity-0');
            if(el.firstElementChild) {
                el.firstElementChild.classList.remove('scale-95');
                el.firstElementChild.classList.add('scale-100');
            }
        }, 10);
        
        if(window.lucide) lucide.createIcons();
    },

    // 2. closeModal CORREGIDO
    closeModal: () => {
        const el = document.getElementById('generic-modal');
        if(!el) return;

        // Iniciamos animación de salida
        el.classList.add('opacity-0');
        if(el.firstElementChild) {
            el.firstElementChild.classList.remove('scale-100');
            el.firstElementChild.classList.add('scale-95');
        }

        // Guardamos la referencia del Timer para poder cancelarlo si se abre rápido de nuevo
        app.modalTimer = setTimeout(() => {
            el.classList.add('hidden');
            app.modalTimer = null; // Limpiamos la variable
        }, 200); // 200ms debe coincidir con tu CSS duration-200
    },

    // Reemplazo de showModal (Confirmación)
    showModal: (msg, onConfirm) => {
        app.openModal(`
            <div class="w-14 h-14 bg-primary/20 rounded-full flex items-center justify-center mb-6 text-primary mx-auto shadow-neon border border-primary/20">
                <i data-lucide="alert-circle" class="w-7 h-7"></i>
            </div>
            <h3 class="text-xl font-bold text-white mb-3 text-center">Confirmación</h3>
            <p class="text-slate-400 text-sm mb-8 leading-relaxed text-center">${msg}</p>
            <div class="flex gap-3">
                <button onclick="app.closeModal()" class="flex-1 py-3 rounded-xl font-bold text-slate-400 hover:text-white hover:bg-white/5 border border-white/10 transition">Cancelar</button>
                <button id="btn-confirm-action" class="flex-1 py-3 rounded-xl font-bold bg-primary text-white hover:bg-blue-600 shadow-neon transition">Confirmar</button>
            </div>
        `);
        document.getElementById('btn-confirm-action').onclick = () => { onConfirm(); app.closeModal(); };
    },

    // Reemplazo de openStatusMenu
    openStatusMenu: () => {
        if (state.selectedOrders.size === 0) return app.showToast('Selecciona al menos un envío');
        app.openModal(`
            <h3 class="text-xl font-bold text-white mb-2 text-center">Actualizar Estado</h3>
            <p class="text-xs text-slate-400 text-center mb-6">Se aplicará a ${state.selectedOrders.size} elemento(s).</p>
            <div class="space-y-4">
                <button onclick="app.setStatus('ENVIADO')" class="w-full py-4 rounded-xl font-bold bg-secondary/20 text-secondary hover:bg-secondary/30 border border-secondary/30 flex items-center justify-center gap-3 transition">
                    <i data-lucide="truck" class="w-5 h-5"></i> MARCAR COMO ENVIADO
                </button>
                <button onclick="app.setStatus('PENDIENTE')" class="w-full py-4 rounded-xl font-bold bg-yellow-500/20 text-yellow-400 hover:bg-yellow-500/30 border border-yellow-500/30 flex items-center justify-center gap-3 transition">
                    <i data-lucide="clock" class="w-5 h-5"></i> MARCAR COMO PENDIENTE
                </button>
            </div>
        `);
    },

    // Reemplazo de showUpgradeModal
    showUpgradeModal: () => {
        app.openModal(`
            <div class="w-16 h-16 bg-primary/20 rounded-full flex items-center justify-center mb-6 text-primary mx-auto shadow-neon border border-primary/20">
                <i data-lucide="crown" class="w-8 h-8"></i>
            </div>
            <h3 class="text-2xl font-bold text-white mb-2 text-center">Plan Pro</h3>
            <p class="text-slate-300 text-sm mb-6 leading-relaxed text-center">Desbloquea el historial ilimitado.</p>
            <button onclick="app.activateTrial()" class="w-full py-4 rounded-xl font-bold bg-gradient-to-r from-primary to-indigo-600 text-white hover:scale-[1.02] transition shadow-neon flex items-center justify-center gap-2">
                <i data-lucide="sparkles" class="w-4 h-4"></i> Gratis por 7 días
            </button>
        `);
    },

            
            // FUNCIÓN CORREGIDA: ACTIVACIÓN INMEDIATA
            activateTrial: async () => {
                app.toggleLoading(true);
                try {
                    const res = await fetch(state.apiUrl, { 
                        method: "POST", 
                        body: JSON.stringify({ action: "startTrial", merchantId: state.user.uid }) 
                    });
                    const json = await res.json();
                    
                    if(json.status === 'success') { 
                        // 1. Actualizar Estado Local Inmediatamente (Sin preguntar al servidor)
                        state.user.plan = 'Pro (Prueba)'; 
                        SafeStorage.setItem('app_current_user', JSON.stringify(state.user)); 
                        
                        // 2. Actualizar Visualmente el Badge del Plan (Sidebar)
                        document.querySelectorAll('.user-plan-display').forEach(el => 
                            el.innerText = `PLAN ${state.user.plan.toUpperCase()}`
                        );

                        // 3. Cerrar Modal
                        app.closeModal(); 
                        
                        // 4. Recargar los Pedidos (Ahora que el estado es PRO, se mostrarán)
                        // IMPORTANTE: No llamamos a loadData(), solo a loadOrders()
                        await app.loadOrders(); 
                        
                        app.showToast('¡Prueba Activada! Disfruta 7 días Pro 🎉'); 
                    } else {
                        // ERROR (Ya la usó)
                        app.closeModal();
                        app.showModal(json.message || 'No se pudo activar la prueba', () => app.closeModal());
                    }
                } catch(e){
                    app.showToast('Error de conexión');
                } 
                app.toggleLoading(false);
            },
            
            setStatus: (newStatus) => {
                app.closeModal('modal-status');
                app.showModal(`¿Cambiar ${state.selectedOrders.size} envíos a ${newStatus}?`, async () => {
                    app.toggleLoading(true);
                    const ids = Array.from(state.selectedOrders);
                    try { await fetch(state.apiUrl, { method: "POST", body: JSON.stringify({ action: "updateOrdersStatus", merchantId: state.merchantId, orderIds: ids, newStatus: newStatus }) }); app.showToast('Estados actualizados'); app.loadOrders(); } catch(e) {}
                    app.toggleLoading(false);
                });
            },

            // NUEVA FUNCIÓN: ENVIAR RESUMEN AL CLIENTE
            sendClientSummary: (orderId) => {
                const order = state.allOrders.find(o => String(o.orderId || o.createdAt) === String(orderId));
                if (!order) return app.showToast("Error: No se encontró el pedido.");
            
                const storeName = state.config.merchantName || "Nuestra Tienda";
                let phone = (order.clientPhone || "").replace(/[^0-9]/g, "");
                if (phone.length === 9) { phone = "51" + phone; }
                
                // Validación básica de número
                if (phone.length < 9) return app.showToast("El número de teléfono no es válido.");
            
                const statusEmoji = order.status === 'ENVIADO' ? '✅' : '📦';
                const statusText = order.status === 'ENVIADO' ? 'Enviado' : 'Programado';
                
                let destinationInfo = "";
                if (order.clientAgency) {
                    destinationInfo = `🏢 *Agencia:* ${order.clientAgency} (DNI: ${order.clientDni})`;
                } else {
                    destinationInfo = `🏠 *Dirección:* ${order.clientDistrict}, ${order.clientAddress} (Ref: ${order.clientRef})`;
                }
            
                // CORRECCIÓN CLAVE: Usamos \n en lugar de %0A y emojis literales
                const message = `Hola *${order.clientName}*! 👋\n` +
                                `Tu envío en *${storeName}* está *${statusText}* ${statusEmoji}\n\n` +
                                `📅 *Fecha:* ${order.shippingDate}\n` +
                                `🚚 *Courier:* ${order.courier}\n` +
                                `${destinationInfo}\n\n` +
                                `Gracias por tu compra! ✨`;
            
                // CORRECCIÓN CLAVE: encodeURIComponent envuelve TODO el mensaje
                const url = `https://wa.me/${phone}?text=${encodeURIComponent(message)}`;
                window.open(url, '_blank');
            },
            
            showToast: (msg) => {
                const el = document.getElementById('toast');
                document.getElementById('toast-msg').innerText = msg;
                el.classList.remove('opacity-0', '-translate-y-20');
                setTimeout(() => el.classList.add('opacity-0', '-translate-y-20'), 3000);
            },
   
            scrollToEl: (el) => { setTimeout(() => { el.scrollIntoView({ behavior: 'smooth', block: 'center' }); }, 100); },

            handleLogin: async (e) => { 
                e.preventDefault(); 
                const p = document.getElementById('auth-phone').value.trim();
                const pw = document.getElementById('auth-pass').value.trim();
                const err = document.getElementById('auth-error'); 
                app.toggleLoading(true); 
                try { 
                    const res = await fetch(state.apiUrl, { method: "POST", body: JSON.stringify({ action: "loginUser", data: { phone: p, password: pw } }) }); 
                    const json = await res.json(); 
                    if(json.status === 'success') { app.loginSuccess(json.user); return; } 
                    else { err.innerText = json.message || "Error desconocido"; err.classList.remove('hidden'); app.toggleLoading(false); return; } 
                } catch(e) { console.error(e); err.innerText = "Error de conexión con el servidor"; err.classList.remove('hidden'); app.toggleLoading(false); } 
            },
            loginSuccess: (u) => { state.user = u; SafeStorage.setItem('app_current_user', JSON.stringify(u)); app.init(); },
            logout: () => { SafeStorage.removeItem('app_current_user'); state.user=null; state.merchantId=null; window.location.reload(); },
            
            adminLoadUsers: async () => { 
                const l = document.getElementById('admin-users-list'); 
                
                // Verificamos si tenemos el token guardado en el estado del usuario
                // state.user.token viene del cambio que hicimos en loginUser en el backend
                const secretToken = state.user && state.user.token ? state.user.token : null;

                if (!secretToken) {
                    l.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-red-400">⛔ Error de sesión: Relogueate como Admin</td></tr>';
                    return;
                }

                l.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-slate-400"><i data-lucide="shield-check" class="inline w-4 h-4 mr-1"></i> Autorizando...</td></tr>'; 
                lucide.createIcons();

                app.toggleLoading(true);
                let u = []; 
                
                try { 
                    // ENVIAMOS EL TOKEN AUTOMÁTICAMENTE (Ya no pide prompt)
                    // Nota: Enviamos 'adminSecret' con el valor del token
                    const res = await fetch(`${state.apiUrl}?action=getUsers&adminSecret=${encodeURIComponent(secretToken)}`); 
                    const json = await res.json(); 
                    
                    if(json.users) {
                        u = json.users; 
                        // Renderizado de la tabla (Tu código visual original)
                        l.innerHTML = u.length ? u.map(user => `<tr class="bg-white border-b hover:bg-slate-50"><td class="px-6 py-4 font-bold text-slate-700">${escapeHtml(user.phone)}</td><td class="px-6 py-4"><span class="bg-indigo-100 text-indigo-800 text-xs font-bold px-2 py-1 rounded">${escapeHtml(user.plan||'Gratis')}</span></td><td class="px-6 py-4 text-xs text-slate-400">${user.createdAt ? new Date(user.createdAt).toLocaleDateString() : '-'}</td><td class="px-6 py-4 text-right flex gap-2 justify-end"><button onclick="app.adminResend('${escapeHtml(user.uid)}','${escapeHtml(user.phone)}')" class="text-indigo-600 text-xs font-bold hover:bg-indigo-50 px-2 py-1 rounded">Clave</button><select onchange="app.adminUpdatePlan('${escapeHtml(user.uid)}', this.value)" class="text-xs border rounded p-1 bg-slate-50 cursor-pointer outline-none"><option value="" disabled selected>Cambiar Plan</option><option value="Gratis">Gratis</option><option value="Pro">Pro</option><option value="Empresa">Empresa</option></select></td></tr>`).join('') : '<tr><td colspan="4" class="p-4 text-center">Base de datos vacía</td></tr>'; 
                    } else {
                        l.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-red-500 font-bold">⛔ Acceso Denegado (Token inválido)</td></tr>`;
                    }
                } catch(e){ 
                    console.error(e);
                    l.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-red-400">Error de conexión</td></tr>';
                } 
                
                app.toggleLoading(false); 
            },
            
            adminUpdatePlan: (uid, newPlan) => { 
                app.showModal(`¿Confirmas cambiar el plan a ${newPlan}?`, async () => {
                    app.toggleLoading(true); 
                    try { await fetch(state.apiUrl, { method: "POST", body: JSON.stringify({ action: "updateUserPlan", merchantId: uid, newPlan: newPlan }) }); } catch(e){} 
                    app.adminLoadUsers();
                    app.showToast('Plan actualizado');
                });
            },
            
            adminCreateUser: async (e) => { e.preventDefault(); const p = document.getElementById('admin-new-phone').value.trim(), pl = document.getElementById('admin-new-plan').value; app.toggleLoading(true); const np = Math.floor(1000+Math.random()*9000).toString(); try { await fetch(state.apiUrl, { method: "POST", body: JSON.stringify({ action: "registerUser", data: { phone: p, password: np, plan: pl } }) }); } catch(e){} window.open(`https://wa.me/51${p}?text=${encodeURIComponent(`🔐 Bienvenid@ (Plan ${pl})\n\n📱 User: ${p}\n🔑 Pass: *${np}*\n\nEntra: ${window.location.href}`)}`, '_blank'); document.getElementById('admin-new-phone').value=""; app.adminLoadUsers(); app.showToast('Usuario creado con éxito'); },
            
            adminResend: (uid, phone) => { 
                app.showModal(`¿Resetear clave para ${phone}?`, async () => {
                    app.toggleLoading(true); const np = Math.floor(1000+Math.random()*9000).toString(); 
                    try { await fetch(state.apiUrl, { method: "POST", body: JSON.stringify({ action: "changePassword", merchantId: uid, newPassword: np }) }); } catch(e){} 
                    window.open(`https://wa.me/51${phone}?text=${encodeURIComponent(`🔐 *Recuperación de clave:*\n\n📱Usuario: ${phone}\n🔑Nueva Clave: *${np}*`)}`, '_blank'); 
                    app.toggleLoading(false);
                    app.showToast('Contraseña restablecida');
                });
            },
            
            saveConfig: async () => { 
                            // 1. SANITIZACIÓN (LIMPIEZA DE DATOS)
                            const nameInput = document.getElementById('inp-store-name');

                            // Lógica de limpieza: trim() quita bordes, replace(/\s+/g, ' ') colapsa espacios internos
                            let cleanName = nameInput.value.trim().replace(/\s+/g, ' ');

                            // Aplicamos la limpieza al input visual y al estado
                            nameInput.value = cleanName; 
                            app.updateConfigInput('merchantName', cleanName);

                            // 2. VALIDACIÓN (Ahora valida sobre el nombre ya limpio)
                            const validation = app.validateConfig();

                            if (!validation.isValid) {
                                const missing = validation.errors.join(", ");
                                app.showToast(`⚠️ No se puede guardar. Falta: ${missing}`);

                                const btn = document.getElementById('btn-save-config');
                                btn.classList.add('bg-red-500', 'animate-shake');
                                setTimeout(() => btn.classList.remove('bg-red-500', 'animate-shake'), 500);
                                return; 
                            }

                            // 3. PROCESO DE GUARDADO (Backend)
                            const btn = document.getElementById('btn-save-config');
                            btn.disabled = true;
                            btn.innerHTML = '<i data-lucide="loader" class="w-4 h-4 animate-spin"></i> Guardando...';
                            lucide.createIcons();

                            app.toggleLoading(true); 

                            // Recopilamos el resto de valores
                            state.config.merchantName = cleanName; // Aseguramos usar el limpio
                            state.config.whatsapp = document.getElementById('inp-whatsapp').value; 
                            state.config.updateTime = document.getElementById('inp-time').value; 
                            state.config.updateGap = document.getElementById('inp-gap').value;

                            SafeStorage.setItem(`config_${state.user.uid}`, JSON.stringify(state.config)); 

                            try { 
                                await fetch(state.apiUrl, { method: "POST", body: JSON.stringify({ action: "saveConfig", merchantId: state.user.uid, data: state.config }) }); 
                            } catch(e){
                                console.error("Error backend", e);
                            } 

                            setTimeout(() => { 
                                app.toggleLoading(false); 
                                app.showToast('Configuración guardada y optimizada'); 
                                app.checkConfigStatus();

                                btn.disabled = false;
                                btn.innerHTML = '<i data-lucide="save" class="w-4 h-4"></i> Guardar';
                                lucide.createIcons();
                            }, 500); 
                        },
            
            changePassword: async () => {
                const newPass = document.getElementById('inp-new-pass').value.trim();
                if (!newPass) return;
                app.showModal('¿Estás seguro de cambiar tu contraseña actual?', async () => {
                    app.toggleLoading(true);
                    try {
                        await fetch(state.apiUrl, { method: "POST", body: JSON.stringify({ action: "changePassword", merchantId: state.user.uid, newPassword: newPass }) });
                        document.getElementById('inp-new-pass').value = "";
                        app.showToast('Contraseña actualizada');
                    } catch(e) {}
                    app.toggleLoading(false);
                });
            },
            
            // --- NUEVO HELPER: Genera la URL correcta dinámicamente ---
            getShareUrl: () => {
                // 1. Detecta la carpeta actual (ej: /landing/ o /)
                const path = window.location.pathname;
                const folder = path.substring(0, path.lastIndexOf('/') + 1);
                
                // 2. Construye la URL apuntando a form.html
                return `${window.location.origin}${folder}form?merchant=${state.user.uid}`;
            },

            // --- FUNCIONES MODIFICADAS ---
            
            copyLink: () => {
                const text = app.getShareUrl(); // <--- Usamos el helper
                const fallbackCopy = (t) => { const ta = document.createElement("textarea"); ta.value = t; document.body.appendChild(ta); ta.select(); document.execCommand("copy"); document.body.removeChild(ta); };
                if (navigator.clipboard && navigator.clipboard.writeText) navigator.clipboard.writeText(text).catch(() => fallbackCopy(text)); else fallbackCopy(text);
                app.showToast('Enlace copiado al portapapeles');
            },

            shareOnWhatsapp: () => {
                const url = app.getShareUrl(); // <--- Usamos el helper
                const message = `${url}\n*PROGRAMA TU ENVÍO AQUÍ* ☝️`; 
                window.open(`https://wa.me/?text=${encodeURIComponent(message)}`, '_blank');
            },

            openClientLink: () => {
                const url = app.getShareUrl(); // <--- Usamos el helper
                window.open(url, '_blank');
            },
            
            loadData: async () => { 
                app.toggleLoading(true); 
                
                // 1. Cargar Configuración
                state.config = { ...initialState }; 
                try { 
                    const res = await fetch(`${state.apiUrl}?action=getConfig&merchantId=${state.merchantId}`); 
                    const json = await res.json(); 
                    if (json.data) state.config = json.data; 
                } catch(e){ 
                    const local = SafeStorage.getItem(`config_${state.merchantId}`); 
                    if(local) state.config = JSON.parse(local); 
                } 
                
                // 2. Verificar estado del plan
                if (state.user && state.merchantId) {
                    try {
                        const resStatus = await fetch(`${state.apiUrl}?action=getUserStatus&merchantId=${state.merchantId}`);
                        const jsonStatus = await resStatus.json();
                        
                        if (jsonStatus.status === 'success' && jsonStatus.plan !== state.user.plan) {
                            state.user.plan = jsonStatus.plan;
                            if (jsonStatus.plan === 'Gratis') delete state.user.trialEndsAt;
                            SafeStorage.setItem('app_current_user', JSON.stringify(state.user));
                            app.showToast('Tu plan se ha actualizado');
                        }
                    } catch(e) { console.log("Offline check"); }

                    document.querySelectorAll('.user-phone-display').forEach(el => el.innerText = state.user.phone);
                    if(state.user.plan) document.querySelectorAll('.user-plan-display').forEach(el => el.innerText = `PLAN ${state.user.plan.toUpperCase()}`);
                }

                // 3. Renderizado (Directo al dashboard, ya no hay cliente)
                app.renderDashboard(); 
                app.loadOrders(); 
                
                app.toggleLoading(false); 
            },
            
            // --- NUEVA LÓGICA DE PEDIDOS (Filtrado & Selección) ---
            loadOrders: async () => { 
                const l = document.getElementById('orders-list'); 
                l.innerHTML = '<div class="text-center py-10 text-slate-400 flex flex-col items-center gap-2"><i data-lucide="loader" class="animate-spin w-6 h-6"></i> Cargando envíos...</div>'; 
                lucide.createIcons();
                
                try { 
                    // Anti-cache param
                    const res = await fetch(`${state.apiUrl}?action=getOrders&merchantId=${state.merchantId}&_t=${Date.now()}`); 
                    const json = await res.json(); 
                    
                    // AQUI APLICAMOS EL FILTRO DE PLAN
                    // Revisar plan local (incluyendo 'Pro (Prueba)')
                    const userPlan = state.user ? state.user.plan : 'Gratis';
                    const isFree = userPlan === 'Gratis';
                    
                    let rawOrders = json.orders || [];
                    
                    // Si es gratis, NO CARGAR NADA en allOrders, pero guardar el total para el contador
                    if (isFree) {
                        state.allOrders = [];
                        state.hasHiddenOrders = true;
                        state.totalHiddenCount = rawOrders.length;
                    } else {
                        // Si es Pro/Empresa/Prueba, cargar todo
                        state.allOrders = rawOrders;
                        state.hasHiddenOrders = false;
                        state.totalHiddenCount = 0;
                    }
                    
                    state.selectedOrders.clear();
                    
                    // Actualizar contador en el aviso
                    const hiddenCountEl = document.getElementById('hidden-count');
                    if(hiddenCountEl) hiddenCountEl.innerText = state.totalHiddenCount;

                } catch(e){
                    state.allOrders = [];
                } 
                app.renderOrders();
            },

            renderOrders: () => {
                const l = document.getElementById('orders-list');
                const q = (document.getElementById('inp-search-orders').value || '').toLowerCase();
                const dSpec = document.getElementById('date-specific').value;
                
                const filtered = state.allOrders.filter(x => {
                    // Búsqueda en TODOS los campos relevantes
                    const txt = `${x.clientName} ${x.clientPhone} ${x.clientDni || ''} ${x.clientDistrict || ''} ${x.clientAgency || ''} ${x.clientAddress || ''} ${x.clientRef || ''} ${x.courier} ${x.status || ''}`.toLowerCase();
                    if (!txt.includes(q)) return false;
                    
                    // 2. CORRECCIÓN: Filtro por Fecha de Despacho (shippingDate)
                    if (dSpec) {
                        // El input date viene formato "YYYY-MM-DD" (Ej: 2023-11-25)
                        const [year, month, day] = dSpec.split('-');
                        
                        // Tu shippingDate es texto: "Lunes 25/11" o "Mar 25/11"
                        // Construimos lo que vamos a buscar: "25/11"
                        const searchStr = `${day}/${month}`;
            
                        // Si el pedido no tiene fecha de envío o no contiene "25/11", lo ocultamos
                        if (!x.shippingDate || !x.shippingDate.includes(searchStr)) {
                            return false;
                        }
                    }
                    return true;
                });
                
                state.visibleOrders = filtered;

                if (!filtered.length) {
                    // Si no hay visibles...
                    if(state.hasHiddenOrders) {
                         // Si es por bloqueo de plan, limpiamos para que solo se vea el aviso
                         l.innerHTML = '';
                    } else {
                        // Si es plan pro y no hay datos (o filtro sin resultados)
                        l.innerHTML = '<div class="text-center py-10 text-slate-400">Sin envíos encontrados</div>';
                    }
                } else {
                    l.innerHTML = filtered.map((x, idx) => {
                        const id = String(x.orderId || x.createdAt); // FORCE STRING ID
                        const isSel = state.selectedOrders.has(id);
                        const status = x.status || 'PENDIENTE';
                        let badgeClass = 'bg-yellow-500/20 text-yellow-400 border border-yellow-500/30';
                        if(status === 'ENVIADO') badgeClass = 'bg-secondary/20 text-secondary border border-secondary/30';

                        return `
                        <div class="bg-black/30 border ${isSel ? 'border-primary ring-1 ring-primary bg-primary/10' : 'border-white/10'} p-3 rounded-lg shadow-sm hover:border-white/20 transition group flex gap-3 items-start">
                            <div class="pt-1">
                                <input type="checkbox" onchange="app.toggleOrderSelection('${id}')" ${isSel ? 'checked' : ''} class="w-4 h-4 rounded border-slate-500 text-primary focus:ring-primary cursor-pointer bg-black/40">
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="flex justify-between font-bold text-slate-200">
                                    <span class="truncate text-white">${escapeHtml(x.clientName)}</span>
                                    <div class="flex items-center gap-2">
                                        <span class="text-[10px] font-bold px-2 py-0.5 rounded ${badgeClass}">${status}</span>
                                        <!-- Botón de WhatsApp integrado en la cabecera -->
                                        <button onclick="app.sendClientSummary('${id}')" class="text-secondary hover:text-white hover:bg-secondary/20 p-1 rounded-full transition" title="Enviar resumen al cliente">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" class="w-4 h-4">
                                                <path d="M13.601 2.326A7.854 7.854 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.933 7.933 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.898 7.898 0 0 0 13.6 2.326zM7.994 14.521a6.573 6.573 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 0 1 4.66 1.931 6.557 6.557 0 0 1 1.928 4.66c-.004 3.639-2.961 6.592-6.592 6.592zm3.615-4.934c-.197-.099-1.17-.578-1.353-.646-.182-.065-.315-.099-.445.099-.133.197-.513.646-.627.775-.114.133-.232.148-.43.05-.197-.1-.836-.308-1.592-.985-.59-.525-.985-1.175-1.103-1.372-.114-.198-.011-.304.088-.403.087-.088.197-.232.296-.346.1-.114.133-.198.198-.33.065-.134.034-.248-.015-.347-.05-.099-.445-1.076-.612-1.47-.16-.389-.323-.335-.445-.34-.114-.007-.247-.007-.38-.007a.729.729 0 0 0-.529.247c-.182.198-.691.677-.691 1.654 0 .977.71 1.916.81 2.049.098.133 1.394 2.132 3.383 2.992.47.205.84.326 1.129.418.475.152.904.129 1.246.08.38-.058 1.171-.48 1.338-.943.164-.464.164-.86.114-.943-.049-.084-.182-.133-.38-.232z"/>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                                <div class="text-xs text-slate-400 mt-1 flex flex-wrap gap-x-3 gap-y-1">
                                    <span class="flex items-center gap-1"><i data-lucide="calendar" class="w-3 h-3 text-primary"></i> ${escapeHtml(x.shippingDate)}</span>
                                    <span class="flex items-center gap-1"><i data-lucide="truck" class="w-3 h-3 text-primary"></i> ${escapeHtml(x.courier)}</span>
                                </div>
                                <div class="text-xs text-slate-300 mt-2 font-medium border-t border-white/5 pt-2">
                                    ${x.clientAgency ? `🏢 ${escapeHtml(x.clientAgency)}` : `🏠 ${escapeHtml(x.clientDistrict)} - ${escapeHtml(x.clientAddress || '')}`}
                                </div>
                            </div>
                        </div>
                    `}).join('');
                }

                // Mostrar/Ocultar aviso de plan limitado
                const warningEl = document.getElementById('plan-limit-warning');
                // Mostrar SIEMPRE si hay ocultos por plan gratis
                if (state.hasHiddenOrders) { 
                    warningEl.classList.remove('hidden');
                } else {
                    warningEl.classList.add('hidden');
                }
                
                lucide.createIcons();
            },

            toggleOrderSelection: (id) => {
                const strId = String(id); 
                if (state.selectedOrders.has(strId)) state.selectedOrders.delete(strId);
                else state.selectedOrders.add(strId);
                app.renderOrders(); 
            },
            
            toggleAllSelection: () => {
                const allSelected = state.visibleOrders.every(x => state.selectedOrders.has(String(x.orderId || x.createdAt)));
                if (allSelected) state.visibleOrders.forEach(x => state.selectedOrders.delete(String(x.orderId || x.createdAt)));
                else state.visibleOrders.forEach(x => state.selectedOrders.add(String(x.orderId || x.createdAt)));
                app.renderOrders();
            },
            
            deleteSelected: () => {
                if (state.selectedOrders.size === 0) return app.showToast('Selecciona al menos un envío');
                app.showModal(`¿Eliminar ${state.selectedOrders.size} envíos?`, async () => {
                    app.toggleLoading(true);
                    const ids = Array.from(state.selectedOrders);
                    try { await fetch(state.apiUrl, { method: "POST", body: JSON.stringify({ action: "deleteOrders", merchantId: state.merchantId, orderIds: ids }) }); app.showToast('Envíos eliminados'); app.loadOrders(); } catch(e) {}
                    app.toggleLoading(false);
                });
            },
            
            updateBatchStatus: () => {
                if (state.selectedOrders.size === 0) return app.showToast('Selecciona envíos');
                app.openStatusMenu();
            },

            exportExcel: async () => { // Nota el async
                const list = state.visibleOrders;
                if (!list.length) return app.showToast('No hay datos para exportar');
            
                app.toggleLoading(true);
            
                // CARGA DINÁMICA: Solo se descarga si el usuario lo pide
                if (typeof XLSX === 'undefined') {
                    await new Promise((resolve, reject) => {
                        const script = document.createElement('script');
                        script.src = "https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js";
                        script.onload = resolve;
                        script.onerror = reject;
                        document.head.appendChild(script);
                    });
                }
            
                // 1. Preparamos los datos limpios para Excel
                const dataToExport = list.map(x => {
                    // Lógica para unificar destino (Igual que tenías antes)
                    const destino = x.clientAgency 
                        ? `AGENCIA: ${x.clientAgency}` 
                        : `CASA: ${x.clientDistrict} - ${x.clientAddress}`;
                        
                    const referencia = x.clientAgency 
                        ? `DNI: ${x.clientDni}` 
                        : `REF: ${x.clientRef}`;
            
                    return {
                        "Fecha Envío": x.shippingDate, // Usamos la fecha de despacho, no la de registro
                        "Courier": x.courier,
                        "Cliente": x.clientName,
                        "Teléfono": x.clientPhone,
                        "Destino": destino,
                        "Referencia / DNI": referencia,
                        "Estado": x.status || "PENDIENTE",
                        "Fecha Registro": new Date(x.createdAt || Date.now()).toLocaleDateString()
                    };
                });
            
                // 2. Crear una Hoja de Cálculo (Worksheet)
                const ws = XLSX.utils.json_to_sheet(dataToExport);
            
                // Opcional: Ajustar ancho de columnas automáticamente (UX Pro)
                const wscols = [
                    {wch: 15}, // Fecha Envío
                    {wch: 15}, // Courier
                    {wch: 25}, // Cliente
                    {wch: 15}, // Teléfono
                    {wch: 40}, // Destino
                    {wch: 20}, // Referencia
                    {wch: 15}, // Estado
                    {wch: 15}  // Fecha Registro
                ];
                ws['!cols'] = wscols;
            
                // 3. Crear el Libro (Workbook) y agregar la hoja
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Envíos Latam5S");
            
                // 4. Generar nombre de archivo con fecha
                const today = new Date().toISOString().slice(0,10); // YYYY-MM-DD
                const fileName = `Envios_${state.config.merchantName || 'Tienda'}_${today}.xlsx`;
            
                // 5. Descargar
                XLSX.writeFile(wb, fileName);
                
                app.toggleLoading(false);
                app.showToast('Excel (.xlsx) descargado correctamente');
            },

            printLabels: () => {
                const targets = state.selectedOrders.size > 0 ? state.allOrders.filter(x => state.selectedOrders.has(String(x.orderId || x.createdAt))) : state.visibleOrders;
                if(!targets.length) return app.showToast('Nada para imprimir');
                app.doPrint(targets);
            },

            doPrint: (list) => {
                if(!list.length) return;
                const area = document.getElementById('print-area');
                const shopName = state.config.merchantName || "Mi Tienda";
                
                // CORRECCIÓN: Usamos 'block' en el contenedor y 'inline-block' en las tarjetas.
                // Esto evita que el navegador móvil parta las tarjetas entre páginas.
                area.innerHTML = `
                    <div style="width: 100%; font-size: 0; /* Elimina espacios fantasma */">
                        ${list.map(x => `
                            <div style="
                                display: inline-block; 
                                width: 48%; /* Un poco menos del 50% para margen */
                                margin: 1%; 
                                vertical-align: top; 
                                border: 1px solid #000; 
                                padding: 10px; 
                                box-sizing: border-box; /* Asegura que el padding no rompa el ancho */
                                
                                /* PROPIEDADES ANTI-ROTURA PARA MÓVIL */
                                page-break-inside: avoid; 
                                break-inside: avoid; 
                                
                                font-family: 'Segoe UI', sans-serif; 
                                border-radius: 8px; 
                                background: white; 
                                font-size: 12px;
                            ">
                                <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ccc; padding-bottom: 8px; margin-bottom: 8px;">
                                    <div style="font-size: 9px; color: #555; text-transform: uppercase; letter-spacing: 0.5px;">Remitente</div>
                                    <div style="font-weight: bold; font-size: 11px; color: #000;">${escapeHtml(shopName).substring(0, 20)}</div>
                                </div>
                                
                                <div style="margin-bottom: 8px;">
                                    <p style="margin: 0; font-size: 8px; color: #666; font-weight: bold; text-transform: uppercase;">PARA:</p>
                                    <h2 style="margin: 2px 0; font-size: 14px; font-weight: 900; color: #000; line-height: 1.1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${escapeHtml(x.clientName).toUpperCase()}</h2>
                                    <p style="margin: 0; font-size: 11px; color: #000; font-family: monospace; font-weight: bold;">${escapeHtml(x.clientPhone)}</p>
                                </div>
                                
                                <div style="margin-bottom: 8px; min-height: 35px;">
                                    <p style="margin: 0; font-size: 8px; color: #666; font-weight: bold; text-transform: uppercase;">DESTINO:</p>
                                    <p style="margin: 2px 0 0 0; font-size: 10px; color: #000; line-height: 1.3;">
                                        ${x.clientAgency ? 
                                            `<strong>AGENCIA:</strong> ${escapeHtml(x.clientAgency)}<br><strong>DNI:</strong> ${x.clientDni}` : 
                                            `<strong>DIRECCIÓN:</strong> ${escapeHtml(x.clientAddress)}<br><span style="color:#444">${escapeHtml(x.clientDistrict)}</span>`
                                        }
                                    </p>
                                    ${!x.clientAgency ? `<p style="margin: 2px 0 0 0; font-size: 9px; color: #555;">Ref: ${escapeHtml(x.clientRef || '-')}</p>` : ''}
                                </div>
            
                                <div style="border-top: 1px solid #ccc; padding-top: 6px; display: flex; align-items: center; justify-content: space-between; color: #000;">
                                    <span style="font-size: 10px; font-weight: 800; text-transform: uppercase; background: #eee; padding: 2px 5px; border-radius: 4px;">${escapeHtml(x.courier)}</span>
                                    <span style="font-size: 9px;">${new Date(x.createdAt || Date.now()).toLocaleDateString()}</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                window.print();
                setTimeout(() => { area.innerHTML = ''; }, 1000);
            },

            toggleConfigItem: (k, v) => { 
                    if (state.config[k].includes(v)) state.config[k] = state.config[k].filter(i => i !== v); 
                    else state.config[k].push(v); 
                    app.renderDashboard(); 
                    app.checkConfigStatus(); // <--- IMPORTANTE: Revalida al tocar botones de courier/dias
                },
          
            renderDashboard: () => { 
                    document.getElementById('inp-store-name').value = state.config.merchantName || ''; 
                    document.getElementById('inp-whatsapp').value = state.config.whatsapp || ''; 
                    document.getElementById('inp-time').value = state.config.updateTime || ''; 

                    // --- NUEVO: Renderizar el valor del gap ---
                    document.getElementById('inp-gap').value = state.config.updateGap !== undefined ? state.config.updateGap : ''; 

                    // Inputs con oninput para validación en tiempo real
                    document.getElementById('inp-store-name').oninput = (e) => app.updateConfigInput('merchantName', e.target.value);
                    document.getElementById('inp-whatsapp').oninput = (e) => app.updateConfigInput('whatsapp', e.target.value);

                    // Renderizado de Botones (Igual que antes)
                    document.getElementById('container-couriers').innerHTML = ALL_COURIERS.map(c => `<div onclick="app.toggleConfigItem('couriers','${c}')" class="cursor-pointer bg-black/30 border border-white/10 rounded p-2 text-xs font-bold flex items-center gap-2 select-none ${state.config.couriers.includes(c)?'border-primary text-primary bg-primary/10':'text-slate-400 hover:bg-white/5'} transition"><div class="w-3 h-3 border rounded flex items-center justify-center ${state.config.couriers.includes(c)?'bg-primary border-primary':'border-slate-500'}">${state.config.couriers.includes(c)?'<i data-lucide="check" class="w-2 h-2 text-white"></i>':''}</div>${c}</div>`).join(''); 
                    document.getElementById('container-days').innerHTML = ALL_DAYS.map(d => `<button onclick="app.toggleConfigItem('shippingDays','${d}')" class="px-3 py-1 rounded text-xs font-bold border transition ${state.config.shippingDays.includes(d)?'bg-primary text-white border-primary shadow-neon':'bg-black/30 text-slate-400 border-white/10 hover:bg-white/5'}">${d}</button>`).join(''); 

                    lucide.createIcons();

                    // Validar estado inicial al renderizar
                    app.checkConfigStatus(); 
                },
            
            setTab: (t) => {
                    // --- BLOQUEO DE SEGURIDAD UX ---
                    if (t === 'share') {
                        const validation = app.validateConfig();
                        if (!validation.isValid) {
                            // Feedback UX: Listamos lo que falta
                            const missing = validation.errors.join(", ");
                            app.showToast(`⚠️ Falta configurar: ${missing}`);

                            // Efecto visual de error (sacudida) en la pestaña config
                            const configTab = document.getElementById('nav-config');
                            configTab.classList.add('animate-pulse', 'text-red-400');
                            setTimeout(() => configTab.classList.remove('animate-pulse', 'text-red-400'), 1000);

                            // Forzamos volver a config
                            app.setTab('config');
                            return;
                        }
                    }
                    // -------------------------------

                    ['config','share','orders'].forEach(x => { 
                        document.getElementById(`tab-${x}`).classList.add('hidden'); 
                        // Restauramos clases base
                        document.getElementById(`nav-${x}`).className = "nav-item p-3 rounded-lg text-sm font-bold text-left flex gap-3 items-center text-slate-400 hover:bg-white/5 hover:text-white transition whitespace-nowrap"; 
                    }); 

                    document.getElementById(`tab-${t}`).classList.remove('hidden'); 
                    // Clase activa
                    document.getElementById(`nav-${t}`).className = "nav-item p-3 rounded-lg text-sm font-bold bg-primary/10 text-primary border border-primary/20 text-left flex gap-3 items-center transition shadow-neon"; 

                    if(t === 'share') {
                        // Actualizamos visualmente el texto usando la misma lógica
                        document.getElementById('share-link').innerText = app.getShareUrl();
                    }

                    // Si entramos a config, chequeamos el estado visualmente
                    if(t==='config') app.checkConfigStatus();
                },
   
            init: () => {
                // Ya no buscamos merchant en URL
                const u = JSON.parse(SafeStorage.getItem('app_current_user'));
                
                // Ocultamos todas las vistas por defecto
                document.querySelectorAll('[id^="view-"]').forEach(el => el.classList.add('hidden'));

                if(u) {
                    state.user = u;
                    if(u.isAdmin) {
                        // Si es Admin Maestro
                        document.getElementById('view-admin').classList.remove('hidden');
                        app.adminLoadUsers();
                    } else {
                        // Si es Emprendedor
                        state.merchantId = u.uid;
                        document.getElementById('view-dashboard').classList.remove('hidden');
                        app.setTab('config');
                        app.loadData();
                    }
                } else {
                    // Si no hay usuario, mostrar Login
                    document.getElementById('view-auth').classList.remove('hidden');
                }
                lucide.createIcons();
            }
        };
        app.init();
    </script>
</body>
</html>
