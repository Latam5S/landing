<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <link rel="icon" type="image/x-icon" href="favicon.ico" />
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Latam5S</title>
    <meta name="description" content="La solución #1 para vendedores. Convierte chats en rótulos de envío y valida direcciones, DNI y agencias sin errores.">
    
    <meta property="og:title" content="Latam5S">
    <meta property="og:description" content="La solución #1 para emprendedores. Convierte chats en rótulos de envío y valida direcciones, DNI y agencias sin errores.">
    <meta property="og:image" content="brand.png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:url" content="https://complicidad.github.io/landing/login">
    <meta property="og:type" content="website">

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Latam5S">
    <meta name="twitter:description" content="La solución #1 para emprendedores. Convierte chats en rótulos de envío y valida direcciones, DNI y agencias sin errores.">
    <meta name="twitter:image" content="brand.png">

    <link rel="canonical" href="https://complicidad.github.io/landing/login" />
    
    <!-- Fuente Quicksand -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',     /* Azul eléctrico */
                        primary_glow: '#60A5FA',
                        secondary: '#10B981',   /* Verde éxito */
                        dark_bg: '#020617',     /* Negro profundo Slate-950 */
                        card_bg: '#0f172a',     /* Slate-900 */
                        glass: 'rgba(255, 255, 255, 0.03)',
                        glass_border: 'rgba(255, 255, 255, 0.08)',
                    },
                    fontFamily: {
                        sans: ['Quicksand', 'sans-serif'],
                    },
                    boxShadow: {
                        'neon': '0 0 20px rgba(59, 130, 246, 0.15)',
                        'neon-green': '0 0 20px rgba(16, 185, 129, 0.15)',
                    },
                    animation: {
                        'float': 'float 6s ease-in-out infinite',
                        'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-20px)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body { 
            font-family: "Quicksand", sans-serif; 
            background-color: #020617;
            color: #e2e8f0; /* Slate-200 */
        }
        
        /* Glassmorphism Utilities - UNIFICADO Y CONSISTENTE */
        .glass-panel {
            background: rgba(15, 23, 42, 0.7); /* Base oscura sólida */
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-right: 1px solid rgba(255, 255, 255, 0.08);
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        }

        /* Glassmorphism Utilities - AHORA SÓLIDO (OPACO) */
        .glass-card {
            /* CAMBIO: Usamos colores HEX sólidos (#1e293b y #0f172a) en lugar de RGBA con transparencia */
            background: linear-gradient(145deg, #1e293b 0%, #0f172a 100%);
            
            /* El backdrop-filter ya no es necesario si el fondo es opaco, pero no daña dejarlo */
            /* backdrop-filter: blur(16px); */
            
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        /* Scrollbar Personalizada Dark */
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 2px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Modals & Sheets */
        .modal-enter { opacity: 0; transform: scale(0.95); }
        .modal-enter-active { opacity: 1; transform: scale(1); transition: opacity 0.2s, transform 0.2s; }

        /* Animations */
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        .slide-up { animation: slideUp 0.4s ease-out forwards; opacity: 0; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Busca esto en login.html y reemplázalo */
        @media print {
            /* CORRECCIÓN: Agregamos !important para anular el bg-dark_bg de Tailwind */
            body { 
                background-color: white !important; 
                color: black !important; 
                height: auto !important; /* Evita que ocupe el 100vh oscuro */
                overflow: visible !important;
            }
            
            /* Aseguramos que el fondo no se cuele por ningún lado */
            html { background-color: white !important; }
        
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            
            #print-area { 
                position: absolute; 
                left: 0; 
                top: 0; 
                width: 100%; 
                margin: 0; 
                padding: 0; 
                background-color: white !important; /* Fondo blanco forzado */
                display: block !important; 
                z-index: 9999; 
            }
            .no-print { display: none !important; }
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
        }

        /* Canvas Background */
        #particles-js {
            position: fixed;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            z-index: 0; /* Detrás de todo */
            pointer-events: none; /* Click-through */
        }

        .logo-text-gradient {
            /* Degradado horizontal para el texto Latam5S (simula las redes sociales) */
            background: linear-gradient(to right, #3B82F6, #60A5FA, #2DD4BF, #10B981); 
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text; /* Compatible con otros navegadores */
            color: transparent; /* Fallback */
        }
        
    </style>
</head>
<body class="bg-dark_bg text-slate-200 h-[100dvh] overflow-hidden flex flex-col selection:bg-primary selection:text-white relative">

    <!-- CANVAS DE FONDO (PARTÍCULAS) -->
    <canvas id="particles-js"></canvas>

    <!-- OVERLAY CARGA -->
    <div id="loading-overlay" class="fixed inset-0 bg-dark_bg/95 z-[9999] flex flex-col items-center justify-center transition-opacity duration-300 hidden pointer-events-none opacity-0 backdrop-blur-sm">
        <div class="relative">
            <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-primary shadow-neon"></div>
            <div class="absolute top-0 left-0 h-16 w-16 rounded-full border-t-2 border-b-2 border-primary opacity-50 animate-pulse"></div>
        </div>
        <p id="loading-text" class="text-primary font-bold mt-6 animate-pulse tracking-widest text-xs uppercase">Conectando...</p>
    </div>

    <!-- MODAL CONFIRMACIÓN GENÉRICO (Glass Unificado) -->
    <div id="modal-confirm" class="fixed inset-0 z-[100] bg-black/80 backdrop-blur-md hidden flex items-center justify-center transition-opacity duration-200 opacity-0">
        <div id="modal-card" class="glass-card rounded-3xl p-8 max-w-sm w-full mx-4 transform scale-95 transition-transform duration-200">
            <div class="w-14 h-14 bg-primary/20 rounded-full flex items-center justify-center mb-6 text-primary mx-auto shadow-neon border border-primary/20">
                <i data-lucide="alert-circle" class="w-7 h-7"></i>
            </div>
            <h3 class="text-xl font-bold text-white mb-3 text-center">Confirmación</h3>
            <p id="modal-msg" class="text-slate-400 text-sm mb-8 leading-relaxed text-center">...</p>
            <div class="flex gap-3">
                <button onclick="app.closeModal('modal-confirm')" class="flex-1 py-3 rounded-xl font-bold text-slate-400 hover:text-white hover:bg-white/5 transition border border-white/10">Cancelar</button>
                <button id="modal-btn-confirm" class="flex-1 py-3 rounded-xl font-bold bg-primary text-white hover:bg-blue-600 transition shadow-neon">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- MODAL SELECCIÓN DE ESTADO (Glass Unificado) -->
    <div id="modal-status" class="fixed inset-0 z-[100] bg-black/80 backdrop-blur-md hidden flex items-center justify-center transition-opacity duration-200 opacity-0">
        <div id="modal-status-card" class="glass-card w-full max-w-sm rounded-3xl p-8 shadow-2xl transform scale-95 transition-transform duration-200 mx-4">
            <h3 class="text-xl font-bold text-white mb-2 text-center">Actualizar Estado</h3>
            <p class="text-xs text-slate-400 text-center mb-6">Se aplicará a los elementos seleccionados.</p>
            <div class="space-y-4">
                <button onclick="app.setStatus('ENVIADO')" class="w-full py-4 rounded-xl font-bold bg-secondary/20 text-secondary hover:bg-secondary/30 border border-secondary/30 flex items-center justify-center gap-3 transition shadow-neon-green">
                    <i data-lucide="truck" class="w-5 h-5"></i> MARCAR COMO ENVIADO
                </button>
                <button onclick="app.setStatus('PENDIENTE')" class="w-full py-4 rounded-xl font-bold bg-yellow-500/20 text-yellow-400 hover:bg-yellow-500/30 border border-yellow-500/30 flex items-center justify-center gap-3 transition">
                    <i data-lucide="clock" class="w-5 h-5"></i> MARCAR COMO PENDIENTE
                </button>
                <button onclick="app.closeModal('modal-status')" class="w-full py-3 rounded-xl font-bold text-slate-400 hover:text-white hover:bg-white/5 mt-2 transition border border-white/10">Cancelar</button>
            </div>
        </div>
    </div>
    
    <!-- MODAL UPSELL (Plan Limitado) -->
    <div id="modal-upsell" class="fixed inset-0 z-[100] bg-black/90 backdrop-blur-lg hidden flex items-center justify-center transition-opacity duration-200 opacity-0">
        <div id="modal-upsell-card" class="glass-card rounded-3xl p-8 max-w-sm w-full mx-4 transform scale-95 transition-transform duration-200 border-2 border-primary/30 shadow-[0_0_50px_rgba(59,130,246,0.2)]">
            <div class="w-16 h-16 bg-primary/20 rounded-full flex items-center justify-center mb-6 text-primary mx-auto shadow-neon border border-primary/20">
                <i data-lucide="crown" class="w-8 h-8"></i>
            </div>
            <h3 class="text-2xl font-bold text-white mb-2 text-center">Plan Pro</h3>
            <p class="text-slate-300 text-sm mb-6 leading-relaxed text-center">
                Desbloquea el historial ilimitado y accede a todas las funciones avanzadas de Latam5s.
            </p>
            <div class="space-y-3">
                <button onclick="app.activateTrial()" class="w-full py-4 rounded-xl font-bold bg-gradient-to-r from-primary to-indigo-600 text-white hover:scale-[1.02] transition shadow-neon flex items-center justify-center gap-2">
                   <i data-lucide="sparkles" class="w-4 h-4"></i> Actualizar Plan
                </button>
                <button onclick="app.closeModal('modal-upsell')" class="w-full py-3 rounded-xl font-bold text-slate-400 hover:text-white hover:bg-white/5 transition">Entendido</button>
            </div>
        </div>
    </div>

    <!-- TOAST NOTIFICATION -->
    <div id="toast" class="fixed top-4 left-1/2 -translate-x-1/2 z-[100] glass-card border-l-4 border-secondary text-white px-6 py-3 rounded-xl shadow-neon-green flex items-center gap-3 transition-all duration-300 -translate-y-20 opacity-0">
        <i data-lucide="check-circle" class="w-5 h-5 text-secondary"></i>
        <span id="toast-msg" class="font-bold text-sm">Acción completada</span>
    </div>

    <!-- ÁREA DE IMPRESIÓN -->
    <div id="print-area" class="hidden bg-white p-4 text-black"></div>

    <!-- VISTA AUTH (Login) -->
    <div id="view-auth" class="flex-1 h-full flex flex-col items-center justify-center p-4 hidden overflow-y-auto no-print relative z-10">
        <div class="glass-card w-full max-w-md rounded-3xl shadow-2xl overflow-hidden slide-up my-auto relative z-10">
            <div class="bg-card_bg/50 p-8 text-center relative overflow-hidden border-b border-white/5">
                <div class="absolute top-0 right-0 p-4 opacity-5"><i data-lucide="box" class="w-32 h-32 text-white"></i></div>
                <div class="relative z-10">
                    <h1 class="text-3xl font-bold text-white tracking-tight logo-text-gradient">Latam5S</h1>
                    <div id="connection-status" class="inline-flex items-center gap-2 bg-white/5 px-4 py-1.5 rounded-full text-[10px] font-bold text-secondary mt-3 border border-white/5">
                        <span class="w-2 h-2 rounded-full bg-secondary animate-pulse"></span> Sistema Seguro
                    </div>
                </div>
            </div>

            <div class="p-8">
                <form onsubmit="app.handleLogin(event)" class="space-y-6">
                    <div class="space-y-2">
                        <label class="block text-xs font-bold text-primary uppercase tracking-wider ml-1">WhatsApp</label>
                        <input id="auth-phone" type="tel" required placeholder="Ingresa tu número" class="w-full bg-black/30 border border-white/10 text-white rounded-xl p-4 outline-none focus:border-primary focus:ring-1 focus:ring-primary transition placeholder-slate-600">
                    </div>
                    <div class="space-y-2">
                        <label class="block text-xs font-bold text-primary uppercase tracking-wider ml-1">Contraseña</label>
                        <input id="auth-pass" type="password" required placeholder="Ingresa tu contraseña" class="w-full bg-black/30 border border-white/10 text-white rounded-xl p-4 outline-none focus:border-primary focus:ring-1 focus:ring-primary transition placeholder-slate-600">
                    </div>
                    <button type="submit" class="w-full bg-primary hover:bg-blue-600 text-white font-bold py-4 rounded-xl shadow-neon transition active:scale-95 flex justify-center items-center gap-2 mt-4">
                        Iniciar Sesión
                    </button>
                </form>
                <p id="auth-error" class="text-red-400 text-xs text-center mt-4 font-bold hidden bg-red-500/10 py-2 rounded-lg border border-red-500/20"></p>
                <div class="mt-8 text-center text-xs text-slate-500 pt-4 border-t border-white/5">
                    Acceso exclusivo para socios registrados.
                </div>
            </div>
        </div>
        <div class="mt-8 text-[10px] font-bold text-slate-500 uppercase tracking-widest">
            Powered by Latam5S
        </div>
    </div>

    <!-- VISTA ADMIN -->
    <div id="view-admin" class="flex-1 flex flex-col h-full hidden no-print overflow-hidden z-10">
        <header class="glass-panel p-4 flex justify-between items-center shadow-lg z-20">
            <div class="flex items-center gap-3">
                <div class="bg-primary/20 p-2 rounded-lg text-primary border border-primary/20"><i data-lucide="shield" class="w-5 h-5"></i></div>
                <h1 class="font-bold text-lg text-white">Panel Admin</h1>
            </div>
            <button onclick="app.logout()" class="text-xs font-bold bg-white/5 hover:bg-white/10 text-white px-4 py-2 rounded-lg transition border border-white/5">Salir</button>
        </header>
        <main class="flex-1 p-4 md:p-8 overflow-y-auto max-w-5xl mx-auto w-full space-y-6 pb-20">
            <div class="glass-card p-6 rounded-3xl">
                <h2 class="text-lg font-bold text-white mb-4 flex items-center gap-2"><i data-lucide="user-plus" class="w-5 h-5 text-primary"></i> Alta de Emprendedor</h2>
                <form onsubmit="app.adminCreateUser(event)" class="flex flex-col md:flex-row gap-4 items-end">
                    <div class="flex-1 w-full">
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-2">WhatsApp del Cliente</label>
                        <input id="admin-new-phone" type="tel" required placeholder="Ej: 999888777" class="w-full bg-black/30 border border-white/10 text-white rounded-xl p-4 outline-none focus:border-primary transition">
                    </div>
                    <div class="w-full md:w-40">
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Plan</label>
                        <select id="admin-new-plan" class="w-full bg-black/30 border border-white/10 text-white rounded-xl p-4 outline-none focus:border-primary cursor-pointer">
                            <option value="Gratis" class="bg-card_bg">Gratis</option>
                            <option value="Pro" class="bg-card_bg">Pro</option>
                            <option value="Empresa" class="bg-card_bg">Empresa</option>
                        </select>
                    </div>
                    <button type="submit" class="w-full md:w-auto bg-primary text-white px-6 py-4 rounded-xl font-bold hover:bg-blue-600 transition flex items-center justify-center gap-2 shadow-neon">
                        <i data-lucide="zap" class="w-4 h-4"></i> Crear
                    </button>
                </form>
            </div>
            <div class="glass-card rounded-3xl overflow-hidden">
                <div class="p-6 border-b border-white/5 flex justify-between items-center">
                    <h2 class="text-lg font-bold text-white">Usuarios Registrados</h2>
                    <button onclick="app.adminLoadUsers()" class="p-2 hover:bg-white/5 rounded-full text-slate-400 hover:text-white transition"><i data-lucide="refresh-cw" class="w-4 h-4"></i></button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-slate-300">
                        <thead class="bg-black/20 text-slate-400 uppercase text-xs font-bold">
                            <tr><th class="px-6 py-4">WhatsApp</th><th class="px-6 py-4">Plan</th><th class="px-6 py-4">Fecha Alta</th><th class="px-6 py-4 text-right">Acciones</th></tr>
                        </thead>
                        <tbody id="admin-users-list" class="divide-y divide-white/5"></tbody>
                    </table>
                </div>
            </div>
            <div class="text-center text-[10px] text-slate-500 mt-8 uppercase font-bold tracking-widest">
                Powered by Latam5S
            </div>
        </main>
    </div>

    <!-- VISTA DASHBOARD (EMPRENDEDOR) -->
    <div id="view-dashboard" class="flex-1 flex flex-col md:flex-row h-full hidden no-print overflow-hidden z-10">
        <aside class="w-full md:w-72 glass-panel md:border-r border-b border-white/5 flex flex-col shadow-lg z-20 flex-shrink-0">
            <!-- HEADER ADAPTATIVO -->
            <div class="p-4 md:p-6 border-b border-white/5 flex justify-between items-center bg-black/20">
                <div class="flex items-center gap-3">
                    <div class="bg-secondary/10 p-2 rounded-xl text-secondary border border-secondary/20 shadow-neon-green"><i data-lucide="package" class="w-6 h-6"></i></div>
                    <div>
                        <h1 class="font-bold text-lg text-white leading-tight">Mi Panel</h1>
                        <p class="text-xs text-slate-400 hidden md:block">Emprendedor</p>
                    </div>
                </div>
                <!-- CONTROLES SOLO MÓVIL -->
                <div class="flex items-center gap-3 md:hidden">
                    <div class="text-right">
                        <p class="user-phone-display text-xs font-bold text-slate-300">...</p>
                        <p class="user-plan-display text-[10px] font-bold text-primary bg-primary/10 px-2 py-0.5 rounded border border-primary/20">...</p>
                    </div>
                    <button onclick="app.logout()" class="bg-red-500/10 text-red-400 p-2 rounded-lg hover:bg-red-500/20 transition border border-red-500/20">
                        <i data-lucide="log-out" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>

            <nav class="flex md:flex-col p-2 gap-1 overflow-x-auto no-scrollbar">
                <button onclick="app.setTab('config')" id="nav-config" class="nav-item p-3 rounded-lg text-sm font-bold text-left flex gap-3 items-center text-slate-400 hover:bg-white/5 hover:text-white transition whitespace-nowrap"><i data-lucide="settings" class="w-4 h-4"></i> Configurar</button>
                <button onclick="app.setTab('share')" id="nav-share" class="nav-item p-3 rounded-lg text-sm font-bold text-left flex gap-3 items-center text-slate-400 hover:bg-white/5 hover:text-white transition whitespace-nowrap"><i data-lucide="share-2" class="w-4 h-4"></i> Compartir</button>
                <button onclick="app.setTab('orders')" id="nav-orders" class="nav-item p-3 rounded-lg text-sm font-bold text-left flex gap-3 items-center text-slate-400 hover:bg-white/5 hover:text-white transition whitespace-nowrap"><i data-lucide="truck" class="w-4 h-4"></i> Envíos</button>
            </nav>
            
            <!-- FOOTER ESCRITORIO -->
            <div class="mt-auto p-4 border-t border-white/5 hidden md:block bg-black/20">
                <div class="flex items-center gap-3 mb-4">
                    <div class="w-10 h-10 rounded-full bg-white/5 flex items-center justify-center text-slate-400 border border-white/5"><i data-lucide="phone" class="w-5 h-5"></i></div>
                    <div class="overflow-hidden">
                        <p class="user-phone-display text-sm font-bold text-white truncate">...</p>
                        <p class="user-plan-display text-[10px] font-bold text-primary uppercase tracking-wide bg-primary/10 px-2 py-0.5 rounded w-fit mt-1 border border-primary/20">PLAN GRATIS</p>
                    </div>
                </div>
                <button onclick="app.logout()" class="w-full text-red-400 text-xs font-bold hover:bg-red-500/10 py-3 rounded-xl transition border border-transparent hover:border-red-500/20">Cerrar Sesión</button>
                <div class="text-center text-[9px] text-slate-500 mt-4 uppercase font-bold tracking-widest">
                    Powered by Latam5S
                </div>
            </div>
        </aside>
        
        <!-- Contenedor Principal -->
        <main class="flex-1 relative overflow-hidden flex flex-col">
            <!-- Decoración de fondo sutil -->
            <div class="absolute top-0 left-0 w-full h-full overflow-hidden pointer-events-none opacity-20">
                <div class="absolute top-[10%] right-[10%] w-64 h-64 bg-primary/30 rounded-full blur-[100px]"></div>
            </div>
            
            <!-- PESTAÑA CONFIGURACIÓN (Aplicado glass-card unificado, ancho completo) -->
            <div id="tab-config" class="tab-content w-full h-full overflow-y-auto p-4 md:p-8 hidden no-scrollbar z-10">
                <div class="max-w-7xl mx-auto slide-up pb-32">
                    <div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold text-white">Configuración</h2><button id="btn-save-config" onclick="app.saveConfig()" class="bg-primary text-white px-6 py-2.5 rounded-xl text-sm font-bold hover:bg-blue-600 transition flex gap-2 shadow-neon"><i data-lucide="save" class="w-4 h-4"></i> Guardar</button></div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Columna Izquierda: Datos y Seguridad -->
                        <div class="space-y-6">
                            <div class="glass-card p-6 rounded-3xl space-y-5">
                                <h3 class="font-bold text-primary uppercase text-xs tracking-wider mb-4 border-b border-white/5 pb-2">Datos Públicos</h3>
                                <div><label class="text-xs font-bold text-slate-400 uppercase mb-1 block">Nombre Emprendimiento</label><input id="inp-store-name" oninput="app.updateConfigInput('merchantName', this.value)" class="w-full bg-black/30 border border-white/10 rounded-xl p-4 text-white outline-none focus:border-primary transition"></div>
                              <div>
                                  <label class="text-xs font-bold text-slate-400 uppercase mb-1 block">WhatsApp Emprendimiento</label>
                                  <div class="relative">
                                      <span class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-500 font-bold text-sm">+51</span>
                                      <input id="inp-whatsapp" 
                                             type="tel" 
                                             maxlength="9" 
                                             placeholder="9..." 
                                             inputmode="numeric"
                                             oninput="app.formatWhatsapp(this)"
                                             class="w-full bg-black/30 border border-white/10 rounded-xl py-4 pr-4 pl-12 text-white outline-none focus:border-primary transition font-mono tracking-wider">
                                  </div>
                                  <p class="text-[10px] text-slate-500 mt-1 pl-1">Solo números, debe empezar con 9.</p>
                              </div>
                            </div>
                            
                            <div class="glass-card p-6 rounded-3xl">
                                <h3 class="font-bold text-primary uppercase text-xs tracking-wider mb-4 flex items-center gap-2 border-b border-white/5 pb-2"><i data-lucide="lock" class="w-3 h-3"></i> Seguridad</h3>
                                <div class="flex gap-3 items-end">
                                    <div class="flex-1">
                                        <label class="text-xs font-bold text-slate-400 uppercase mb-1 block">Nueva Contraseña</label>
                                        <input id="inp-new-pass" type="password" class="w-full bg-black/30 border border-white/10 rounded-xl p-4 text-white outline-none focus:border-primary transition">
                                    </div>
                                    <button id="btn-change-pass" onclick="app.changePassword()" class="bg-indigo-600 text-white px-6 py-3 rounded-xl text-sm font-bold hover:bg-indigo-700 transition h-[56px] shadow-lg">Actualizar</button>
                                </div>
                            </div>
                        </div>

                        <!-- Columna Derecha: Logística (Full Height) -->
                        <div class="flex flex-col">
                            <div class="glass-card p-6 rounded-3xl space-y-5 h-full relative">
                                <h3 class="font-bold text-primary uppercase text-xs tracking-wider mb-4 border-b border-white/5 pb-2">
                                    Logística <span class="text-red-400">*</span>
                                </h3>

                                <div>
                                    <label class="text-xs font-bold text-slate-400 uppercase block mb-2">Couriers Habilitados <span class="text-red-500">*</span></label>
                                    <div id="container-couriers" class="grid grid-cols-2 gap-2"></div>
                                </div>

                                <div>
                                    <label class="text-xs font-bold text-slate-400 uppercase block mt-2 mb-2">Días de Despacho <span class="text-red-500">*</span></label>
                                    <div id="container-days" class="flex flex-wrap gap-2"></div>
                                </div>

                                <div class="grid grid-cols-2 gap-4 mt-2">
                                    <div>
                                        <label class="text-xs font-bold text-slate-400 uppercase block mb-1">Hora Corte <span class="text-red-500">*</span></label>
                                        <div class="flex items-center gap-2 bg-black/20 p-3 rounded-xl border border-white/5">
                                            <i data-lucide="clock" class="w-4 h-4 text-primary"></i>
                                            <input type="time" id="inp-time" onchange="app.updateConfigInput('updateTime', this.value); app.checkConfigStatus()" class="bg-transparent text-sm text-white outline-none w-full cursor-pointer">
                                        </div>
                                    </div>

                                    <div>
                                        <label class="text-xs font-bold text-slate-400 uppercase block mb-1" title="Días de anticipación mínimos para el pedido">Anticipación (Días) <span class="text-red-500">*</span></label>
                                        <div class="flex items-center gap-2 bg-black/20 p-3 rounded-xl border border-white/5">
                                            <i data-lucide="calendar-clock" class="w-4 h-4 text-secondary"></i>
                                            <input type="number" id="inp-gap" min="0" max="30" placeholder="0" 
                                                   oninput="app.updateConfigInput('updateGap', this.value); app.checkConfigStatus()" 
                                                   class="bg-transparent text-sm text-white outline-none w-full placeholder-slate-600">
                                        </div>
                                    </div>
                                </div>

                                <p class="text-[10px] text-slate-500 leading-tight mt-2">
                                    <span class="text-primary">*</span> La "Anticipación" define cuántos días mínimos de margen necesitas para preparar el pedido antes del día de envío.
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="text-center text-[10px] text-slate-500 uppercase font-bold tracking-widest pt-8">
                        Powered by Latam5S
                    </div>
                </div>
            </div>
            
            <!-- PESTAÑA COMPARTIR (Ya tenía glass-card, se mantiene igual) -->
            <div id="tab-share" class="tab-content w-full h-full overflow-y-auto p-4 hidden no-scrollbar z-10">
                <div class="min-h-full flex flex-col items-center justify-center py-8 pb-32">
                    <div class="glass-card p-8 rounded-3xl text-center max-w-md w-full slide-up border border-white/10">
                        <div class="w-20 h-20 bg-secondary/10 rounded-full flex items-center justify-center mx-auto mb-6 text-secondary border border-secondary/20 shadow-neon-green"><i data-lucide="share-2" class="w-10 h-10"></i></div>
                        
                        <h2 class="text-2xl font-bold mb-4 text-white">¡Listo para compartir!</h2>
                        <p class="text-slate-400 text-sm mb-8 leading-relaxed">
                            Tu formulario personalizado está activo. Comparte el siguiente enlace con tus clientes.
                        </p>

                        <div class="bg-black/30 p-4 rounded-xl border border-white/10 mb-8 break-all font-mono text-primary select-all cursor-pointer hover:bg-black/40 transition" onclick="app.copyLink()"><code id="share-link" class="text-xs font-bold">...</code></div>
                        
                        <div class="space-y-4">
                            <button id="btn-copy-link" onclick="app.copyLink()" class="w-full bg-primary text-white py-4 rounded-xl font-bold hover:bg-blue-600 transition shadow-neon">Copiar Link</button>
                            <button onclick="app.shareOnWhatsapp()" class="w-full bg-secondary/20 text-secondary py-4 rounded-xl font-bold hover:bg-secondary/30 transition flex items-center justify-center gap-3 border border-secondary/20">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                                  <path d="M13.601 2.326A7.854 7.854 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.933 7.933 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.898 7.898 0 0 0 13.6 2.326zM7.994 14.521a6.573 6.573 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 0 1 4.66 1.931 6.557 6.557 0 0 1 1.928 4.66c-.004 3.639-2.961 6.592-6.592 6.592zm3.615-4.934c-.197-.099-1.17-.578-1.353-.646-.182-.065-.315-.099-.445.099-.133.197-.513.646-.627.775-.114.133-.232.148-.43.05-.197-.1-.836-.308-1.592-.985-.59-.525-.985-1.175-1.103-1.372-.114-.198-.011-.304.088-.403.087-.088.197-.232.296-.346.1-.114.133-.198.198-.33.065-.134.034-.248-.015-.347-.05-.099-.445-1.076-.612-1.47-.16-.389-.323-.335-.445-.34-.114-.007-.247-.007-.38-.007a.729.729 0 0 0-.529.247c-.182.198-.691.677-.691 1.654 0 .977.71 1.916.81 2.049.098.133 1.394 2.132 3.383 2.992.47.205.84.326 1.129.418.475.152.904.129 1.246.08.38-.058 1.171-.48 1.338-.943.164-.464.164-.86.114-.943-.049-.084-.182-.133-.38-.232z"/>
                                </svg>
                                Enviar por WhatsApp
                            </button>
                            <button onclick="app.openClientLink()" class="w-full bg-white/5 text-white border border-white/10 py-4 rounded-xl font-bold hover:bg-white/10 transition flex items-center justify-center gap-2"><i data-lucide="external-link" class="w-4 h-4"></i> Abrir en nueva pestaña</button>
                        </div>
                    </div>
                    <div class="text-center text-[10px] text-slate-500 uppercase font-bold tracking-widest mt-8">
                        Powered by Latam5S
                    </div>
                </div>
            </div>
            
            <!-- PESTAÑA ENVÍOS (Actualizada a rounded-3xl) -->
            <div id="tab-orders" class="tab-content hidden w-full h-full flex flex-col p-3 md:p-8 z-10">
                
                <!-- Toolbar Compacta Glass -->
                <div class="glass-card p-4 rounded-3xl mb-3 flex flex-col gap-3 flex-shrink-0">
                    <!-- Línea 1: Filtros -->
                    <div class="flex gap-2">
                        <div class="relative flex-grow">
                            <i data-lucide="search" class="absolute left-3 top-2.5 w-4 h-4 text-slate-400"></i>
                            <input id="inp-search-orders" oninput="app.renderOrders()" class="w-full pl-9 pr-3 py-2 bg-black/30 border border-white/10 rounded-xl text-sm text-white focus:border-primary outline-none placeholder-slate-500" placeholder="Buscar cliente, DNI, ref...">
                        </div>
                        <input type="date" id="date-specific" onchange="app.renderOrders()" class="bg-black/30 border border-white/10 rounded-xl px-2 py-2 text-sm w-32 text-white focus:border-primary outline-none flex-shrink-0">
                    </div>
                    
                    <!-- Línea 2: Herramientas -->
                    <div class="flex items-center gap-2 overflow-x-auto no-scrollbar pb-1">
                        <button onclick="app.toggleAllSelection()" class="px-3 py-2 bg-white/5 hover:bg-white/10 border border-white/10 text-slate-300 rounded-lg text-xs font-bold whitespace-nowrap flex items-center gap-2 flex-shrink-0 transition">
                            <i data-lucide="check-square" class="w-4 h-4"></i> <span class="hidden sm:inline">Todo</span>
                        </button>
                        
                        <div class="h-6 w-px bg-white/10 mx-1 flex-shrink-0"></div>
                        
                        <button onclick="app.printLabels()" class="px-3 py-2 bg-white/5 text-slate-300 border border-white/10 rounded-lg font-bold hover:bg-white/10 transition flex items-center justify-center gap-2 text-xs flex-shrink-0">
                            <i data-lucide="printer" class="w-4 h-4"></i> <span class="hidden sm:inline">Etiquetas</span>
                        </button>
                        <button onclick="app.exportExcel()" class="px-3 py-2 bg-secondary/10 text-secondary border border-secondary/20 rounded-lg font-bold hover:bg-secondary/20 transition flex items-center justify-center gap-2 text-xs flex-shrink-0">
                            <i data-lucide="file-spreadsheet" class="w-4 h-4"></i> <span class="hidden sm:inline">Excel</span>
                        </button>
                        <button onclick="app.loadOrders()" class="px-3 py-2 bg-white/5 border border-white/10 rounded-lg hover:bg-white/10 text-slate-300 flex-shrink-0 transition">
                            <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                        </button>

                        <div class="h-6 w-px bg-white/10 mx-1 flex-shrink-0"></div>

                        <button onclick="app.openStatusMenu()" class="px-3 py-2 bg-primary/80 hover:bg-primary text-white rounded-lg text-xs font-bold whitespace-nowrap flex items-center gap-1 flex-shrink-0 shadow-neon transition">
                            <i data-lucide="plus-circle" class="w-4 h-4"></i> <span class="hidden sm:inline">Estado</span>
                        </button>
                        <button onclick="app.deleteSelected()" class="px-3 py-2 bg-red-500/10 hover:bg-red-500/20 text-red-400 border border-red-500/20 rounded-lg text-xs font-bold whitespace-nowrap flex items-center gap-2 flex-shrink-0 transition">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>

                <!-- Lista Glass -->
                <div class="flex-1 min-h-0 flex flex-col glass-card rounded-3xl relative">
                    <div class="overflow-y-auto p-2 space-y-1 h-full pb-32 custom-scrollbar" id="orders-list">
                        <!-- Items -->
                    </div>
                    <!-- AVISO DEL PLAN GRATIS (SE MUESTRA SOLO SI EL PLAN ES GRATIS) -->
                     <div id="plan-limit-warning" class="hidden absolute inset-0 p-6 bg-dark_bg/90 backdrop-blur-md z-30 flex flex-col items-center justify-center text-center rounded-3xl">
                        <div class="w-16 h-16 bg-primary/20 rounded-full flex items-center justify-center mb-6 text-primary mx-auto shadow-neon border border-primary/20 animate-pulse">
                            <i data-lucide="lock" class="w-8 h-8"></i>
                        </div>
                        <h3 class="text-lg font-bold text-white mb-2">Plan Gratuito Limitado</h3>
                        <p class="text-sm text-slate-400 mb-6 font-medium">
                            La visualización de respuestas no está incluida en su plan actual.
                        </p>
                        <button onclick="app.showUpgradeModal()" class="bg-gradient-to-r from-primary to-indigo-600 text-white px-8 py-4 rounded-xl font-bold shadow-neon hover:scale-105 transition flex items-center gap-2">
                           <i data-lucide="sparkles" class="w-4 h-4"></i> Actualizar para ver <span id="hidden-count">0</span> registros
                        </button>
                        <p class="text-[11px] text-slate-500 mt-6 leading-relaxed max-w-xs mx-auto border-t border-white/5 pt-4">
                            Todas tus respuestas serán visibles aquí, incluidas las conversaciones que se descarten en WhatsApp. Con el plan gratuito, solo se almacenan 2 meses de respuestas.
                        </p>
                    </div>
                </div>
                
                <div class="text-center text-[10px] text-slate-500 uppercase font-bold tracking-widest mt-4 md:hidden pb-2">
                    Powered by Latam5S
                </div>
            </div>
        </main>
    </div>

    <!-- VISTA CLIENTE (White Theme) -->
    <div id="view-client" class="flex-1 h-full hidden overflow-y-auto no-print bg-white text-slate-800 z-10">
        
        <div class="w-full max-w-2xl mx-auto min-h-[100dvh] bg-white flex flex-col relative">
            
            <div class="bg-slate-900 text-white p-4 sticky top-0 z-40 shadow-md flex items-center gap-4">
                <div class="w-10 h-10 bg-primary/20 rounded-full flex items-center justify-center text-primary shadow-neon border border-primary/20 flex-shrink-0">
                    <i data-lucide="shopping-bag" class="w-5 h-5"></i>
                </div>
                <div class="flex-1 min-w-0">
                    <h1 id="client-title" class="font-bold text-lg leading-tight truncate">Cargando...</h1>
                    <p class="text-xs text-slate-400">Datos de Envío</p>
                </div>
            </div>
                
            <div class="flex-1 p-5 md:p-8 flex flex-col gap-4">
                
                <div class="rounded-xl bg-orange-50 border border-orange-100 p-4 flex items-start gap-3 shadow-sm relative overflow-hidden">
                    
                    <div class="absolute -right-4 -top-4 w-16 h-16 bg-orange-100 rounded-full opacity-50 pointer-events-none"></div>
                
                    <div class="bg-white p-2 rounded-full text-orange-500 shadow-sm border border-orange-100 flex-shrink-0">
                        <i data-lucide="clock" class="w-5 h-5"></i>
                    </div>
                
                    <div class="flex-1 z-10">
                        <h3 class="text-xs font-bold text-orange-800 uppercase tracking-wide mb-0.5">Programación de Envíos</h3>
                        <p class="text-sm text-orange-900 leading-tight">
                            Asegura tu envío registrando tu datos antes de las <strong id="client-time" class="bg-orange-200 px-1.5 py-0.5 rounded text-orange-950">--:--</strong>.
                        </p>
                    </div>
                </div>
            
                <form id="client-form" onsubmit="app.submitOrder(event)" class="space-y-6 pb-4 flex-shrink-0">
                    <div id="block-identity" class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 relative z-30">
                         <label class="block text-xs font-bold text-primary uppercase tracking-wider mb-2">
                            <i data-lucide="phone" class="w-3 h-3 inline mr-1"></i> Tu WhatsApp
                        </label>
                        <div class="relative">
                            <span class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-500 font-bold text-sm">+51</span>
                            <input id="c-phone" 
                                type="tel" 
                                maxlength="9" 
                                inputmode="numeric" 
                                placeholder="9..." 
                                oninput="app.handleClientPhone(this)"
                                required 
                                class="w-full bg-slate-50 border border-slate-200 rounded-xl py-4 pr-4 pl-12 text-slate-800 font-bold text-lg outline-none focus:border-primary focus:ring-2 focus:ring-primary/20 transition shadow-inner">
                            <div id="user-found-badge" class="hidden absolute right-3 top-1/2 -translate-y-1/2 bg-green-100 text-green-600 text-[10px] font-bold px-2 py-1 rounded-full flex items-center gap-1">
                                <i data-lucide="sparkles" class="w-3 h-3"></i> Hola
                            </div>
                        </div>
                        <p class="text-[10px] text-slate-400 mt-2 pl-1">Escribe tu número para cargar tus datos.</p>
                    </div>
            
                    <div id="progressive-content" class="space-y-6">
                        
                        <div id="block-service" class="hidden opacity-0 transition-all duration-500 transform translate-y-4 bg-white p-4 rounded-2xl shadow-sm border border-slate-100 relative z-20">
                            <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">¿Cómo quieres recibir tu pedido?</label>
                            <div class="relative">
                                <select id="c-courier-select" onchange="app.onCourierChange(this.value)" class="w-full appearance-none bg-slate-50 border border-slate-200 rounded-xl py-4 pl-4 pr-10 text-slate-800 font-bold focus:border-primary focus:ring-1 focus:ring-primary outline-none cursor-pointer transition">
                                    <option value="" disabled selected>Selecciona una opción...</option>
                                </select>
                                <div class="absolute inset-y-0 right-0 flex items-center px-4 pointer-events-none text-slate-500"><i data-lucide="chevron-down" class="w-5 h-5"></i></div>
                            </div>
                        </div>
            
                        <div id="dynamic-form-section" class="hidden space-y-4 transition-all duration-500">
                            <div id="fields-agency" class="hidden bg-white p-4 rounded-2xl shadow-sm border border-slate-100 space-y-4">
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Busca tu Agencia</label>
                                    <div class="relative group z-30">
                                        <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 h-5 w-5 text-slate-400"></i>
                                        <input id="c-agency" type="text" onfocus="app.revealStep('block-personal')" class="w-full bg-slate-50 border border-slate-200 text-slate-800 rounded-xl pl-12 pr-10 py-4 outline-none focus:border-primary transition placeholder-slate-400 font-medium" placeholder="Ej: Shalom Arequipa..." autocomplete="off" oninput="app.searchAgency(this.value)">
                                        <button type="button" id="btn-clear-agency" onclick="app.clearAgency()" class="hidden absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 p-1 hover:text-red-500"><i data-lucide="x" class="h-5 w-5"></i></button>
                                        <div id="agency-results" class="hidden absolute left-0 right-0 top-full mt-2 bg-white border border-slate-200 rounded-xl shadow-xl max-h-64 overflow-y-auto z-50 divide-y divide-slate-100"></div>
                                    </div>
                                </div>
                                <div>
                                     <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">DNI para recoger</label>
                                    <input id="c-dni" type="tel" maxlength="12" inputmode="numeric" oninput="this.value = this.value.replace(/[^0-9]/g, '')" class="w-full bg-slate-50 border border-slate-200 text-slate-800 rounded-xl p-4 outline-none focus:border-primary transition font-medium placeholder-slate-400" placeholder="Número de DNI">
                                </div>
                            </div>
                            <div id="fields-home" class="hidden bg-white p-4 rounded-2xl shadow-sm border border-slate-100 space-y-4">
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Distrito</label>
                                    <div class="relative group z-30">
                                        <i data-lucide="map-pin" class="absolute left-4 top-1/2 -translate-y-1/2 h-5 w-5 text-slate-400"></i>
                                        <input id="c-district" type="text" onfocus="app.revealStep('block-personal')" class="w-full bg-slate-50 border border-slate-200 text-slate-800 rounded-xl pl-12 pr-10 py-4 outline-none focus:border-primary transition placeholder-slate-400 font-medium" placeholder="Buscar Distrito..." autocomplete="off" oninput="app.searchDistrict(this.value)">
                                        <button type="button" id="btn-clear-district" onclick="app.clearDistrict()" class="hidden absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 p-1 hover:text-red-500"><i data-lucide="x" class="h-5 w-5"></i></button>
                                        <div id="district-results" class="hidden absolute left-0 right-0 top-full mt-2 bg-white border border-slate-200 rounded-xl shadow-xl max-h-64 overflow-y-auto z-50 divide-y divide-slate-100"></div>
                                    </div>
                                </div>
                                <div>
                                     <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Dirección Exacta</label>
                                    <input id="c-address" class="w-full bg-slate-50 border border-slate-200 text-slate-800 rounded-xl p-4 outline-none focus:border-primary transition font-medium placeholder-slate-400" placeholder="Calle, Av, Número...">
                                </div>
                                <div>
                                     <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Referencia</label>
                                    <input id="c-ref" class="w-full bg-slate-50 border border-slate-200 text-slate-800 rounded-xl p-4 outline-none focus:border-primary transition font-medium placeholder-slate-400" placeholder="Frente a, color de casa...">
                                </div>
                            </div>
                        </div>
            
                        <div id="block-personal" class="hidden opacity-0 transition-all duration-500 transform translate-y-4 bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
                             <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">¿A nombre de quién?</label>
                             <div class="relative">
                                <i data-lucide="user" class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400"></i>
                                <input id="c-name" oninput="app.revealStep('block-closing')" required class="w-full bg-slate-50 border border-slate-200 text-slate-800 rounded-xl pl-12 pr-4 py-4 outline-none focus:border-primary transition font-bold capitalize placeholder-slate-400" placeholder="Nombre Completo">
                             </div>
                        </div>
            
                        <div id="block-closing" class="hidden opacity-0 transition-all duration-500 transform translate-y-4 bg-white p-4 rounded-2xl shadow-sm border border-slate-100 space-y-4">
                             <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">¿Cuándo lo enviamos?</label>
                                <div class="relative">
                                    <select id="c-date-select" onchange="app.validateForm()" class="w-full appearance-none bg-slate-50 border border-slate-200 rounded-xl py-4 pl-4 pr-10 text-slate-800 font-bold focus:border-primary outline-none cursor-pointer transition">
                                        <option value="" disabled selected>Elige fecha...</option>
                                    </select>
                                    <div class="absolute inset-y-0 right-0 flex items-center px-4 pointer-events-none text-slate-500"><i data-lucide="calendar" class="w-5 h-5"></i></div>
                                </div>
                            </div>
                            <button type="submit" id="btn-submit-order" disabled class="w-full bg-secondary text-white font-bold py-5 rounded-xl shadow-lg shadow-green-500/20 transition active:scale-95 flex justify-center items-center gap-2 text-lg disabled:opacity-50 disabled:cursor-not-allowed hover:bg-green-600">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                                  <path d="M13.601 2.326A7.854 7.854 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.933 7.933 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.898 7.898 0 0 0 13.6 2.326zM7.994 14.521a6.573 6.573 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 0 1 4.66 1.931 6.557 6.557 0 0 1 1.928 4.66c-.004 3.639-2.961 6.592-6.592 6.592zm3.615-4.934c-.197-.099-1.17-.578-1.353-.646-.182-.065-.315-.099-.445.099-.133.197-.513.646-.627.775-.114.133-.232.148-.43.05-.197-.1-.836-.308-1.592-.985-.59-.525-.985-1.175-1.103-1.372-.114-.198-.011-.304.088-.403.087-.088.197-.232.296-.346.1-.114.133-.198.198-.33.065-.134.034-.248-.015-.347-.05-.099-.445-1.076-.612-1.47-.16-.389-.323-.335-.445-.34-.114-.007-.247-.007-.38-.007a.729.729 0 0 0-.529.247c-.182.198-.691.677-.691 1.654 0 .977.71 1.916.81 2.049.098.133 1.394 2.132 3.383 2.992.47.205.84.326 1.129.418.475.152.904.129 1.246.08.38-.058 1.171-.48 1.338-.943.164-.464.164-.86.114-.943-.049-.084-.182-.133-.38-.232z"/>
                                </svg>Enviar Datos por WhatsApp
                            </button>
                        </div>
                    </div>
                </form>
            
                <div id="success-view" class="hidden flex flex-col items-center justify-center min-h-[50vh] text-center p-6 animate-fade-in flex-grow">
                    <div class="w-24 h-24 bg-green-100 rounded-full flex items-center justify-center text-green-500 mb-6 shadow-sm">
                        <i data-lucide="check" class="w-12 h-12"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-slate-800 mb-2">¡Abriendo WhatsApp!</h2>
                    <p class="text-slate-500 text-sm mb-8 max-w-xs mx-auto leading-relaxed">
                        Tu envío ha sido generado correctamente. Continúa la conversación en el chat para finalizar.
                    </p>
                    <button onclick="app.resetClientView()" class="px-6 py-3 bg-white border border-slate-200 text-slate-700 font-bold rounded-xl hover:bg-slate-50 transition shadow-sm flex items-center gap-2">
                        <i data-lucide="plus" class="w-4 h-4"></i> Crear otro envío
                    </button>
                </div>
                                
                <div class="mt-auto pt-6 border-t border-slate-100 pb-2 md:pb-2">
                        <a href="index" target="_blank" class="group block bg-slate-50 hover:bg-blue-50/50 border border-slate-200 hover:border-blue-200 rounded-xl p-4 transition-all duration-300 transform hover:-translate-y-1">
                            <div class="flex items-center justify-center gap-4">
                                <div class="w-12 h-12 rounded-full bg-gradient-to-br from-primary to-secondary flex items-center justify-center font-bold text-2xl shadow-lg text-white transition-transform group-hover:scale-110">5S</div>
                                <div class="text-left">
                                    <p class="text-[10px] uppercase font-bold text-gray-400 tracking-wider mb-0.5">Powered by Latam5S</p>
                                    <p class="text-sm font-bold text-slate-800 group-hover:text-primary transition-colors leading-tight">
                                        ¿Vendes por WhatsApp? <br>
                                        <span class="text-primary underline decoration-blue-200 underline-offset-2">Crea tu formulario gratis aquí</span>
                                    </p>
                                </div>
                                
                                <div class="text-gray-300 group-hover:text-primary transition-colors">
                                    <i data-lucide="chevron-right" class="w-5 h-5"></i>
                                </div>
                            </div>
                        </a>
                    </div>
            
            </div>
        </div>
    </div>
        
    <script>
        // feather.replace();

        // ----------------------------------------------------
        // CLIENTE API ROBUSTO (Manejo de Errores y Reintentos)
        // ----------------------------------------------------
        const ApiService = {
            // Configuración
            URL: "https://script.google.com/macros/s/AKfycby0K7KPmM4v2mPnQBueE9dBBGfp37JAT9I6uqtqj_lChn9Vg1fMeK_P52FPgvxn_pvWsg/exec",
            
            async request(action, payload = {}, retries = 1) {
                const controller = new AbortController();
                // 15 segundos timeout
                const timeoutId = setTimeout(() => controller.abort(), 15000); 

                try {
                    // Siempre usamos POST para evitar caché y límites de URL
                    const response = await fetch(this.URL, {
                        method: "POST",
                        body: JSON.stringify({ action, ...payload }),
                        signal: controller.signal
                    });
                    
                    clearTimeout(timeoutId);

                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    
                    const json = await response.json();
                    
                    // Si el backend dice error, lanzamos excepción
                    if (json.status === 'error') throw new Error(json.message || 'Error del servidor');
                    
                    return json;

                } catch (error) {
                    clearTimeout(timeoutId);
                    console.warn(`[API] Fallo intento (${retries} restantes):`, error);

                    // Si quedan reintentos, esperamos y probamos de nuevo
                    if (retries > 0) {
                        await new Promise(r => setTimeout(r, 1500)); // Espera 1.5s
                        return this.request(action, payload, retries - 1);
                    }

                    // Si no, lanzamos el error final para que la UI lo muestre
                    throw error;
                }
            }
        };

        // ----------------------------------------------------
        // LÓGICA DE LA APLICACIÓN (Actualizada para usar ApiService)
        // ----------------------------------------------------
        
        // Configuración de Datos Estáticos
        const JSON_DISTRITOS = "lstDistritos.json";
        const AGENCY_URLS = {
            "Shalom": "lstShalom.json",
            "Olva Courier": "lstOlvaCourier.json",
            "Marvisur": "lstMarvisur.json"
        };
        const COURIER_TYPES = { 
            "Shalom": "agency", "Olva Courier": "agency", "Marvisur": "agency", "Delivery": "home"
        };
        const ALL_COURIERS = ["Shalom", "Olva Courier", "Marvisur", "Delivery"];
        const ALL_DAYS = ["Lun", "Mar", "Mié", "Jue", "Vie", "Sáb", "Dom"];
        const DAY_INDEX_MAP = { "Dom": 0, "Lun": 1, "Mar": 2, "Mié": 3, "Jue": 4, "Vie": 5, "Sáb": 6 };
        const DAY_NAMES_FULL = ["Domingo", "Lunes", "Martes", "Miércoles", "Jueves", "Viernes", "Sábado"];
        const MONTH_NAMES = ["Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"];

        const SafeStorage = { 
            memory: {}, 
            setItem: function(k, v) { try { localStorage.setItem(k, v); } catch(e) { this.memory[k] = v; } }, 
            getItem: function(k) { try { return localStorage.getItem(k); } catch(e) { return this.memory[k] || null; } }, 
            removeItem: function(k) { try { localStorage.removeItem(k); } catch(e) { delete this.memory[k]; } } 
        };

        const initialState = { merchantName: "", whatsapp: "", couriers: [], shippingDays: [], updateTime: "18:00", updateGap: "0" };
        const state = { user: null, merchantId: null, isClientView: false, config: { ...initialState }, selectedCourierType: null, externalData: {}, allOrders: [], selectedOrders: new Set(), visibleOrders: [] };

        const escapeHtml = (unsafe) => {
            if (typeof unsafe !== 'string') return unsafe;
            return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        };

        window.app = {
            // --- UI HELPERS ---
            revealStep: (id) => { const el = document.getElementById(id); if (el && el.classList.contains('hidden')) { el.classList.remove('hidden'); setTimeout(() => el.classList.remove('opacity-0', 'translate-y-4'), 50); } },
            toggleLoading: (show) => { const el = document.getElementById('loading-overlay'); show ? (el.classList.remove('hidden'), setTimeout(()=>el.classList.remove('opacity-0'),10)) : (el.classList.add('opacity-0'), setTimeout(()=>el.classList.add('hidden'),300)); },
            showToast: (msg) => { const el = document.getElementById('toast'); document.getElementById('toast-msg').innerText = msg; el.classList.remove('opacity-0', '-translate-y-20'); setTimeout(() => el.classList.add('opacity-0', '-translate-y-20'), 3000); },
            
            showModal: (msg, callback) => {
                const el = document.getElementById('modal-confirm'), card = document.getElementById('modal-card');
                document.getElementById('modal-msg').innerText = msg;
                document.getElementById('modal-btn-confirm').onclick = () => { callback(); app.closeModal('modal-confirm'); };
                el.classList.remove('hidden'); setTimeout(() => { el.classList.remove('opacity-0'); card.classList.remove('scale-95'); card.classList.add('scale-100'); }, 10);
            },
            closeModal: (modalId) => {
                const el = document.getElementById(modalId); if (!el) return; const card = el.firstElementChild; 
                el.classList.add('opacity-0'); if(card) { card.classList.remove('scale-100'); card.classList.add('scale-95'); }
                setTimeout(() => el.classList.add('hidden'), 300);
            },

            // --- AUTH ---
            handleLogin: async (e) => { 
                e.preventDefault(); 
                const p = document.getElementById('auth-phone').value.trim();
                const pw = document.getElementById('auth-pass').value.trim();
                const err = document.getElementById('auth-error'); 
                
                app.toggleLoading(true); 
                try { 
                    // USO DE APISERVICE
                    const res = await ApiService.request("loginUser", { data: { phone: p, password: pw } });
                    app.loginSuccess(res.user); 
                } catch(e) { 
                    console.error(e); 
                    err.innerText = e.message || "Error de conexión"; 
                    err.classList.remove('hidden'); 
                } finally {
                    app.toggleLoading(false); 
                }
            },
            loginSuccess: (u) => { state.user = u; SafeStorage.setItem('app_current_user', JSON.stringify(u)); app.init(); },
            logout: () => { SafeStorage.removeItem('app_current_user'); state.user=null; state.merchantId=null; window.location.reload(); },

            // --- ADMIN ---
            adminLoadUsers: async () => { 
                const l = document.getElementById('admin-users-list'); 
                const secretToken = state.user && state.user.token ? state.user.token : null;
                if (!secretToken) { l.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-red-400">⛔ Error de sesión</td></tr>'; return; }
                
                l.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-slate-400">Cargando...</td></tr>'; 
                app.toggleLoading(true);
                
                try { 
                    const res = await ApiService.request("getUsers", { adminSecret: secretToken });
                    const u = res.users || [];
                    l.innerHTML = u.length ? u.map(user => `<tr class="bg-white border-b hover:bg-slate-50"><td class="px-6 py-4 font-bold text-slate-700">${escapeHtml(user.phone)}</td><td class="px-6 py-4"><span class="bg-indigo-100 text-indigo-800 text-xs font-bold px-2 py-1 rounded">${escapeHtml(user.plan||'Gratis')}</span></td><td class="px-6 py-4 text-xs text-slate-400">${user.createdAt ? new Date(user.createdAt).toLocaleDateString() : '-'}</td><td class="px-6 py-4 text-right flex gap-2 justify-end"><button onclick="app.adminResend('${escapeHtml(user.uid)}','${escapeHtml(user.phone)}')" class="text-indigo-600 text-xs font-bold hover:bg-indigo-50 px-2 py-1 rounded">Clave</button><select onchange="app.adminUpdatePlan('${escapeHtml(user.uid)}', this.value)" class="text-xs border rounded p-1 bg-slate-50 cursor-pointer outline-none"><option value="" disabled selected>Cambiar Plan</option><option value="Gratis">Gratis</option><option value="Pro">Pro</option><option value="Empresa">Empresa</option></select></td></tr>`).join('') : '<tr><td colspan="4" class="p-4 text-center">Sin usuarios</td></tr>'; 
                } catch(e){ 
                    l.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-red-400">Error: ' + e.message + '</td></tr>';
                } finally {
                    app.toggleLoading(false);
                }
            },
            adminCreateUser: async (e) => { 
                e.preventDefault(); 
                const p = document.getElementById('admin-new-phone').value.trim(), pl = document.getElementById('admin-new-plan').value; 
                app.toggleLoading(true); 
                const np = Math.floor(1000+Math.random()*9000).toString(); 
                try { 
                    await ApiService.request("registerUser", { data: { phone: p, password: np, plan: pl } });
                    window.open(`https://wa.me/51${p}?text=${encodeURIComponent(`🔐 Bienvenid@ (Plan ${pl})\n📱 User: ${p}\n🔑 Pass: *${np}*\nEntra: ${window.location.href}`)}`, '_blank'); 
                    document.getElementById('admin-new-phone').value=""; 
                    app.adminLoadUsers(); 
                    app.showToast('Usuario creado'); 
                } catch(e){ app.showToast(e.message); } finally { app.toggleLoading(false); }
            },
            adminUpdatePlan: (uid, newPlan) => { 
                app.showModal(`¿Cambiar plan a ${newPlan}?`, async () => {
                    app.toggleLoading(true); 
                    try { await ApiService.request("updateUserPlan", { merchantId: uid, newPlan: newPlan }); app.showToast('Plan actualizado'); app.adminLoadUsers(); } 
                    catch(e){ app.showToast(e.message); } 
                    finally { app.toggleLoading(false); }
                });
            },
            adminResend: (uid, phone) => { 
                app.showModal(`¿Resetear clave para ${phone}?`, async () => {
                    app.toggleLoading(true); const np = Math.floor(1000+Math.random()*9000).toString(); 
                    try { await ApiService.request("changePassword", { merchantId: uid, newPassword: np }); 
                    window.open(`https://wa.me/51${phone}?text=${encodeURIComponent(`🔐 *Recuperación:*\n📱Usuario: ${phone}\n🔑Nueva Clave: *${np}*`)}`, '_blank'); app.showToast('Clave reseteada'); } 
                    catch(e){ app.showToast(e.message); } finally { app.toggleLoading(false); }
                });
            },

            // --- CONFIGURACIÓN ---
            validateConfig: () => {
                const c = state.config; const errors = [];
                if (!c.merchantName || c.merchantName.length < 3) errors.push("Nombre emprendimiento");
                if (!c.whatsapp || !/^9\d{8}$/.test(c.whatsapp)) errors.push("Celular válido (9 dígitos)");
                if (!c.couriers || c.couriers.length === 0) errors.push("Un Courier");
                if (!c.shippingDays || c.shippingDays.length === 0) errors.push("Un día de envío");
                if (!c.updateTime) errors.push("Hora de corte");
                if (c.updateGap === "" || c.updateGap === null) errors.push("Días anticipación");
                return { isValid: errors.length === 0, errors: errors };
            },
            checkConfigStatus: () => {
                const validation = app.validateConfig();
                const navShare = document.getElementById('nav-share'); const icon = navShare.querySelector('i');
                if (validation.isValid) {
                    navShare.classList.remove('opacity-50', 'cursor-not-allowed'); navShare.classList.add('hover:bg-white/5', 'hover:text-white');
                    if(icon) icon.setAttribute('data-lucide', 'share-2');
                } else {
                    navShare.classList.add('opacity-50', 'cursor-not-allowed'); navShare.classList.remove('hover:bg-white/5', 'hover:text-white');
                    if(icon) icon.setAttribute('data-lucide', 'lock');
                }
                lucide.createIcons();
            },
            updateConfigInput: (key, value) => { state.config[key] = value; app.checkConfigStatus(); },
            formatWhatsapp: (el) => {
                let val = el.value.replace(/\D/g, ''); if (val.length > 0 && val.charAt(0) !== '9') val = val.substring(1);
                el.value = val; app.updateConfigInput('whatsapp', val);
                if (val.length > 0 && val.length < 9) { el.classList.add('border-red-500/50'); el.classList.remove('border-white/10'); } else { el.classList.remove('border-red-500/50'); el.classList.add('border-white/10'); }
            },
            toggleConfigItem: (k, v) => { 
                if (state.config[k].includes(v)) state.config[k] = state.config[k].filter(i => i !== v); else state.config[k].push(v); 
                app.renderDashboard(); app.checkConfigStatus();
            },
            saveConfig: async () => { 
                const nameInput = document.getElementById('inp-store-name'); let cleanName = nameInput.value.trim().replace(/\s+/g, ' '); nameInput.value = cleanName; app.updateConfigInput('merchantName', cleanName);
                const validation = app.validateConfig();
                if (!validation.isValid) { app.showToast(`⚠️ Falta: ${validation.errors.join(", ")}`); return; }

                const btn = document.getElementById('btn-save-config'); btn.disabled = true; btn.innerHTML = 'Guardando...'; app.toggleLoading(true);
                state.config.whatsapp = document.getElementById('inp-whatsapp').value; state.config.updateTime = document.getElementById('inp-time').value; state.config.updateGap = document.getElementById('inp-gap').value;
                SafeStorage.setItem(`config_${state.user.uid}`, JSON.stringify(state.config));
                
                try { 
                    await ApiService.request("saveConfig", { merchantId: state.user.uid, data: state.config });
                    app.showToast('Guardado correctamente'); 
                } catch(e){ app.showToast('Guardado local (Error red)'); } 
                finally { app.toggleLoading(false); btn.disabled = false; btn.innerHTML = '<i data-lucide="save" class="w-4 h-4"></i> Guardar'; lucide.createIcons(); }
            },
            changePassword: async () => {
                const newPass = document.getElementById('inp-new-pass').value.trim(); if (!newPass) return;
                app.showModal('¿Cambiar contraseña?', async () => {
                    app.toggleLoading(true); try { await ApiService.request("changePassword", { merchantId: state.user.uid, newPassword: newPass }); document.getElementById('inp-new-pass').value = ""; app.showToast('Contraseña actualizada'); } catch(e) { app.showToast(e.message); } finally { app.toggleLoading(false); }
                });
            },

            // --- CLIENTE (Formulario Público) ---
            handleClientPhone: (el) => {
                let val = el.value.replace(/\D/g, ''); if (val.length > 0 && val.charAt(0) !== '9') val = val.substring(1); el.value = val;
                if (val.length === 9) {
                    const cache = JSON.parse(SafeStorage.getItem('latam5s_client_cache') || '{}');
                    if (cache[val]) { document.getElementById('user-found-badge').classList.remove('hidden'); app.fillFromCache(cache[val]); app.showToast('Datos cargados ✨'); ['block-service', 'dynamic-form-section', 'block-personal', 'block-closing'].forEach((id, idx) => setTimeout(() => app.revealStep(id), idx * 100)); } 
                    else { document.getElementById('user-found-badge').classList.add('hidden'); app.revealStep('block-service'); }
                }
            },
            fillFromCache: (data) => {
                if(data.name) document.getElementById('c-name').value = data.name;
                if(data.courier) { const select = document.getElementById('c-courier-select'); if ([...select.options].some(o => o.value === data.courier)) { select.value = data.courier; app.onCourierChange(data.courier); } }
                setTimeout(() => { if(data.type === 'agency') { if(data.dni) document.getElementById('c-dni').value = data.dni; if(data.agency) { document.getElementById('c-agency').value = data.agency; document.getElementById('btn-clear-agency').classList.remove('hidden'); } } else { if(data.district) { document.getElementById('c-district').value = data.district; document.getElementById('btn-clear-district').classList.remove('hidden'); } if(data.address) document.getElementById('c-address').value = data.address; if(data.ref) document.getElementById('c-ref').value = data.ref; } app.validateForm(); }, 100);
            },
            saveToCache: (phone, data) => { const cache = JSON.parse(SafeStorage.getItem('latam5s_client_cache') || '{}'); cache[phone] = data; SafeStorage.setItem('latam5s_client_cache', JSON.stringify(cache)); },
            onCourierChange: (c) => { 
                const type = COURIER_TYPES[c] || "home"; state.selectedCourierType = type; state.selectedCourier = c; 
                document.getElementById('dynamic-form-section').classList.remove('hidden');
                const af = document.getElementById('fields-agency'), hf = document.getElementById('fields-home'); 
                ['c-dni','c-agency','c-address','c-district'].forEach(id => document.getElementById(id).removeAttribute('required'));
                if (type === 'agency') { af.classList.remove('hidden'); hf.classList.add('hidden'); document.getElementById('c-dni').setAttribute('required','true'); document.getElementById('c-agency').setAttribute('required','true'); document.getElementById('c-agency').value=""; app.loadAgencies(c); app.clearDistrict(); } 
                else { af.classList.add('hidden'); hf.classList.remove('hidden'); document.getElementById('c-address').setAttribute('required','true'); document.getElementById('c-district').setAttribute('required','true'); app.clearAgency(); app.clearDistrict(); } 
                app.validateForm(); 
            },
            submitOrder: async (e) => { 
                e.preventDefault(); 
                const dateSelect = document.getElementById('c-date-select'); const oldDate = dateSelect.value;
                app.generateDateOptions(); // Revalidar fecha al instante
                let finalDate = oldDate; let dateChanged = false; const options = Array.from(dateSelect.options).map(o => o.value);
                if (!options.includes(oldDate)) { if (dateSelect.options.length > 1) { dateSelect.selectedIndex = 1; finalDate = dateSelect.value; dateChanged = true; } }

                const phone = document.getElementById('c-phone').value.trim(), name = document.getElementById('c-name').value.trim(), day = finalDate;
                if (name.length < 3) { document.getElementById('c-name').focus(); return app.showToast("⚠️ Nombre inválido"); }
                if (!/^9\d{8}$/.test(phone)) { document.getElementById('c-phone').focus(); return app.showToast("⚠️ Celular inválido"); }
                
                let data = { clientName: name, clientPhone: phone, courier: state.selectedCourier, shippingDate: day, createdAt: Date.now() }; 
                let wa = "", dni = "";

                if (state.selectedCourierType === 'agency') { 
                    dni = document.getElementById('c-dni').value.trim(); const ag = document.getElementById('c-agency').value;
                    if (!/^\d{8,12}$/.test(dni)) return app.showToast("⚠️ DNI inválido"); if (ag.length < 3) return app.showToast("⚠️ Agencia inválida");
                    data.clientDni = dni; data.clientAgency = ag; 
                    wa = `📦 *ENVÍO (AGENCIA)*\n👤 ${name}\n📱 ${phone}\n🆔 ${dni}\n🏢 ${ag}\n🚚 ${state.selectedCourier}\n📅 ${day}`;
                } else { 
                    const ad = document.getElementById('c-address').value, ds = document.getElementById('c-district').value, rf = document.getElementById('c-ref').value; 
                    if (ds.length < 3 || ad.length < 5) return app.showToast("⚠️ Dirección inválida");
                    data.clientAddress = ad; data.clientDistrict = ds; data.clientRef = rf; 
                    wa = `📦 *ENVÍO (CASA)*\n👤 ${name}\n📱 ${phone}\n📍 ${ds}\n🏠 ${ad}\nRef: ${rf}\n🚚 ${state.selectedCourier}\n📅 ${day}`;
                }

                if (dateChanged) app.showToast('⚠️ Hora de corte superada: Fecha actualizada.');
                
                const cacheData = { name: name, courier: state.selectedCourier, type: state.selectedCourierType };
                if (state.selectedCourierType === 'agency') { cacheData.dni = dni; cacheData.agency = data.clientAgency; } else { cacheData.district = data.clientDistrict; cacheData.address = data.clientAddress; cacheData.ref = data.clientRef; }
                app.saveToCache(phone, cacheData);

                const whatsappUrl = `https://wa.me/51${state.config.whatsapp}?text=${encodeURIComponent(wa)}`;
                setTimeout(async () => {
                    window.open(whatsappUrl, '_blank');
                    try { await ApiService.request("saveOrder", { merchantId: state.merchantId, data: data }); } catch(e){} 
                    document.getElementById('client-form').classList.add('hidden'); document.getElementById('success-view').classList.remove('hidden');
                }, dateChanged ? 1500 : 0);
            },
            resetClientView: () => { window.location.reload(); },

            // --- PEDIDOS (DASHBOARD) ---
            loadOrders: async () => { 
                const l = document.getElementById('orders-list'); 
                l.innerHTML = '<div class="text-center py-10 text-slate-400 flex flex-col items-center gap-2"><i data-lucide="loader" class="animate-spin w-6 h-6"></i> Cargando...</div>'; lucide.createIcons();
                try { 
                    const res = await ApiService.request("getOrders", { merchantId: state.merchantId });
                    const userPlan = state.user ? state.user.plan : 'Gratis';
                    const isFree = userPlan === 'Gratis';
                    let rawOrders = res.orders || [];
                    
                    if (isFree) { state.allOrders = []; state.hasHiddenOrders = true; state.totalHiddenCount = rawOrders.length; } 
                    else { state.allOrders = rawOrders; state.hasHiddenOrders = false; state.totalHiddenCount = 0; }
                    state.selectedOrders.clear();
                    if(document.getElementById('hidden-count')) document.getElementById('hidden-count').innerText = state.totalHiddenCount;
                } catch(e){ state.allOrders = []; l.innerHTML = `<div class="text-center py-4 text-red-400">${e.message}</div>`; } 
                app.renderOrders();
            },
            renderOrders: () => {
                const l = document.getElementById('orders-list'); const q = (document.getElementById('inp-search-orders').value || '').toLowerCase(); const dSpec = document.getElementById('date-specific').value;
                const filtered = state.allOrders.filter(x => {
                    if (!`${x.clientName} ${x.clientPhone} ${x.clientDistrict||''} ${x.clientAgency||''}`.toLowerCase().includes(q)) return false;
                    if (dSpec) { const [y, m, d] = dSpec.split('-'); if (!x.shippingDate || !x.shippingDate.includes(`${d}/${m}`)) return false; }
                    return true;
                });
                state.visibleOrders = filtered;
                if (!filtered.length) { l.innerHTML = state.hasHiddenOrders ? '' : '<div class="text-center py-10 text-slate-400">Sin envíos</div>'; } else {
                    l.innerHTML = filtered.map((x) => {
                        const id = String(x.orderId || x.createdAt); const isSel = state.selectedOrders.has(id); const status = x.status || 'PENDIENTE';
                        const badgeClass = status === 'ENVIADO' ? 'bg-secondary/20 text-secondary border-secondary/30' : 'bg-yellow-500/20 text-yellow-400 border-yellow-500/30';
                        return `<div class="bg-black/30 border ${isSel ? 'border-primary bg-primary/10' : 'border-white/10'} p-3 rounded-lg flex gap-3 items-start mb-2"><div class="pt-1"><input type="checkbox" onchange="app.toggleOrderSelection('${id}')" ${isSel ? 'checked' : ''} class="w-4 h-4 rounded bg-black/40"></div><div class="flex-1 min-w-0"><div class="flex justify-between font-bold text-white"><span class="truncate">${escapeHtml(x.clientName)}</span><div class="flex items-center gap-2"><span class="text-[10px] px-2 py-0.5 rounded border ${badgeClass}">${status}</span><button onclick="app.sendClientSummary('${id}')" class="text-secondary hover:bg-secondary/20 p-1 rounded-full"><i data-lucide="message-circle" class="w-4 h-4"></i></button></div></div><div class="text-xs text-slate-400 mt-1 flex gap-3"><span class="flex items-center gap-1"><i data-lucide="calendar" class="w-3 h-3 text-primary"></i> ${escapeHtml(x.shippingDate)}</span><span class="flex items-center gap-1"><i data-lucide="truck" class="w-3 h-3 text-primary"></i> ${escapeHtml(x.courier)}</span></div><div class="text-xs text-slate-300 mt-2 font-medium border-t border-white/5 pt-2">${x.clientAgency ? `🏢 ${escapeHtml(x.clientAgency)}` : `🏠 ${escapeHtml(x.clientDistrict)}`}</div></div></div>`;
                    }).join('');
                }
                const w = document.getElementById('plan-limit-warning'); if(state.hasHiddenOrders) w.classList.remove('hidden'); else w.classList.add('hidden');
                lucide.createIcons();
            },
            toggleOrderSelection: (id) => { const s = String(id); if (state.selectedOrders.has(s)) state.selectedOrders.delete(s); else state.selectedOrders.add(s); app.renderOrders(); },
            toggleAllSelection: () => { const all = state.visibleOrders.every(x => state.selectedOrders.has(String(x.orderId || x.createdAt))); if (all) state.visibleOrders.forEach(x => state.selectedOrders.delete(String(x.orderId || x.createdAt))); else state.visibleOrders.forEach(x => state.selectedOrders.add(String(x.orderId || x.createdAt))); app.renderOrders(); },
            
            deleteSelected: () => {
                if (!state.selectedOrders.size) return app.showToast('Selecciona envíos');
                app.showModal(`¿Eliminar ${state.selectedOrders.size} envíos?`, async () => { app.toggleLoading(true); try { await ApiService.request("deleteOrders", { merchantId: state.merchantId, orderIds: Array.from(state.selectedOrders) }); app.showToast('Eliminados'); app.loadOrders(); } catch(e){ app.showToast(e.message); } finally { app.toggleLoading(false); } });
            },
            openStatusMenu: () => { if (!state.selectedOrders.size) return app.showToast('Selecciona envíos'); const el = document.getElementById('modal-status'), card = document.getElementById('modal-status-card'); el.classList.remove('hidden'); setTimeout(() => { el.classList.remove('opacity-0'); card.classList.remove('scale-95'); card.classList.add('scale-100'); }, 10); },
            setStatus: (s) => { app.closeModal('modal-status'); app.showModal(`¿Marcar como ${s}?`, async () => { app.toggleLoading(true); try { await ApiService.request("updateOrdersStatus", { merchantId: state.merchantId, orderIds: Array.from(state.selectedOrders), newStatus: s }); app.showToast('Actualizado'); app.loadOrders(); } catch(e){ app.showToast(e.message); } finally { app.toggleLoading(false); } }); },
            
            sendClientSummary: (oid) => {
                const o = state.allOrders.find(x => String(x.orderId||x.createdAt) === String(oid)); if(!o) return;
                const msg = `Hola *${o.clientName}*! 👋\nTu pedido está *${o.status === 'ENVIADO' ? 'Enviado ✅' : 'Programado 📦'}*\n📅 Fecha: ${o.shippingDate}\n🚚 Courier: ${o.courier}\n${o.clientAgency ? `🏢 Agencia: ${o.clientAgency}` : `🏠 Dirección: ${o.clientAddress}`}\nGracias!`;
                window.open(`https://wa.me/51${o.clientPhone}?text=${encodeURIComponent(msg)}`, '_blank');
            },

            // --- CARGA INICIAL Y AUXILIARES ---
            activateTrial: async () => {
                app.toggleLoading(true); try { await ApiService.request("startTrial", { merchantId: state.user.uid }); state.user.plan = 'Pro (Prueba)'; SafeStorage.setItem('app_current_user', JSON.stringify(state.user)); app.closeModal('modal-upsell'); app.showToast('¡Prueba activada!'); app.loadData(); } catch(e){ app.showToast(e.message); } finally { app.toggleLoading(false); }
            },
            showUpgradeModal: () => { const el = document.getElementById('modal-upsell'), card = document.getElementById('modal-upsell-card'); el.classList.remove('hidden'); setTimeout(() => { el.classList.remove('opacity-0'); card.classList.remove('scale-95'); card.classList.add('scale-100'); }, 10); },
            loadExternalLists: async () => { if (!state.externalData.districts) { try { const res = await fetch(JSON_DISTRITOS); state.externalData.districts = (await res.json()).map(d => d.Distrito || d.nombre); } catch(e){} } },
            loadAgencies: async (cn) => {
                const url = AGENCY_URLS[cn]; if (!url) { state.externalData.agencies = []; return; }
                document.getElementById('c-agency').placeholder = "Cargando..."; document.getElementById('c-agency').disabled = true;
                try { const res = await fetch(url); state.externalData.agencies = (await res.json()).map(i => ({ Agencia: i.Agencia||i.nombre, Direccion: i.Direccion||i.direccion })); document.getElementById('c-agency').placeholder = "Buscar sede..."; document.getElementById('c-agency').disabled = false; app.clearAgency(); } catch(e){ state.externalData.agencies=[]; }
            },
            
            // Search / Export / Print (Simplificados para brevedad, lógica intacta)
            searchAgency: (q) => { const c = document.getElementById('agency-results'), x = document.getElementById('btn-clear-agency'); if (!q || q.length<2) { c.classList.add('hidden'); if(!q) x.classList.add('hidden'); return; } x.classList.remove('hidden'); const m = (state.externalData.agencies||[]).filter(a => (a.Agencia && a.Agencia.toLowerCase().includes(q.toLowerCase()))).slice(0,50); c.innerHTML = m.length ? m.map(a => `<div onclick="app.selectAgency('${escapeHtml(a.Agencia.replace(/'/g,"\\'"))}')" class="p-3 hover:bg-slate-50 border-b cursor-pointer"><div class="font-bold text-sm text-slate-800">${escapeHtml(a.Agencia)}</div><div class="text-xs text-slate-500">${escapeHtml(a.Direccion)}</div></div>`).join('') : ''; c.classList.remove('hidden'); },
            selectAgency: (v) => { document.getElementById('c-agency').value = v; document.getElementById('agency-results').classList.add('hidden'); },
            clearAgency: () => { document.getElementById('c-agency').value=''; document.getElementById('agency-results').classList.add('hidden'); },
            
            searchDistrict: (q) => { const c = document.getElementById('district-results'); if (!q || q.length<2) { c.classList.add('hidden'); return; } const m = (state.externalData.districts||[]).filter(d => d.toLowerCase().includes(q.toLowerCase())).slice(0,50); c.innerHTML = m.map(d => `<div onclick="app.selectDistrict('${escapeHtml(d)}')" class="p-3 hover:bg-slate-50 border-b cursor-pointer font-bold text-sm text-slate-800">${escapeHtml(d)}</div>`).join(''); c.classList.remove('hidden'); },
            selectDistrict: (v) => { document.getElementById('c-district').value = v; document.getElementById('district-results').classList.add('hidden'); },
            clearDistrict: () => { document.getElementById('c-district').value=''; document.getElementById('district-results').classList.add('hidden'); },

            generateDateOptions: () => { 
                const s = document.getElementById('c-date-select'); s.innerHTML = '<option value="" disabled selected>Elige fecha...</option>'; 
                const days = state.config.shippingDays || []; if (!days.length) return;
                const now = new Date(); const gap = parseInt(state.config.updateGap||0); const [ch, cm] = (state.config.updateTime||"18:00").split(':');
                const cut = new Date(); cut.setHours(ch, cm, 0); let start = gap; if (now > cut) start++;
                for(let i=start; i<start+14; i++) {
                    const f = new Date(); f.setDate(now.getDate()+i);
                    if(days.some(n => DAY_INDEX_MAP[n] === f.getDay())) {
                        const val = `${DAY_NAMES_FULL[f.getDay()]} ${f.getDate().toString().padStart(2,'0')}/${(f.getMonth()+1).toString().padStart(2,'0')}`;
                        const o = document.createElement('option'); o.value=val; o.innerText=val; s.appendChild(o);
                    }
                }
            },

            loadData: async () => { 
                app.toggleLoading(true); 
                state.config = { ...initialState };
                try { 
                    const res = await ApiService.request("getConfig", { merchantId: state.merchantId }); if(res.data) state.config = res.data;
                    if(state.user && !state.isClientView) {
                         const s = await ApiService.request("getUserStatus", { merchantId: state.merchantId });
                         if(s.plan && s.plan !== state.user.plan) { state.user.plan = s.plan; SafeStorage.setItem('app_current_user', JSON.stringify(state.user)); app.showToast('Plan sincronizado'); }
                    }
                } catch(e){ const l = SafeStorage.getItem(`config_${state.merchantId}`); if(l) state.config = JSON.parse(l); }
                
                document.querySelectorAll('.user-phone-display').forEach(el => el.innerText = state.user?.phone||'');
                document.querySelectorAll('.user-plan-display').forEach(el => el.innerText = `PLAN ${state.user?.plan?.toUpperCase()||'GRATIS'}`);
                
                if (state.isClientView) { app.renderClient(); app.setupClientAutoRefresh(); } 
                else { app.renderDashboard(); app.loadOrders(); }
                app.toggleLoading(false); 
            },
            
            renderDashboard: () => { 
                document.getElementById('inp-store-name').value = state.config.merchantName || ''; document.getElementById('inp-whatsapp').value = state.config.whatsapp || ''; document.getElementById('inp-time').value = state.config.updateTime || ''; document.getElementById('inp-gap').value = state.config.updateGap || '';
                document.getElementById('inp-store-name').oninput = (e) => app.updateConfigInput('merchantName', e.target.value);
                document.getElementById('container-couriers').innerHTML = ALL_COURIERS.map(c => `<div onclick="app.toggleConfigItem('couriers','${c}')" class="cursor-pointer bg-black/30 border border-white/10 rounded p-2 text-xs font-bold flex items-center gap-2 ${state.config.couriers.includes(c)?'border-primary text-primary bg-primary/10':'text-slate-400'}"><div class="w-3 h-3 border rounded flex items-center justify-center ${state.config.couriers.includes(c)?'bg-primary border-primary':'border-slate-500'}">${state.config.couriers.includes(c)?'<i data-lucide="check" class="w-2 h-2 text-white"></i>':''}</div>${c}</div>`).join(''); 
                document.getElementById('container-days').innerHTML = ALL_DAYS.map(d => `<button onclick="app.toggleConfigItem('shippingDays','${d}')" class="px-3 py-1 rounded text-xs font-bold border transition ${state.config.shippingDays.includes(d)?'bg-primary text-white border-primary':'bg-black/30 text-slate-400 border-white/10'}">${d}</button>`).join(''); 
                lucide.createIcons(); app.checkConfigStatus(); 
            },
            renderClient: () => { 
                document.getElementById('client-title').innerText = state.config.merchantName || "Tienda"; document.getElementById('client-time').innerText = state.config.updateTime || "--:--"; 
                const cs = document.getElementById('c-courier-select'); cs.innerHTML = '<option value="" disabled selected>Elige opción...</option>' + (state.config.couriers||[]).map(c => `<option value="${c}">${c}</option>`).join(''); 
                app.generateDateOptions(); app.loadExternalLists(); lucide.createIcons(); 
            },
            setupClientAutoRefresh: () => { if(!state.isClientView) return; let t; const r = () => { clearTimeout(t); t = setTimeout(() => window.location.reload(), 300000); }; ['click','scroll'].forEach(e => document.addEventListener(e, r)); r(); },

            setTab: (t) => {
                if (t === 'share' && !app.validateConfig().isValid) { app.showToast('⚠️ Completa la configuración primero'); app.setTab('config'); return; }
                ['config','share','orders'].forEach(x => { document.getElementById(`tab-${x}`).classList.add('hidden'); document.getElementById(`nav-${x}`).className = "nav-item p-3 rounded-lg text-sm font-bold text-left flex gap-3 items-center text-slate-400 hover:bg-white/5 hover:text-white transition whitespace-nowrap"; }); 
                document.getElementById(`tab-${t}`).classList.remove('hidden'); document.getElementById(`nav-${t}`).className = "nav-item p-3 rounded-lg text-sm font-bold bg-primary/10 text-primary border border-primary/20 text-left flex gap-3 items-center transition shadow-neon"; 
                if(t==='share') document.getElementById('share-link').innerText=`${window.location.origin}${window.location.pathname}?merchant=${state.user.uid}`; 
                if(t==='config') app.checkConfigStatus();
            },
            copyLink: () => { navigator.clipboard.writeText(document.getElementById('share-link').innerText); app.showToast('Enlace copiado'); },
            shareOnWhatsapp: () => { window.open(`https://wa.me/?text=${encodeURIComponent(document.getElementById('share-link').innerText + "\n*PROGRAMA TU ENVÍO AQUÍ*")}`, '_blank'); },
            openClientLink: () => { window.open(document.getElementById('share-link').innerText, '_blank'); },
            
            init: () => {
                const p = new URLSearchParams(window.location.search); const mid = p.get('merchant');
                document.querySelectorAll('[id^="view-"]').forEach(el => el.classList.add('hidden'));
                if (mid) { state.isClientView=true; state.merchantId=mid; document.getElementById('view-client').classList.remove('hidden'); app.loadData(); }
                else { const u = JSON.parse(SafeStorage.getItem('app_current_user')); if(u) { state.user=u; if(u.isAdmin) { document.getElementById('view-admin').classList.remove('hidden'); app.adminLoadUsers(); } else { state.merchantId=u.uid; document.getElementById('view-dashboard').classList.remove('hidden'); app.setTab('config'); app.loadData(); } } else { document.getElementById('view-auth').classList.remove('hidden'); } }
                lucide.createIcons();
            }
        };
        app.init();
    </script>
</body>
</html>
