<!DOCTYPE html>
<html lang="es">
<head>
    <link rel="icon" type="image/x-icon" href="favicon.ico" />
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Agenda tu env√≠o</title>
    <meta name="description" content="Agenda tu env√≠o de manera simple, r√°pida y segura.">
    <meta name="robots" content="noindex">
    <meta name="theme-color" content="#ffffff">

    <meta property="og:title" content="Agenda tu env√≠o">
    <meta property="og:image" content="https://raw.githubusercontent.com/complicidad/form/main/Spin.png">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand_accent: '#D96B4F',   
                        brand_accent_alt: '#FF8B6A', 
                        danger: '#d93025',
                        // Eliminamos variables conflictivas, usaremos valores directos o nativos
                    },
                    fontFamily: {
                        sans: ['Quicksand', 'sans-serif'],
                    },
                    animation: {
                        'shake': 'shake 0.5s cubic-bezier(.36,.07,.19,.97) both',
                        'fade-in': 'fadeIn 0.5s ease-out forwards',
                    },
                    keyframes: {
                        shake: { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } },
                        fadeIn: { from: { opacity: 0, transform: 'translateY(10px)' }, to: { opacity: 1, transform: 'translateY(0)' } }
                    }
                }
            }
        }
    </script>

    <style>
        body { font-family: "Quicksand", sans-serif; background-color: #ffffff; color: #2b2b2b; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        input, select { -webkit-appearance: none; appearance: none; }
        .input-transition { transition: all 0.2s ease-in-out; }
        
        /* Gradiente Latam5S Original */
        .logo-text-gradient {
            background: linear-gradient(to right, #3B82F6, #60A5FA, #2DD4BF, #10B981); 
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            color: transparent;
        }
    </style>
</head>
<body class="min-h-[100dvh] flex flex-col items-center selection:bg-brand_accent selection:text-white">

    <div id="loading-overlay" class="fixed inset-0 bg-white z-[9999] flex flex-col items-center justify-center transition-opacity duration-300">
        <div class="animate-spin rounded-full h-10 w-10 border-t-4 border-b-4 border-brand_accent"></div>
        <p class="mt-4 text-brand_accent font-bold text-xs uppercase tracking-widest animate-pulse">Cargando...</p>
    </div>

    <div id="toast" class="fixed top-5 right-5 z-[100] bg-slate-900 text-white px-6 py-4 rounded-xl shadow-2xl flex items-center gap-3 transition-all duration-300 -translate-y-20 opacity-0 border border-slate-800 max-w-sm">
        <div class="text-green-400">
            <i data-lucide="check-circle" class="w-6 h-6"></i>
        </div>
        <span id="toast-msg" class="font-bold text-sm leading-tight">Notificaci√≥n</span>
    </div>

    <main class="w-full max-w-xl px-6 py-8 md:py-12 relative animate-fade-in flex flex-col flex-1">
        
        <div class="text-center mb-8">
            <img src="https://raw.githubusercontent.com/complicidad/form/main/Spin.png" alt="Logo" class="h-auto max-w-[160px] mx-auto">
            <h1 id="client-title" class="hidden text-xl font-bold mt-4 text-gray-800">Cargando...</h1> 
        </div>

        <div id="view-client" class="relative flex-1 flex flex-col">
            
            <div class="mb-8 p-4 bg-orange-50 border border-orange-100 rounded-xl flex gap-3 items-start">
                <i data-lucide="clock" class="w-5 h-5 text-orange-400 mt-0.5 flex-shrink-0"></i>
                <div class="text-sm text-orange-800">
                    <span class="font-bold block mb-1">Hora de corte: <span id="client-time">--:--</span></span>
                    Registra tu pedido antes de esta hora para procesarlo hoy.
                </div>
            </div>
        
            <form id="client-form" onsubmit="app.submitOrder(event)" class="space-y-8 flex-1">
                
                <div id="block-identity" class="relative z-30">
                     <label class="block text-sm font-bold text-gray-700 mb-2 ml-1">WhatsApp con el que compraste <span class="text-danger">*</span></label>
                    <div class="relative">
                        <span class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 font-bold text-lg">+51</span>
                        <input id="c-phone" type="tel" maxlength="9" inputmode="numeric" placeholder="9XXXXXXXX" oninput="app.handleClientPhone(this)" required 
                            class="w-full bg-gray-50 border border-gray-200 rounded-xl py-4 pr-4 pl-14 text-gray-800 text-lg outline-none focus:border-brand_accent focus:bg-white focus:ring-4 focus:ring-brand_accent/10 input-transition placeholder-gray-400 font-medium shadow-sm">
                        <div id="user-found-badge" class="hidden absolute right-3 top-1/2 -translate-y-1/2 bg-green-100 text-green-700 text-[10px] font-bold px-3 py-1 rounded-full flex items-center gap-1 animate-fade-in">
                            <i data-lucide="sparkles" class="w-3 h-3"></i> ¬°Te conocemos!
                        </div>
                    </div>
                </div>
        
                <div id="progressive-content" class="space-y-8">
                    
                    <div id="block-service" class="hidden opacity-0 transition-all duration-500 transform translate-y-4">
                        <label class="block text-sm font-bold text-gray-700 mb-2 ml-1">Selecciona el tipo de servicio <span class="text-danger">*</span></label>
                        <div class="relative">
                            <select id="c-courier-select" onchange="app.onCourierChange(this.value)" class="w-full appearance-none bg-gray-50 border border-gray-200 rounded-xl py-4 pl-4 pr-10 text-gray-800 outline-none focus:border-brand_accent focus:bg-white focus:ring-4 focus:ring-brand_accent/10 cursor-pointer input-transition font-medium shadow-sm">
                                <option value="" disabled selected>Elige una opci√≥n...</option>
                            </select>
                            <div class="absolute inset-y-0 right-0 flex items-center px-4 pointer-events-none text-gray-400"><i data-lucide="chevron-down" class="w-5 h-5"></i></div>
                        </div>
                    </div>
        
                    <div id="dynamic-form-section" class="hidden space-y-6 transition-all duration-500">
                        <div id="fields-agency" class="hidden space-y-6 animate-fade-in">
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2 ml-1">Busca tu Agencia <span class="text-danger">*</span></label>
                                <div class="relative group z-30">
                                    <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 h-5 w-5 text-gray-400"></i>
                                    <input id="c-agency" type="text" onfocus="app.revealStep('block-personal')" onblur="app.validateAgencyOnBlur(this)" class="w-full bg-gray-50 border border-gray-200 text-gray-800 rounded-xl pl-12 pr-10 py-4 outline-none focus:border-brand_accent focus:bg-white focus:ring-4 focus:ring-brand_accent/10 input-transition placeholder-gray-400 font-medium shadow-sm" placeholder="Ej: Shalom Arequipa..." autocomplete="off" oninput="app.searchAgency(this.value)">
                                    <button type="button" id="btn-clear-agency" onclick="app.clearAgency()" class="hidden absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 p-1 hover:text-danger"><i data-lucide="x" class="h-5 w-5"></i></button>
                                    <div id="agency-results" class="hidden absolute left-0 right-0 top-full mt-2 bg-white border border-gray-200 rounded-xl shadow-xl max-h-60 overflow-y-auto z-50 divide-y divide-gray-100"></div>
                                </div>
                            </div>
                            <div>
                                 <label class="block text-sm font-bold text-gray-700 mb-2 ml-1">DNI para recoger <span class="text-danger">*</span></label>
                                <input id="c-dni" type="tel" maxlength="15" class="w-full bg-gray-50 border border-gray-200 text-gray-800 rounded-xl p-4 outline-none focus:border-brand_accent focus:bg-white focus:ring-4 focus:ring-brand_accent/10 input-transition placeholder-gray-400 font-medium shadow-sm" placeholder="N√∫mero de DNI / CE">
                            </div>
                        </div>

                        <div id="fields-home" class="hidden space-y-6 animate-fade-in">
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2 ml-1">Distrito <span class="text-danger">*</span></label>
                                <div class="relative group z-30">
                                    <i data-lucide="map-pin" class="absolute left-4 top-1/2 -translate-y-1/2 h-5 w-5 text-gray-400"></i>
                                    <input id="c-district" type="text" onfocus="app.revealStep('block-personal')" onblur="app.validateDistrictOnBlur(this)" class="w-full bg-gray-50 border border-gray-200 text-gray-800 rounded-xl pl-12 pr-10 py-4 outline-none focus:border-brand_accent focus:bg-white focus:ring-4 focus:ring-brand_accent/10 input-transition placeholder-gray-400 font-medium shadow-sm" placeholder="Buscar Distrito..." autocomplete="off" oninput="app.searchDistrict(this.value)">
                                    <button type="button" id="btn-clear-district" onclick="app.clearDistrict()" class="hidden absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 p-1 hover:text-danger"><i data-lucide="x" class="h-5 w-5"></i></button>
                                    <div id="district-results" class="hidden absolute left-0 right-0 top-full mt-2 bg-white border border-gray-200 rounded-xl shadow-xl max-h-60 overflow-y-auto z-50 divide-y divide-gray-100"></div>
                                </div>
                            </div>
                            <div>
                                 <label class="block text-sm font-bold text-gray-700 mb-2 ml-1">Direcci√≥n Exacta <span class="text-danger">*</span></label>
                                <input id="c-address" class="w-full bg-gray-50 border border-gray-200 text-gray-800 rounded-xl p-4 outline-none focus:border-brand_accent focus:bg-white focus:ring-4 focus:ring-brand_accent/10 input-transition placeholder-gray-400 font-medium shadow-sm" placeholder="Calle, Av, N√∫mero...">
                            </div>
                            <div>
                                 <label class="block text-sm font-bold text-gray-700 mb-2 ml-1">Referencia <span class="text-danger">*</span></label>
                                <input id="c-ref" class="w-full bg-gray-50 border border-gray-200 text-gray-800 rounded-xl p-4 outline-none focus:border-brand_accent focus:bg-white focus:ring-4 focus:ring-brand_accent/10 input-transition placeholder-gray-400 font-medium shadow-sm" placeholder="Color de casa, frente a...">
                            </div>
                        </div>
                    </div>
        
                    <div id="block-personal" class="hidden opacity-0 transition-all duration-500 transform translate-y-4">
                         <label class="block text-sm font-bold text-gray-700 mb-2 ml-1">¬øA nombre de qui√©n? <span class="text-danger">*</span></label>
                         <input id="c-name" oninput="app.revealStep('block-closing')" required class="w-full bg-gray-50 border border-gray-200 text-gray-800 rounded-xl p-4 outline-none focus:border-brand_accent focus:bg-white focus:ring-4 focus:ring-brand_accent/10 input-transition capitalize placeholder-gray-400 font-medium shadow-sm" placeholder="Nombre Completo">
                    </div>
        
                    <div id="block-closing" class="hidden opacity-0 transition-all duration-500 transform translate-y-4 space-y-8">
                         <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2 ml-1">¬øCu√°ndo lo enviamos? <span class="text-danger">*</span></label>
                            <div class="relative">
                                <select id="c-date-select" class="w-full appearance-none bg-gray-50 border border-gray-200 rounded-xl py-4 pl-4 pr-10 text-gray-800 outline-none focus:border-brand_accent focus:bg-white focus:ring-4 focus:ring-brand_accent/10 cursor-pointer input-transition font-medium shadow-sm">
                                    <option value="" disabled selected>Elige fecha...</option>
                                </select>
                                <div class="absolute inset-y-0 right-0 flex items-center px-4 pointer-events-none text-gray-400"><i data-lucide="calendar" class="w-5 h-5"></i></div>
                            </div>
                        </div>
                        
                        <button type="submit" id="btn-submit-order" class="w-full bg-[#25D366] hover:bg-[#20bd5a] text-white font-bold py-4 rounded-xl shadow-lg transition-all duration-200 transform active:scale-95 flex justify-center items-center gap-3 text-lg">
                            <i class="fab fa-whatsapp text-2xl"></i>
                            Confirmar y agendar env√≠o
                        </button>
                    </div>
                </div>
            </form>
        
            <div id="success-view" class="hidden flex flex-col items-center justify-center py-10 text-center animate-fade-in flex-1">
                <div class="mb-6"><svg class="w-20 h-20 text-brand_accent mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg></div>
                <h2 class="text-2xl font-bold text-gray-800 mb-2">¬°Datos registrados!</h2>
                <p class="text-gray-500 mb-8 max-w-xs mx-auto">Tu env√≠o se gener√≥ correctamente. Se abrir√° WhatsApp para finalizar.</p>
                <button onclick="window.location.reload()" class="mt-4 text-brand_accent hover:text-brand_accent_alt font-bold underline text-sm">Crear otro env√≠o</button>
            </div>

            <div class="mt-12 pt-6 border-t border-gray-100 pb-2">
                <a href="index" target="_blank" class="group block bg-gray-50 hover:bg-white border border-gray-200 rounded-xl p-4 transition-all duration-300 transform hover:-translate-y-1">
                    <div class="flex items-center justify-center gap-4">
                        <div class="w-12 h-12 rounded-full bg-gradient-to-br from-[#3B82F6] to-[#10B981] flex items-center justify-center font-bold text-2xl shadow-lg text-white transition-transform group-hover:scale-110">5S</div>
                        
                        <div class="text-left">
                            <p class="text-[10px] uppercase font-bold text-gray-400 tracking-wider mb-0.5">Powered by Latam5S</p>
                            <p class="text-sm font-bold text-gray-800 leading-tight">
                                ¬øVendes por WhatsApp? <br>
                                <span class="logo-text-gradient font-bold underline underline-offset-2">Crea tu formulario gratis</span>
                            </p>
                        </div>
                        <div class="text-gray-300 group-hover:text-[#3B82F6] transition-colors">
                            <i data-lucide="chevron-right" class="w-5 h-5"></i>
                        </div>
                    </div>
                </a>
            </div>
        
        </div>
    </main>

    <div id="error-view" class="hidden fixed inset-0 bg-white z-[9999] flex flex-col items-center justify-center p-8 text-center">
        <div class="w-16 h-16 bg-red-100 text-red-500 rounded-full flex items-center justify-center mb-4"><i data-lucide="alert-triangle" class="w-8 h-8"></i></div>
        <h1 class="text-xl font-bold text-gray-800 mb-2">Enlace no v√°lido</h1>
        <p class="text-gray-500 text-sm">No hemos podido identificar la tienda. Verifica el enlace.</p>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbyJlJR9Yb-ZjG0bXQYAEFv1J3ZofaWy59vIERIiLipt03XCSxTEMGI8VHtY3QZ60-NuKw/exec";
        
        const URLS = {
            districts: "lstDistritos.json",
            coverage: { "Dinsides": "lstDinsides.json" },
            agency: { "Shalom": "lstShalom.json", "Olva Courier": "lstOlvaCourier.json", "Marvisur": "lstMarvisur.json" }
        };

        const COURIER_TYPES = { "Shalom": "agency", "Olva Courier": "agency", "Marvisur": "agency", "Dinsides": "home", "Delivery": "home" };
        const DAY_NAMES_FULL = ["Domingo", "Lunes", "Martes", "Mi√©rcoles", "Jueves", "Viernes", "S√°bado"];
        const MONTH_NAMES = ["Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"];
        const DAY_INDEX_MAP = { "Dom": 0, "Lun": 1, "Mar": 2, "Mi√©": 3, "Jue": 4, "Vie": 5, "S√°b": 6 };

        const app = {
            init: async () => {
                const p = new URLSearchParams(window.location.search);
                state.merchantId = p.get('merchant');
                if (!state.merchantId) return app.showError();
                try {
                    const res = await fetch(`${API_URL}?action=getConfig&merchantId=${state.merchantId}`);
                    const json = await res.json();
                    if(json.data && json.data.merchantName) {
                        state.config = json.data;
                        app.renderClient();
                        document.getElementById('loading-overlay').classList.add('hidden');
                    } else { app.showError(); }
                } catch(e) { app.showError(); }
            },
            
            showError: () => {
                document.getElementById('loading-overlay').classList.add('hidden');
                document.getElementById('view-client').parentElement.classList.add('hidden');
                document.getElementById('error-view').classList.remove('hidden');
                lucide.createIcons();
            },

            normalizeText: (text) => text.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase(),

            renderClient: () => {
                document.title = `Env√≠o - ${state.config.merchantName}`;
                document.getElementById('client-title').innerText = state.config.merchantName || "Agenda tu env√≠o";
                document.getElementById('client-title').classList.remove('hidden');
                document.getElementById('client-time').innerText = state.config.updateTime || "--:--"; 
                
                const cl = state.config.couriers || []; 
                const cs = document.getElementById('c-courier-select'); 
                cs.innerHTML = '<option value="" disabled selected>Elige una opci√≥n...</option>';
                
                let homeCourierDefinitivo = null;
                if (cl.includes("Dinsides")) homeCourierDefinitivo = "Dinsides";
                else homeCourierDefinitivo = cl.find(c => (COURIER_TYPES[c] || "home") === "home");
                state.primaryHomeCourier = homeCourierDefinitivo;

                let homeOptionAdded = false;
                cl.forEach(c => {
                    const type = COURIER_TYPES[c] || "home";
                    if (type === 'agency') {
                        const opt = document.createElement('option');
                        opt.value = c; opt.innerText = "Retiro en agencia " + c; 
                        cs.appendChild(opt);
                    } else {
                        if (!homeOptionAdded) {
                            const opt = document.createElement('option');
                            opt.value = "GENERIC_HOME"; 
                            opt.innerText = "Env√≠o a domicilio / trabajo"; 
                            cs.appendChild(opt);
                            homeOptionAdded = true;
                        }
                    }
                });
                
                app.generateDateOptions(); app.loadExternalLists(); lucide.createIcons();
                document.getElementById('c-phone').focus();
            },

            handleClientPhone: (el) => {
                let val = el.value.replace(/\D/g, '');
                if (val.length > 0 && val.charAt(0) !== '9') val = val.substring(1);
                el.value = val;
                const badge = document.getElementById('user-found-badge');
                if (val.length === 9) {
                    const cache = JSON.parse(localStorage.getItem('latam5s_client_cache') || '{}');
                    if (cache[val]) {
                        badge.classList.remove('hidden');
                        app.fillFromCache(cache[val]); 
                        app.showToast('¬°Hola de nuevo! Cargamos tus datos ‚ú®');
                        ['block-service', 'dynamic-form-section', 'block-personal', 'block-closing'].forEach((id, idx) => setTimeout(() => app.revealStep(id), idx * 100));
                    } else {
                        badge.classList.add('hidden');
                        app.revealStep('block-service');
                    }
                }
            },

            fillFromCache: (data) => {
                if(data.name) document.getElementById('c-name').value = data.name;
                if(data.courier) {
                    const select = document.getElementById('c-courier-select');
                    const type = COURIER_TYPES[data.courier] || "home";
                    if (type === 'agency') {
                        if ([...select.options].some(o => o.value === data.courier)) { select.value = data.courier; app.onCourierChange(data.courier); }
                    } else { select.value = "GENERIC_HOME"; app.onCourierChange("GENERIC_HOME"); }
                }
                setTimeout(() => {
                    document.getElementById('c-date-select').value = ""; 
                    if(data.type === 'agency') {
                        if(data.dni) document.getElementById('c-dni').value = data.dni;
                        if(data.agency) {
                             document.getElementById('c-agency').value = data.agency; 
                             document.getElementById('btn-clear-agency').classList.remove('hidden');
                        }
                    } else {
                        if(data.district) { document.getElementById('c-district').value = data.district; document.getElementById('btn-clear-district').classList.remove('hidden'); }
                        if(data.address) document.getElementById('c-address').value = data.address;
                        if(data.ref) document.getElementById('c-ref').value = data.ref;
                    }
                }, 100);
            },

            revealStep: (id) => {
                const el = document.getElementById(id);
                if (el && el.classList.contains('hidden')) {
                    el.classList.remove('hidden');
                    setTimeout(() => el.classList.remove('opacity-0', 'translate-y-4'), 50);
                    if(id === 'block-service' || id === 'block-closing') el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            },

            onCourierChange: (val) => { 
                let realCourier = val === "GENERIC_HOME" ? state.primaryHomeCourier : val;
                state.selectedCourier = realCourier;
                state.selectedCourierType = COURIER_TYPES[realCourier] || "home"; 
                document.getElementById('dynamic-form-section').classList.remove('hidden'); 
                const af = document.getElementById('fields-agency'), hf = document.getElementById('fields-home'); 
                ['c-dni','c-agency','c-address','c-district'].forEach(id => document.getElementById(id).removeAttribute('required'));
                if (state.selectedCourierType === 'agency') { 
                    af.classList.remove('hidden'); hf.classList.add('hidden'); 
                    document.getElementById('c-dni').setAttribute('required','true'); 
                    document.getElementById('c-agency').setAttribute('required','true'); document.getElementById('c-agency').value = ""; 
                    app.loadAgencies(realCourier); app.clearDistrict(); 
                } else { 
                    af.classList.add('hidden'); hf.classList.remove('hidden'); 
                    document.getElementById('c-address').setAttribute('required','true'); document.getElementById('c-district').setAttribute('required','true'); 
                    app.clearAgency(); app.clearDistrict(); app.loadExternalLists(realCourier);
                } 
            },

            loadExternalLists: async (courierName) => { 
                let url = (courierName && URLS.coverage && URLS.coverage[courierName]) ? URLS.coverage[courierName] : URLS.districts;
                const input = document.getElementById('c-district');
                if(input) { input.placeholder = "Cargando distritos..."; input.disabled = true; input.value = ""; }
                state.externalData.districts = []; 
                try { 
                    const res = await fetch(url); const data = await res.json(); 
                    state.externalData.districts = data.map(d => d.Distrito || d.nombre || d); 
                } catch(e) { console.error(e); } finally { if(input) { input.placeholder = "Buscar Distrito..."; input.disabled = false; } }
            },
            
            loadAgencies: async (courierName) => {
                const url = URLS.agency[courierName];
                if (!url) { state.externalData.agencies = []; return; }
                const input = document.getElementById('c-agency');
                input.placeholder = `Cargando sedes ${courierName}...`; input.disabled = true;
                try {
                    const res = await fetch(url); const rawData = await res.json();
                    state.externalData.agencies = rawData.map(item => ({ Agencia: item.Agencia || item.c_nom_agencia || 'Agencia', Direccion: item.Direccion || item.c_direccion || '' }));
                    input.placeholder = `Buscar sede ${courierName}...`; input.disabled = false;
                } catch (e) { input.placeholder = "Error cargando agencias"; }
            },

            searchAgency: (q) => { 
                const c = document.getElementById('agency-results'), x = document.getElementById('btn-clear-agency'); 
                if (!q) { c.classList.add('hidden'); x.classList.add('hidden'); return; } 
                x.classList.remove('hidden'); 
                if(q.length<2) { c.classList.add('hidden'); return; } 
                if (c.classList.contains('hidden')) { c.classList.remove('hidden'); setTimeout(() => document.getElementById('c-agency').scrollIntoView({ behavior: 'smooth', block: 'start' }), 100); }
                const cleanQ = app.normalizeText(q);
                const m = (state.externalData.agencies||[]).filter(a => (a.Agencia && app.normalizeText(a.Agencia).includes(cleanQ)) || (a.Direccion && app.normalizeText(a.Direccion).includes(cleanQ))).slice(0,50); 
                c.innerHTML = m.length ? m.map(a => `<div onclick="app.selectAgency('${a.Agencia.replace(/'/g,"\\'")}','${a.Direccion.replace(/'/g,"\\'").replace(/\n/g," ")}')" class="p-3 cursor-pointer hover:bg-gray-50 border-b border-gray-100 last:border-0"><p class="font-bold text-brand_text text-sm mb-0.5">${a.Agencia}</p><p class="text-xs text-gray-500">${a.Direccion}</p></div>`).join('') : '<div class="p-3 text-gray-400 text-sm text-center">Sin resultados</div>'; 
            },
            
            selectAgency: (n, a) => { 
                document.getElementById('c-agency').value = `${n} | ${a}`; 
                document.getElementById('agency-results').classList.add('hidden'); 
                document.getElementById('btn-clear-agency').classList.remove('hidden'); 
                document.getElementById('c-agency').classList.remove('border-red-500', 'bg-red-50');
            },
            
            clearAgency: () => { const i = document.getElementById('c-agency'); i.value=''; document.getElementById('agency-results').classList.add('hidden'); document.getElementById('btn-clear-agency').classList.add('hidden'); i.focus(); },

            validateAgencyOnBlur: (el) => {
                setTimeout(() => {
                    const val = el.value.trim();
                    if (!val) return;
                    const loadedAgencies = state.externalData.agencies || [];
                    const isValid = loadedAgencies.some(item => `${item.Agencia} | ${item.Direccion}` === val);
                    if (!isValid) { el.value = ""; app.showToast("‚ö†Ô∏è Selecciona una opci√≥n del listado"); document.getElementById('agency-results').classList.add('hidden'); }
                }, 200);
            },

            searchDistrict: (q) => { 
                const c = document.getElementById('district-results'), x = document.getElementById('btn-clear-district'); 
                if (!q) { c.classList.add('hidden'); x.classList.add('hidden'); return; } 
                x.classList.remove('hidden'); 
                if(q.length<1) { c.classList.add('hidden'); return; } 
                if (c.classList.contains('hidden')) { c.classList.remove('hidden'); setTimeout(() => document.getElementById('c-district').scrollIntoView({ behavior: 'smooth', block: 'start' }), 100); }
                const cleanQ = app.normalizeText(q);
                const m = (state.externalData.districts||[]).filter(d => app.normalizeText(d).includes(cleanQ)).slice(0,50); 
                c.innerHTML = m.length ? m.map(d => `<div onclick="app.selectDistrict('${d.replace(/'/g,"\\'")}')" class="p-3 cursor-pointer hover:bg-gray-50 border-b border-gray-100 last:border-0"><p class="font-bold text-brand_text text-sm">${d}</p></div>`).join('') : '<div class="p-3 text-gray-400 text-sm text-center">Sin resultados</div>'; 
            },
            selectDistrict: (v) => { document.getElementById('c-district').value = v; document.getElementById('district-results').classList.add('hidden'); document.getElementById('btn-clear-district').classList.remove('hidden'); },
            clearDistrict: () => { const i = document.getElementById('c-district'); i.value=''; document.getElementById('district-results').classList.add('hidden'); document.getElementById('btn-clear-district').classList.add('hidden'); i.focus(); },

            validateDistrictOnBlur: (el) => {
                setTimeout(() => {
                    const val = el.value.trim();
                    if (!val) return;
                    const validDistricts = state.externalData.districts || [];
                    if (!validDistricts.includes(val)) { el.value = ""; app.showToast("‚ö†Ô∏è Elige un distrito de la lista"); document.getElementById('district-results').classList.add('hidden'); }
                }, 200);
            },

            generateDateOptions: () => { 
                const s = document.getElementById('c-date-select'); 
                s.innerHTML = '<option value="" disabled selected>Elige una fecha...</option>'; 
                const allowedDays = state.config.shippingDays || []; if (!allowedDays.length) return; 
                const now = new Date(); const gap = parseInt(state.config.updateGap || 0);
                const [cutHour, cutMinute] = (state.config.updateTime || "18:00").split(':').map(Number); 
                const cutTime = new Date(now); cutTime.setHours(cutHour, cutMinute, 0, 0); 
                let startOffset = gap; if (now > cutTime) startOffset = gap + 1;
                for(let i = startOffset; i < (startOffset + 14); i++) { 
                    const f = new Date(now); f.setDate(now.getDate() + i); const dayIndex = f.getDay(); 
                    if(allowedDays.some(n => DAY_INDEX_MAP[n] === dayIndex)) { 
                        let prefix = ""; if (i === 0) prefix = "¬°HOY! - "; else if (i === 1) prefix = "Ma√±ana - ";
                        const lbl = `${prefix}${DAY_NAMES_FULL[dayIndex]} ${f.getDate()} ${MONTH_NAMES[f.getMonth()]}`; 
                        const val = `${DAY_NAMES_FULL[dayIndex]} ${f.getDate().toString().padStart(2,'0')}/${(f.getMonth()+1).toString().padStart(2,'0')}`; 
                        const o = document.createElement('option'); o.value = val; o.innerText = lbl; s.appendChild(o); 
                    } 
                } 
            },

            submitOrder: async (e) => { 
                e.preventDefault(); 
                if (!state.selectedCourier) { app.showToast("‚ö†Ô∏è Selecciona un tipo de env√≠o"); app.revealStep('block-service'); document.getElementById('c-courier-select').focus(); return; }
                const dateSelect = document.getElementById('c-date-select');
                if (!dateSelect.value) { app.showToast("üìÖ Selecciona la fecha de env√≠o"); app.revealStep('block-closing'); dateSelect.focus(); return; }
                const phone = document.getElementById('c-phone').value.trim();
                const name = document.getElementById('c-name').value.trim();
                const day = dateSelect.value; 
                if (name.length < 3) return app.showToast("‚ö†Ô∏è Ingresa un nombre v√°lido");
                if (!/^9\d{8}$/.test(phone)) return app.showToast("‚ö†Ô∏è Celular inv√°lido");

                if (state.selectedCourierType === 'agency') {
                    const inputAgency = document.getElementById('c-agency');
                    const loadedAgencies = state.externalData.agencies || [];
                    const isValid = loadedAgencies.some(item => `${item.Agencia} | ${item.Direccion}` === inputAgency.value.trim());
                    if (!isValid) { inputAgency.focus(); inputAgency.classList.add('animate-shake', 'border-red-500', 'bg-red-50'); setTimeout(() => inputAgency.classList.remove('animate-shake', 'border-red-500', 'bg-red-50'), 1000); return app.showToast("‚ö†Ô∏è Selecciona una agencia de la lista"); }
                } else {
                    const inputDist = document.getElementById('c-district');
                    const validDistricts = state.externalData.districts || [];
                    if (!validDistricts.includes(inputDist.value.trim())) { inputDist.focus(); inputDist.classList.add('animate-shake', 'border-red-500', 'bg-red-50'); setTimeout(() => inputDist.classList.remove('animate-shake', 'border-red-500', 'bg-red-50'), 1000); return app.showToast("‚ö†Ô∏è Selecciona un distrito de la lista"); }
                }

                let data = { clientName: name, clientPhone: phone, courier: state.selectedCourier, shippingDate: day, createdAt: Date.now(), product: "N/A" }; 
                const cacheData = { name: name, courier: state.selectedCourier, type: state.selectedCourierType };
                let wa = ""; 

                if (state.selectedCourierType === 'agency') { 
                    data.clientDni = document.getElementById('c-dni').value.trim(); 
                    data.clientAgency = document.getElementById('c-agency').value.trim(); 
                    cacheData.dni = data.clientDni; cacheData.agency = data.clientAgency;
                    wa = `üì¶ *NUEVO ENV√çO (AGENCIA)*\n\nüë§ ${name}\nüì± ${phone}\nüÜî DNI: ${data.clientDni}\nüè¢ Agencia: ${data.clientAgency.replace(' | ', '\nüìç ')}\n\nüöö ${state.selectedCourier}\nüìÖ ${day}`;
                } else { 
                    data.clientAddress = document.getElementById('c-address').value.trim(); 
                    data.clientDistrict = document.getElementById('c-district').value.trim(); 
                    data.clientRef = document.getElementById('c-ref').value.trim(); 
                    cacheData.district = data.clientDistrict; cacheData.address = data.clientAddress; cacheData.ref = data.clientRef;
                    wa = `üì¶ *NUEVO ENV√çO (DELIVERY)*\n\nüë§ ${name}\nüì± ${phone}\nüìç ${data.clientDistrict}\nüè† ${data.clientAddress}\nüó∫Ô∏è Ref: ${data.clientRef}\n\nüöö ${state.selectedCourier}\nüìÖ ${day}`;
                }

                const cache = JSON.parse(localStorage.getItem('latam5s_client_cache') || '{}'); cache[phone] = cacheData; localStorage.setItem('latam5s_client_cache', JSON.stringify(cache));

                setTimeout(() => {
                    window.open(`https://wa.me/51${state.config.whatsapp}?text=${encodeURIComponent(wa)}`, '_blank');
                    try { fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "saveOrder", merchantId: state.merchantId, data: data }) }); } catch(e) {} 
                    document.getElementById('client-form').classList.add('hidden');
                    document.getElementById('view-client').classList.add('hidden'); 
                    document.getElementById('client-title').classList.add('hidden'); 
                    document.getElementById('success-view').classList.remove('hidden');
                }, 500);
            },

            showToast: (msg) => {
                const el = document.getElementById('toast'); document.getElementById('toast-msg').innerText = msg;
                el.classList.remove('opacity-0', '-translate-y-20'); setTimeout(() => el.classList.add('opacity-0', '-translate-y-20'), 3000);
            }
        };

        const state = { merchantId: null, config: {}, selectedCourierType: null, selectedCourier: null, externalData: { districts: null, agencies: [] } };
        app.init();
    </script>
</body>
</html>
